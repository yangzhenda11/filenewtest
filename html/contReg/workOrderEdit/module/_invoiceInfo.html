<div class="form-fieldset">
	<div class="form-fieldset-title">
		<span><i class="iconfont icon-layers"></i> 开票信息</span>
		<div class="form-fieldset-tools">
			<a href="#" class="form-collapse"><i class="fa fa-angle-up"></i></a>
		</div>
	</div>
	<div class="form-fieldset-body">
		<div class="row" id="invoiceInfoContent">
			<div class="portlet-body">
				<div class="tableToobarContent hidden" id="invoiceInfoToolbar">
					<button class="btn red" type="button" onclick="addInvoiceTr()"><i class="iconfont icon-add"></i> 新增</button>
					<button class="btn red" type="button" onclick="delectsInvoiceTr()"><i class="iconfont icon-shanchu"></i> 删除</button>
				</div>
				<table class="table table-hover table-bordered table-striped table-align">
					<thead>
						<tr>
							<th class="invoiceTableEdit"><label class='ui-checkbox'><input type='checkbox' name='invocieCheckAll' id="invocieCheckAll"><span></span></label></th>
							<th>序号</th>
							<th><i class="iconfont icon-mi required"></i>发票抬头</th>
							<th><i class="iconfont icon-mi required"></i>开票类型</th>
							<th class="invoiceTableEdit">操作</th>
						</tr>
					</thead>
					<tbody id="invoiceTbody">
						<tr class="emptyTr">
							<td colspan="5">暂无开票信息</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	/*
	 * 设置页面的id值，由保存和提交后回调
	 */
	function setPageId_invoiceListId(value){
		var valueKey = 0;
		$.each($("#invoiceTbody tr"), function(k,v) {
			if(!$(v).hasClass("emptyTr")){
				if($(v).data("id") != undefined){
					$(v).data("id",value[valueKey]);
					valueKey++;
				}
			}
		});
	}
	/*
	 * 返回本页面数据，若无返回{}，若不提交本页面的值可删除此方法
	 * isSubmit 提交时为true,判断页面是否要加逻辑上的验证(bootstrap-validator验证除外)
	 */
	function getValue_invoiceList(isSubmit){
		var invoiceDataList = [];
		$.each($("#invoiceTbody tr"),function(k,v){
			if(!$(v).hasClass("emptyTr")){
				var invoiceDataItem = {};
				invoiceDataItem.wcardId = wcardId;
				invoiceDataItem.contractNumber = contractNumber;
				invoiceDataItem.invoiceId = $(v).data("id");
				invoiceDataItem.invoiceTitle = $(v).find(".invoiceTitleName").val();
				invoiceDataItem.invoiceType = $(v).find(".invoiceTypeName").val();
				invoiceDataList.push(invoiceDataItem);
			}
		});
		//当合同总览中"固定金额"为"是"时，加校验"至少有一条开票信息";
		var isFixedValue = $("input[name='isFixed']:checked").val();
		if(isSubmit && isFixedValue == 1){
			if(invoiceDataList.length > 0){
				return invoiceDataList;
			}else{
				layer.msg("请至少填写一项开票信息");
				srolloOffect("#invoiceInfoContent");
				return false;
			}
		}else{
			return invoiceDataList;
		}
	}
	/*
	 * 去除多于的行
	 */
	function removeMorethan_invoiceList(){
		var tableValue = getValue_invoiceList();
		var emptyList = [];
		for(var i = 0; i < tableValue.length; i++){
			var tableItem = tableValue[i];
			var isEmpty = true;
			delete tableItem.contractNumber;
			delete tableItem.invoiceId;
			delete tableItem.wcardId;
			$.each(tableItem, function(k,v) {
				if(v){
					isEmpty = false;
					return false;
				}
			});
			if(isEmpty){
				emptyList.push(i);
			}
		};
		$.each(emptyList, function(m,n) {
			var index = n - m;
			$("#invoiceTbody tr").eq(index).remove();
		});
		addInvoiceTbodyEmptyTr();
	}
	//name自增基础值
	var isCreateInvoiceTrLength = 0;
	//获取开票信息字典值
	var invoiceType = new Object();
	getInvoiceDict();
	//获取开票信息
	getInvoiceInfo();
	
	/*
	 * 获取开票信息字典值
	 * 开票类型   invoiceType
	 */
	function getInvoiceDict() {
		invoiceType = App.getDictInfo(9025);
	}
	
	/*
	 * 获取开票信息
	 */
	function getInvoiceInfo() {
		var url = serverPath + "contractOrderEditorController/getInvoiceId";
		var postData = JSON.stringify({wcardId:wcardId});
		App.formAjaxJson(url, "post", postData, successCallback);

		function successCallback(result) {
			var data = result.data;
			if(data.length > 0){
				if($("#invoiceTbody .emptyTr")[0] != undefined){
					$("#invoiceTbody .emptyTr").remove();
				};
				isCreateInvoiceTrLength = data.length;
				var selectHtml = "<option value=''>请选择</option>";
				$.each(invoiceType, function(k,v) {
					selectHtml += "<option value='"+ k +"'>"+ v +"</option>";
				});
				for(var i = 0; i < data.length; i++){
					var invoiceTitleName = "invoiceTitle"+i;
					var invoiceTypeName = "invoiceType"+i;
					var appendHtml = "<tr data-id='"+ data[i].invoiceId +"'>"+
										"<td class='invoiceTableEdit'><label class='ui-checkbox'><input type='checkbox' name='invoiceCheck'><span></span></label></td>"+
										"<td class='orderNumber'></td>"+
										"<td><div class='form-group'><input type='text' class='form-control invoiceTitleName' name='"+ invoiceTitleName +"' placeholder='请输入发票抬头' value='"+ data[i].invoiceTitle +"' maxlength='100' /></div></td>"+
										"<td><div class='form-group "+ invoiceTypeName +"'><select class='form-control select2me invoiceTypeName' data-placeholder='请选择发票类型' name='"+ invoiceTypeName +"' >"+ selectHtml +"</select></div></td>"+
										"<td class='invoiceTableEdit'><button type='button' class='btn primary btn-outline btn-xs' onclick='delectInvoiceTr(this)'>删除</button></td>"+
									"</tr>";
					$("#invoiceTbody").append(appendHtml);
					App.initFormSelect2("."+invoiceTypeName);
					$("select[name='"+invoiceTypeName+"']").val(data[i].invoiceType).trigger("change");
					addNotEmptyValidatorField(invoiceTitleName,"发票抬头不能为空");
					addNotEmptyValidatorField(invoiceTypeName,"发票类型不能为空");
					addInvoiceTableSort();
					App.checkAllFn("#invocieCheckAll","invoiceCheck");
				};
			};
			/*
			 * isEdit 判断页面是否只能查看
			 */
			if(!isEdit){
				$("#invoiceInfoContent").find("input,select").attr("disabled","disabled");
				$("#invoiceInfoToolbar,.invoiceTableEdit").remove();
			}else{
				$("#invoiceInfoToolbar").removeClass("hidden");
			};
		}
	}
	/*
	 * 新增点击
	 */
	function addInvoiceTr(){
		if($("#invoiceTbody .emptyTr")[0] != undefined){
			$("#invoiceTbody .emptyTr").remove();
		}
		isCreateInvoiceTrLength++;
		var invoiceTitleName = "invoiceTitle" + isCreateInvoiceTrLength;
		var invoiceTypeName = "invoiceType" + isCreateInvoiceTrLength;
		var selectHtml = "<option value=''>请选择</option>";
		$.each(invoiceType, function(k,v) {
			selectHtml += "<option value='"+ k +"'>"+ v +"</option>";
		});
		var appendHtml = "<tr data-id='100000'>"+
							"<td><label class='ui-checkbox'><input type='checkbox' name='invoiceCheck'><span></span></label></td>"+
							"<td class='orderNumber'></td>"+
							"<td><div class='form-group'><input type='text' class='form-control invoiceTitleName' name='"+ invoiceTitleName +"' placeholder='请输入发票抬头' maxlength='100' /></div></td>"+
							"<td><div class='form-group "+ invoiceTypeName +"'><select class='form-control select2me invoiceTypeName' data-placeholder='请选择发票类型' name='"+ invoiceTypeName +"'>"+ selectHtml +"</select></div></td>"+
							"<td><button type='button' class='btn primary btn-outline btn-xs' onclick='delectInvoiceTr(this)'>删除</button></td>"+
						"</tr>";
		$("#invoiceTbody").append(appendHtml);
		App.initFormSelect2("."+invoiceTypeName);
		addNotEmptyValidatorField(invoiceTitleName,"发票抬头不能为空");
		addNotEmptyValidatorField(invoiceTypeName,"发票类型不能为空");
		addInvoiceTableSort();
		App.checkAllFn("#invocieCheckAll","invoiceCheck");
	}
	/*
	 * 批量删除表格数据
	 */
	function delectsInvoiceTr(){
		var checkInvoiceLength = $("#invoiceTbody input[name='invoiceCheck']:checked").length;
		if(checkInvoiceLength == 0){
			layer.msg("请勾选要删除的开票信息");
		}else{
			layer.confirm("是否要删除这"+checkInvoiceLength+"条数据？",{icon:7,title:"提示"},function(index){
				layer.close(index);
				$.each($("#invoiceTbody input[name='invoiceCheck']:checked"), function(k,v) {
					$(v).parents("tr").remove();
				});
				addInvoiceTableSort();
				App.checkAllFn("#invocieCheckAll","invoiceCheck");
				addInvoiceTbodyEmptyTr();
			})
		}
	}
	/*
	 * 删除表格数据
	 */
	function delectInvoiceTr(dom){
		layer.confirm("是否要删除此条数据？",{icon:7,title:"提示"},function(index){
			layer.close(index);
			$(dom).parents("tr").remove();
			addInvoiceTableSort();
			App.checkAllFn("#invocieCheckAll","invoiceCheck");
			addInvoiceTbodyEmptyTr();
		})
	}
	/*
	 * 表格数据增加序号
	 */
	function addInvoiceTableSort(){
		$.each($("#invoiceTbody .orderNumber"), function(k,v) {
			$(v).text(k+1);
		});
	}
	/*
	 * 若为空增加empty值
	 */
	function addInvoiceTbodyEmptyTr(){
		if($("#invoiceTbody tr").length == 0){
			var html = '<tr class="emptyTr"><td colspan="5">暂无开票信息</td></tr>';
			$("#invoiceTbody").html(html);
		}
	}
</script>
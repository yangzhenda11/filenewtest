function loadTaskPath(t,a,e,o,r){$.post(t+"workflowrest/taskhasdonepath/"+a+"/"+o+"/"+e,function(a){var e=a.retCode;if(1==e){var n=a.dataRows[0].url;$("#paramForDone").val(a.dataRows[0].param);var s=a.dataRows[0].startLink,d=a.dataRows[0].endLink;$("#startLinkForDone").val(s),$("#endLinkForDone").val(d),$("#businessForDoneiframe").attr("src",n),$("#businessForDone").show()}else 0==e&&alert(a.retVal);loadCustomTabs(t,$("#paramForDone").val(),r,o)})}function loadCustomTabs(t,a,e,o){$.get(t+"workflowrest/taburls/"+e+"/"+o+"/"+!1,function(t){var e=t.retCode;if(1==e)for(var o=0;o<t.dataRows.length;o++){var r=t.dataRows[o].name,n=t.dataRows[o].url+"?"+a,s="custom_tab"+(o+1),d="custom_div"+(o+1),i='<div role="tabpanel" class="tab-pane fade" id=\''+d+"ForDone'></div>",l="<li id='"+s+"ForDone' role='presentation'></li>",c="<a href='#"+d+"' aria-controls='"+d+'\' role="tab" data-toggle="tab">'+r+"</a>";$("#historyForDone").before(i),$("#"+d+"ForDone").load(n),$("#historyLiForDone").before(l),$("#"+s+"ForDone").append(c)}})}function loadHistoicFlow(t,a){$.post(t+"workflowrest/histoicflow/"+a,function(t){var a=t.retCode;if(1==a){for(var e="",o=0;o<t.dataRows.length;o++){var r=t.dataRows[o].startTime;r=getSmpFormatDateByLong(r,!0);var n=t.dataRows[o].endTime;n=null==n?"":getSmpFormatDateByLong(n,!0);var s=o+1,d=t.dataRows[o].assigneeName,i=t.dataRows[o].fromUserName;1==t.dataRows[o].replace&&(d=d+"（ "+i+"——待办授权）"),e+="<tr><td>"+s+"</td><td>"+t.dataRows[o].linkName+"</td><td>"+d+"</td><td>"+t.dataRows[o].orgName+"</td><td>"+t.dataRows[o].handleType+"</td><td>"+r+"</td><td>"+n+'</td><td style="word-wrap:break-word;word-break:break-all;">'+t.dataRows[o].userComment+"</td></tr>"}$("#historyContentForDone").html(e),"null"!=t.dataRows[0].preProcessInstanceId&&null!=t.dataRows[0].preProcessInstanceId&&""!=t.dataRows[0].preProcessInstanceId&&($("#preProcessInstanceIdForDone").val(t.dataRows[0].preProcessInstanceId),$("#subTitleForDone").val(t.dataRows[0].orgName),getPreHistoryContent())}else 0==a&&alert(t.retVal)})}function returnProcess(){layer.confirm("【撤回】确认后，当前流程将撤回本环节，是否确认？",{icon:7,title:"提示"},function(t){layer.close(t),document.getElementById("businessForDoneiframe").contentWindow.modal_return(serverPath,$("#processInstanceIdForDone").val(),$("#taskIdForDone").val())})}function modal_close(){"3"==pageType?window.close():returnListForDone()}function returnListForDone(){if("3"==pageType){var t=navigator.userAgent;-1!=t.indexOf("Firefox")||-1!=t.indexOf("Presto")?window.location.replace("about:blank"):(window.opener=null,window.open("","_self"),window.close())}else serarchForDone(),$("#goTaskToDoDetailForDone").hide(),$("#businessForDone").show(),$("#searchContentForDone").show()}function initData(){$.ajax({url:serverPath+"workflowrest/taskHasDoneDetail",type:"POST",data:$("#taskHasDoneDetail").serializeArray(),async:!1,success:function(t){$("#canWithDrawForDone").val(t.canWithDraw)},error:function(t){alert("获取数据异常"+t),App.ajaxErrorCallback(t)}})}function getPreHistoryContent(){var t=$("#preProcessInstanceIdForDone").val();t&&($("#subspanForDone").html($("#subTitleForDone").val()),$.get(serverPath+"workflowrest/histoicflow/"+t,function(a){var e=a.retCode;if(1==e){for(var o="",r=0;r<a.dataRows.length;r++){var n=a.dataRows[r].startTime;n=getSmpFormatDateByLong(n,!0);var s=a.dataRows[r].endTime;s=null==s?"":getSmpFormatDateByLong(s,!0);var d=r+1,i=a.dataRows[r].assigneeName,l=a.dataRows[r].fromUserName;1==a.dataRows[r].replace&&(i=i+"（ "+l+"——待办授权）"),o+="<tr><td>"+d+"</td><td>"+a.dataRows[r].linkName+"</td><td>"+i+"</td><td>"+a.dataRows[r].orgName+"</td><td>"+a.dataRows[r].handleType+"</td><td>"+n+"</td><td>"+s+'</td><td style="word-wrap:break-word;word-break:break-all;">'+a.dataRows[r].userComment+"</td></tr>"}$("#preHistoryContentForDone").html(o),$("#zlc_diagramImgForDone").attr("src",serverPath+"workflowrest/flowchart/"+t+"/"+parseInt(10*Math.random())),$("#preDivForDone").css({display:"inline"})}else 0==e&&alert(a.retValue)}))}function openImagesForDone(t){var a=document.getElementById(t),e=$(a);e=e.find(".active"),e=e.find("a");var o=e.attr("id").split("_");$("#z_diagramImgForDone").attr("src",serverPath+"workflowrest/flowchart/"+o[1]+"/"+parseInt(10*Math.random())),$("#z_ModalForDone").modal("show")}function subHistoryTitl(){function t(t){for(var a="",e=0;e<t.length;e++){var o=t[e].startTime;o=getSmpFormatDateByLong(o,!0);var r=t[e].endTime;r=null==r?"":getSmpFormatDateByLong(r,!0);var n=e+1,s=t[e].assigneeName,d=t[e].fromUserName;1==t[e].replace&&(s=s+"（ "+d+"——待办授权）"),a+="<tr><td>"+n+"</td><td>"+t[e].linkName+"</td><td>"+s+"</td><td>"+t[e].orgName+"</td><td>"+t[e].handleType+"</td><td>"+o+"</td><td>"+r+'</td><td style="word-wrap:break-word;word-break:break-all;">'+t[e].userComment+"</td></tr>"}return a}var a=$("#processInstanceIdForDone").val();$.get(serverPath+"workflowrest/subHistoryTitl/"+a,function(a){if(1==a.retValue){for(var e='<table class="table table-striped table-bordered table-condensed"><thead><tr><th>序号</th><th>环节名称</th><th>受理人</th><th>受理人部门</th><th>处理方式</th><th>任务接收时间</th><th>任务办理时间</th><th>处理意见</th></tr></thead><tbody>',o="</tbody></table>",r="",n=0;n<a.data.length;n++){r+='<div class="list-group-item" style="background-color: #A4D3EE;"><table><tr style="width: 100%;"><td style="width: 100%;"><span style="font-size: 14px;color: white;">'+a.data[n].TITLENAME+'</span></td><td style="width: 100%;" align="right"><div class="btn-group btn-group-xs"><button type="button" class="btn btn-danger" onclick="openImagesForDone(\'b_'+a.data[n].PROC_DEF_ID_+'_ForDone\')" style="text-align: right;">点击查看流程图</button></div></td></tr></table></div><div class="list-group-item"><ul id="b_'+a.data[n].PROC_DEF_ID_+'_ForDone" class="nav nav-tabs">';for(var s=0;s<a.data[n].temp.length;s++)r+=0==s?'<li class="active"><a id="b_'+a.data[n].temp[s].PROC_INST_ID+'" href="#business_'+a.data[n].temp[s].PROC_INST_ID+'_ForDone" aria-controls="business_'+a.data[n].temp[s].PROC_INST_ID+'_ForDone" role="tab" data-toggle="tab">'+a.data[n].temp[s].NAME_+"</a></li>":'<li ><a id="b_'+a.data[n].temp[s].PROC_INST_ID+'" href="#business_'+a.data[n].temp[s].PROC_INST_ID+'_ForDone" aria-controls="business_'+a.data[n].temp[s].PROC_INST_ID+'_ForDone" role="tab" data-toggle="tab">'+a.data[n].temp[s].NAME_+"</a></li>";r+='</ui><div class="tab-content">';for(var s=0;s<a.data[n].temp.length;s++)r+=0==s?'<div class="tab-pane active" id="business_'+a.data[n].temp[s].PROC_INST_ID+'_ForDone">'+e+t(a.data[n].temp[s].history)+o+"</div>":'<div class="tab-pane" id="business_'+a.data[n].temp[s].PROC_INST_ID+'_ForDone">'+e+t(a.data[n].temp[s].history)+o+"</div>";r+="</div></div>"}$("#h_contentForDone").append(r)}})}function addCustomTab(t){var a=t.title,e=t.url,o=$("li").length,r="addcustom_tab"+(o+1),n="addcustom_div"+(o+1),s='<div role="tabpanel" class="tab-pane fade" id=\''+n+"'></div>",d="<li id='"+r+"' role='presentation'></li>",i="<a href='#"+n+"' aria-controls='"+n+'\' role="tab" data-toggle="tab">'+a+"</a>";$("#historyForDone").before(s),$("#"+n).load(e),$("#historyLiForDone").before(d),$("#"+r).append(i)}var parm=App.getPresentParm(),pageType=parm.pageType;$(function(){initData();var t=$("#processDefinitionIdForDone").val(),a=$("#processInstanceIdForDone").val(),e=$("#taskDefinitionKeyForDone").val(),o=$("#taskIdForDone").val();loadTaskPath(serverPath,a,o,e,t),loadHistoicFlow(serverPath,a);var r=serverPath+"workflowrest/flowchart/"+a+"/"+parseInt(10*Math.random()),n=new XMLHttpRequest;n.open("get",r,!0),n.responseType="blob",n.onload=function(){if(200==this.status){var t=this.response,a=document.createElement("img");a.onload=function(){window.URL.revokeObjectURL(a.src)},a.src=window.URL.createObjectURL(t),$("#diagramImgForDonediv").html(a)}},n.send();var s=$("#canWithDrawForDone").val();console.log("canWithDraw="+s),"true"==s?$("#returnButtonForDone").click(function(){returnProcess()}):$("#returnButtonForDone").hide(),"3"==pageType&&$("#returnListForDone").html("关闭")}),subHistoryTitl();
<style type="text/css">
    .staffTree {
        overflow: auto;
    }
</style>
<div class="modal-dialog" role="document">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">选择人员</h4>
        </div>
        <div class="modal-body" style="padding-left: 10%;padding-top: 10px;">
            <ul id="staffTree" class="ztree staffTree"></ul>
        </div>
        <div class="modal-footer">
            <button type="button" onclick="checkStaff()" class="btn btn-danger btn-circle"><i class="iconfont icon-baocun"></i>确定</button>
            <button type="button" class="btn btn-default btn-circle" data-dismiss="modal"><i class="iconfont icon-close"></i>关闭</button>
        </div>
    </div>
</div>
<script type="text/javascript">
    //系统全局变量获取
    var config = top.globalConfig;
    var serverPath = config.serverPath;
    //全局变量
    var staffTree = null;
    var textValue = null;
    var setKey = null;
    var dom = null;
    //设置树的高度
    var documentHeight = $(".page-content").height() - 190;
    $("#staffTree").css("height", documentHeight);
    //生成树
    function initStaffTree(inputDom, value, key, ajaxData) {
        textValue = value;
        setKey = key;
        dom = inputDom;
        $("#commomModal").modal("show");
        //配置
        var treeSetting = {
            view: {
                selectedMulti: false,
                dblClickExpand: false
            },
            data: {
                simpleData: {
                    enable: true,
                    idKey: "orgId",
                    pIdKey: "parentId"
                },
                key: {
                    name: "orgName"
                }
            },
            async: {
                enable: true,
                url: '',
                type: "GET", // 默认post
                dataType: 'json',
                autoParam: ["id=orgId"],
                dataFilter: ajaxDataFilter //处理异步加载返回的数据
            },
            callback: {
                onDblClick: setInputInfo,
                beforeAsync: function(treeId, treeNode) {
                    staffTree.setting.async.url = serverPath + "orgs/" +
                        treeNode.orgId + "/staffChildren";
                    return true;
                }
            }
        };
        //获取数据
        App.formAjaxJson(serverPath + "orgs/" + config.curCompanyId + "/staffTree", "get", JSON.stringify(ajaxData), successCallback);

        function successCallback(result) {
            var data = result.data;
            if (data != "") {
                if (staffTree) {
                    staffTree.destroy();
                }
                staffTree = $.fn.zTree.init($("#staffTree"), treeSetting, data);
                // 默认展开第一层
                var nodes = staffTree.getNodes();
                for (var i = 0, l = nodes.length; i < l; i++) {
                    staffTree.expandNode(nodes[i]);
                }
            } else {
                layer.msg("暂无数据，请稍后重试");
            }
        }
        //双击事件 
        function setInputInfo(event, treeId, treeNode) {
            setInputValue(treeNode);
        }
        //查看异步加载返回数据
        function ajaxDataFilter(treeId, parentNode, childNodes) {
            var array = childNodes.data;
            if (!array) {
                return null;
            } else {
                return array;
            }
        }
    }
    //确定按钮点击
    function checkStaff() {
        var treeNode = staffTree.getSelectedNodes()[0];
        if (treeNode == undefined) {
            layer.msg("请选择人员", {
                icon: 2
            })
        } else {
            setInputValue(treeNode);
        }
    }
    /*
     * 判断是否选的是人员
     * 设置input框的值setKey >> data-key
     */
    function setInputValue(treeNode) {
        if (treeNode.isParent == false) {
            // if (setKey != undefined) {
            //     if ($.isArray(setKey)) {
            //         $.each(setKey, function(k, v) {
            //             $(dom).data(v, treeNode[v]);
            //         });
            //     } else {
            //         $(dom).data(setKey, treeNode[setKey]);
            //     }
            // };
            App.formAjaxJson(parent.globalConfig.serverPath + "staffs/editStaffRoleByCopy/" + $("#roleCopyFrom").val() + "/" + treeNode.staffOid, "get", null, successCallbacks, improperCallbacks);

            function successCallbacks(result) {
                layer.alert(result.message, {
                    time: 1500,
                    icon: 6
                });
                // $(dom).data("exactSearch", true);
                // $(dom).val(treeNode[textValue]);
                // $(dom).attr("title", treeNode[textValue]);
                $("#commomModal").modal("hide");
            }

            function improperCallbacks(result) {
                layer.alert(result.message, {
                    icon: 5
                });
            }
        } else {
            layer.msg("请选择具体的人员", {
                icon: 2
            })
        }
    }
</script>
<div class="form-fieldset">
	<div class="form-fieldset-title">
		<span><i class="iconfont icon-layers"></i> 线路资费清单</span>
		<div class="form-fieldset-tools">
			<a href="#" class="form-collapse"><i class="fa fa-angle-up"></i></a>
		</div>
	</div>
	<div class="form-fieldset-body">
		<div class="row" id="lineChargesListContent">
			<div class="portlet">
                <div class="portlet-title ">
                    <div class="caption font-dark contract">
                        <span class="caption-subject bold uppercase">租费</span>
                    </div>
                </div>
                <div class="portlet-body">
					<div class="tableToobarContent hidden" id="lineChargesListToolbar">
						<button class="btn red" type="button" onclick="addIncomeLinerentTr()"><i class="iconfont icon-add"></i> 新增</button>
						<button class="btn red" type="button" onclick="delectsIncomeLinerentTr()"><i class="iconfont icon-shanchu"></i> 删除</button>
						<button class="btn red" type="button" onclick="exmportTemplate('wordcard_income_tariff')"><i class="iconfont icon-export"></i> 下载模板</button>
						<button class="btn red" type="button" onclick="lineChargestFileImport()"><i class="iconfont icon-import"></i> 导入</button>
					</div>
					<div class="table-responsive" id="incomeLinerentTableContent">
						<table class="table table-hover table-bordered table-striped table-align" style="min-width: 1700px;" id="incomeLinerentTable">
							<thead>
								<tr>
									<th class="lineChargesTableEdit"><label class='ui-checkbox'><input type='checkbox' name='incomeLinerentCheckAll' id="incomeLinerentCheckAll"><span></span></label></th>
									<th style="width: 50px;">序号</th>
									<th style="width: 160px;"><i class="iconfont icon-mi required"></i>产品类型</th>
									<th style="width: 180px;"><i class="iconfont icon-mi required"></i>产品名称</th>
									<th style="width: 150px;"><i class="iconfont icon-mi required"></i>产品属性</th>
									<th style="width: 150px;"><i class="iconfont icon-mi required"></i>稽核标签</th>
									<th style="width: 150px;"><i class="iconfont icon-mi required"></i>固定月租</th>
									<th style="width: 150px;"><i class="iconfont icon-mi required"></i>线路数量</th>
									<th style="width: 150px;"><i class="iconfont icon-mi required"></i>合计月租</th>
									<th style="width: 150px;"><i class="iconfont icon-mi required"></i>一次性费用</th>
									<th style="width: 150px;"><i class="iconfont icon-mi required"></i>其他费用</th>
									<th style="width: 150px;"><i class="iconfont icon-mi required"></i>结算周期</th>
									<th class="lineChargesTableEdit">操作</th>
								</tr>
							</thead>
							<tbody id="incomeLinerentTbody">
								<tr class="emptyTr">
									<td colspan="13">暂无线路资费清单</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	/*
	 * 设置页面的id值，由保存和提交后回调
	 */
	function setPageId_incomeLinerentListId(value){
		var valueKey = 0;
		$.each($("#incomeLinerentTbody tr"), function(k,v) {
			if(!$(v).hasClass("emptyTr")){
				if($(v).data("id") != undefined){
					$(v).data("id",value[valueKey]);
					valueKey++;
				}
			}
		});
	}
	/*
	 * 返回本页面数据，若无返回{}，若不提交本页面的值可删除此方法
	 * isSubmit 提交时为true,判断页面是否要加逻辑上的验证(bootstrap-validator验证除外)
	 */
	function getValue_incomeLinerentList(isSubmit){
		var incomeLinerentDataList = [];
		$.each($("#incomeLinerentTbody tr"),function(k,v){
			if(!$(v).hasClass("emptyTr")){
				var incomeLinerentDataItem = {};
				incomeLinerentDataItem.wcardId = wcardId;
				incomeLinerentDataItem.contractNumber = contractNumber;
				incomeLinerentDataItem.linerentId = $(v).data("id");
				incomeLinerentDataItem.productKind = $(v).find(".productKind").val();
				incomeLinerentDataItem.productName = $(v).find(".productName").val();
				incomeLinerentDataItem.productAttr = $(v).find(".productAttr").val();
				incomeLinerentDataItem.auditLabel = $(v).find(".auditLabel").val();
				incomeLinerentDataItem.fixedMonthRent = $(v).find(".fixedMonthRent").val();
				incomeLinerentDataItem.lineCount = $(v).find(".lineCount").val();
				incomeLinerentDataItem.totalMonthRent = $(v).find(".totalMonthRent").val();
				incomeLinerentDataItem.onceCost = $(v).find(".onceCost").val();
				incomeLinerentDataItem.otherCost = $(v).find(".onceCost").val();
				incomeLinerentDataItem.settlementFrequency = $(v).find(".settlementFrequency").val();
				incomeLinerentDataList.push(incomeLinerentDataItem);
			}
		});
		return incomeLinerentDataList;
	}
	/*
	 * 去除多于的行
	 */
	function removeMorethan_incomeLinerentList(){
		var tableValue = getValue_incomeLinerentList();
		var emptyList = [];
		for(var i = 0; i < tableValue.length; i++){
			var tableItem = tableValue[i];
			var isEmpty = true;
			delete tableItem.contractNumber;
			delete tableItem.linerentId;
			delete tableItem.wcardId;
			if(tableItem.onceCost == 0){
				delete tableItem.onceCost;
			};
			if(tableItem.otherCost == 0){
				delete tableItem.otherCost;
			};
			$.each(tableItem, function(k,v) {
				if(v){
					isEmpty = false;
					return false;
				}
			});
			if(isEmpty){
				emptyList.push(i);
			}
		};
		$.each(emptyList, function(m,n) {
			var index = n - m;
			$("#incomeLinerentTbody tr").eq(index).remove();
		});
		addIncomeLinerentTbodyEmptyTr();
	}
	//name自增基础值
	var isCreateLinerLen = 0;
	
	//产品类型字典html
	var incomeLinerentType = "";
	//互联网接入服务产品名称字典html
	var incomeLinerentName9070 = "";
	//电路出租名称字典html
	var incomeLinerentName9073 = "";
	//网元出租名称字典html
	var incomeLinerentName9076 = "";
	//产品属性字典html
	var incomeLinerentProp = "";
	//稽核标签字典html
	var incomeLinerentLable = "";
	//结算周期字典html
	var incomeLinerentCycle = "";
	//获取字典select Html;
	getIncomeLinerenDict();
	//获取线路资费信息
	getIncomeLinerenInfo();
	/*
	 * 获取线路资费信息字典值
	 */
	function getIncomeLinerenDict() {
		incomeLinerentType = createIncomeLinerenDictHtml(App.getDictInfo(9060));
		incomeLinerentName9070 = createIncomeLinerenDictHtml(App.getDictInfo(9070));
		incomeLinerentName9073 = createIncomeLinerenDictHtml(App.getDictInfo(9073));
		incomeLinerentName9076 = createIncomeLinerenDictHtml(App.getDictInfo(9076));
		incomeLinerentProp = createIncomeLinerenDictHtml(App.getDictInfo(9080));
		incomeLinerentLable = createIncomeLinerenDictHtml(App.getDictInfo(9090));
		incomeLinerentCycle = createIncomeLinerenDictHtml(App.getDictInfo(9015));
	};
	function createIncomeLinerenDictHtml(data){
		var selectHtml = "<option value=''>请选择</option>";
		$.each(data, function(k,v) {
			selectHtml += "<option value='"+ k +"'>"+ v +"</option>";
		});
		return selectHtml;
	}
	
	/*
	 * 获取开票信息
	 */
	function getIncomeLinerenInfo() {
		var url = serverPath + "contractOrderEditorController/getLinerentId";
		var postData = JSON.stringify({wcardId:wcardId});
		App.formAjaxJson(url, "post", postData, successCallback);

		function successCallback(result) {
			var data = result.data;
			if(data.length > 0){
				$("#incomeLinerentTbody").html("");
				isCreateIncomeLinerentTrLength = data.length;
				for(var i = 0; i < data.length; i++){
					addIncomeLinerentTr(data[i]);
				};
			};
			/*
			 * isEdit 判断页面是否只能查看
			 */
			if(!isEdit){
				$("#lineChargesListContent").find("input").attr("disabled","disabled");
				$("#lineChargesListToolbar,.lineChargesTableEdit").remove();
			}else{
				$("#lineChargesListToolbar").removeClass("hidden");
			};
		}
	}
	/*
	 * 增加处理
	 */
	function addIncomeLinerentTr(data){
		if($("#incomeLinerentTbody .emptyTr")[0] != undefined){
			$("#incomeLinerentTbody .emptyTr").remove();
		}
		isCreateLinerLen++;
		var productKind = "productKind" + isCreateLinerLen;
		var productName = "productName" + isCreateLinerLen;
		var productAttr = "productAttr" + isCreateLinerLen;
		var auditLabel = "auditLabel" + isCreateLinerLen;
		var fixedMonthRent = "fixedMonthRent" + isCreateLinerLen;
		var lineCount = "lineCount" + isCreateLinerLen;
		var totalMonthRent = "totalMonthRent" + isCreateLinerLen;
		var onceCost = "onceCost" + isCreateLinerLen;
		var otherCost = "otherCost" + isCreateLinerLen;
		var settlementFrequency = "settlementFrequency" + isCreateLinerLen;
		var linerentId = "100000";
		var fixedMonthRentVal = "";
		var lineCountVal = "";
		var totalMonthRentVal = "";
		var onceCostVal = "0";
		var otherCostVal = "0";
		var incomeLinerentName = "";		//产品名称联动设置
		var auditLabelDom = "<td><div class='form-group'><select class='form-control auditLabel' disabled='disabled' name='"+ auditLabel +"'>"+ incomeLinerentLable +"</select></div></td>";
		if(data){
			linerentId = data.linerentId ? data.linerentId : "100000";
			fixedMonthRentVal = data.fixedMonthRent ? data.fixedMonthRent : "";
			lineCountVal = data.lineCount ? data.lineCount : "";
			totalMonthRentVal = data.totalMonthRent ? data.totalMonthRent : "";
			onceCostVal = data.onceCost ? data.onceCost : "0";
			otherCostVal = data.otherCost ? data.otherCost : "0";
			if(data.productKind == 906010){
				incomeLinerentName = incomeLinerentName9070;
			}else if(data.productKind == 906011){
				incomeLinerentName = incomeLinerentName9073;
			}else if(data.productKind == 906012){
				incomeLinerentName = incomeLinerentName9076;
			}
		}
		var appendHtml = "<tr data-id='"+ linerentId +"' class='"+ productName +"'>"+
							"<td class='lineChargesTableEdit'><label class='ui-checkbox'><input type='checkbox' name='incomeLinerentCheck'><span></span></label></td>"+
							"<td class='orderNumber'></td>"+
							"<td><div class='form-group'><select class='form-control select2me productKind' data-placeholder='"+setPTip('请选择产品类型')+"' name='"+ productKind +"'>"+ incomeLinerentType +"</select></div></td>"+
							"<td><div class='form-group'><select class='form-control productName' data-placeholder='"+setPTip('请选择产品名称')+"' name='"+ productName +"'>"+ incomeLinerentName +"</select></div></td>"+
							"<td><div class='form-group'><select class='form-control select2me productAttr' data-placeholder='"+setPTip('请选择产品属性')+"' name='"+ productAttr +"'>"+ incomeLinerentProp +"</select></div></td>"+
							auditLabelDom +
							"<td><div class='form-group'><input type='text' class='form-control fixedMonthRent' name='"+ fixedMonthRent +"' placeholder='"+setPTip('请输入固定月租')+"' value='"+fixedMonthRentVal+"' maxlength='20' /></div></td>"+
							"<td><div class='form-group'><input type='text' class='form-control lineCount' name='"+ lineCount +"' placeholder='"+setPTip('请输入线路数量')+"' value='"+lineCountVal+"' maxlength='10' /></div></td>"+
							"<td><div class='form-group'><input type='text' class='form-control totalMonthRent' name='"+ totalMonthRent +"' placeholder='"+setPTip('请输入合计月租')+"' value='"+totalMonthRentVal+"' maxlength='20' /></div></td>"+
							"<td><div class='form-group'><input type='text' class='form-control onceCost' name='"+ onceCost +"' placeholder='"+setPTip('请输入一次性费用')+"' value='"+onceCostVal+"' maxlength='20' /></div></td>"+
							"<td><div class='form-group'><input type='text' class='form-control otherCost' name='"+ otherCost +"' placeholder='"+setPTip('请输入其他费用')+"' value='"+otherCostVal+"' maxlength='20' /></div></td>"+
							"<td><div class='form-group'><select class='form-control select2me settlementFrequency' data-placeholder='"+setPTip('请选择结算周期')+"' name='"+ settlementFrequency +"'>"+ incomeLinerentCycle +"</select></div></td>"+
							"<td class='lineChargesTableEdit'><button type='button' class='btn primary btn-outline btn-xs' onclick='delectIncomeLinerentTr(this)'>删除</button></td>"+
						"</tr>";
		$("#incomeLinerentTbody").append(appendHtml);
		if(!isEdit){
			$("."+productName).find("select").attr("disabled","disabled");
		}
		App.initFormSelect2("."+productName);
		if(data){
			$("select[name='"+productKind+"']").val(data.productKind).trigger("change");
			$("select[name='"+productName+"']").val(data.productName).trigger("change");
			$("select[name='"+productAttr+"']").val(data.productAttr).trigger("change");
			if(data.productKind == 906010){
				$("select[name='"+auditLabel+"']").val(data.auditLabel).trigger("change");
			}
			$("select[name='"+settlementFrequency+"']").val(data.settlementFrequency).trigger("change");
		}else{
			$("select[name='"+productName+"']").select2({
	        	placeholder:"请选择",
	            language:'zh-CN',
	            width:'100%',
	            allowClear:true,
	            minimumResultsForSearch: -1
	       	});
        	$("select[name='"+auditLabel+"']").select2({
        		placeholder:"",
	            language:'zh-CN',
	            width:'100%'
        	});
		};
		addNotEmptyValidatorField(productKind,"产品类型不能为空");
		addNotEmptyValidatorField(productName,"产品名称不能为空");
		addNotEmptyValidatorField(auditLabel,"稽核标签不能为空");
		addNotEmptyValidatorField(productAttr,"产品属性不能为空");
		addNotEmptyValidatorField(settlementFrequency,"结算周期不能为空");
		var isInteger = {
			notEmpty : {
				message : "请输入不超过10个字符的整数"
			},
			regexp : {
				regexp : /^(0|[1-9][0-9]*)$/,
				message : '请输入大于等于0的整数'
			}
		};
		var isMoney = {
			notEmpty : {
				message : "请输入不超过20个字符的数字金额"
			},
			regexp : {
				regexp : /^[0-9]{1,17}.{0,1}[0-9]{0,2}$/,
				message : '请输入正确的数字金额'
			}
		}
	   	App.addValidatorField("#workOrderContentForm",lineCount,isInteger);
	   	App.addValidatorField("#workOrderContentForm",fixedMonthRent,isMoney);
	   	App.addValidatorField("#workOrderContentForm",totalMonthRent,isMoney);
	   	App.addValidatorField("#workOrderContentForm",onceCost,isMoney);
	   	App.addValidatorField("#workOrderContentForm",otherCost,isMoney);
	   	addIncomeLinerentTableSort();
		App.checkAllFn("#incomeLinerentCheckAll","incomeLinerentCheck");
	}
	$("#incomeLinerentTbody").on("change",".productKind",function(){
		var productKind = $(this).val();
		var incomeLinerentName = "";
		if(productKind == 906010){
			incomeLinerentName = incomeLinerentName9070;
		}else if(productKind == 906011){
			incomeLinerentName = incomeLinerentName9073;
		}else if(productKind == 906012){
			incomeLinerentName = incomeLinerentName9076;
		};
		var productNameDom = $(this).parents("td").next().find(".productName");
		var auditLabelDom = $(this).parents("td").next().next().next().find(".auditLabel");
		var productKindName = $(this).attr("name");
		var productName = $(productNameDom).attr("name");
		var auditLabelName = $(auditLabelDom).attr("name");
		var bvel = $("#workOrderContentForm").data("bootstrapValidator").getFieldElements(productKindName);
		productNameDom.html(incomeLinerentName);
        productNameDom.select2({
        	placeholder:"请选择",
            language:'zh-CN',
            width:'100%',
            allowClear:true,
            minimumResultsForSearch: -1
        });
        if(productKind == 906010){
        	if(isEdit){
        		auditLabelDom.removeAttr("disabled");
        	}
        	auditLabelDom.select2({
        		placeholder:setPTip('请选择稽核标签'),
	            language:'zh-CN',
	            width:'100%',
	            allowClear:true,
	            minimumResultsForSearch: -1
        	});
        }else{
        	auditLabelDom.attr("disabled","disabled");
        	auditLabelDom.val('');
        	auditLabelDom.select2({
        		placeholder:"",
	            language:'zh-CN',
	            width:'100%'
        	});
        };
        if(bvel.prevObject.prevObject){
			$("#workOrderContentForm").data("bootstrapValidator").updateStatus(productName,"NOT_VALIDATED",null).validateField(productName);
			$("#workOrderContentForm").data("bootstrapValidator").updateStatus(auditLabelName,"NOT_VALIDATED",null).validateField(auditLabelName);
		}
	})
	/*
	 * 批量删除表格数据
	 */
	function delectsIncomeLinerentTr(){
		var checkInvoiceLength = $("#incomeLinerentTbody input[name='incomeLinerentCheck']:checked").length;
		if(checkInvoiceLength == 0){
			layer.msg("请勾选要删除的线路资费清单");
		}else{
			layer.confirm("是否要删除这"+checkInvoiceLength+"条数据？",{icon:7,title:"提示"},function(index){
				layer.close(index);
				$.each($("#incomeLinerentTbody input[name='incomeLinerentCheck']:checked"), function(k,v) {
					$(v).parents("tr").remove();
				});
				addIncomeLinerentTableSort();
				App.checkAllFn("#incomeLinerentCheckAll","incomeLinerentCheck");
				addIncomeLinerentTbodyEmptyTr();
			})
		}
	}
	/*
	 * 删除表格数据
	 */
	function delectIncomeLinerentTr(dom){
		layer.confirm("是否要删除此条数据？",{icon:7,title:"提示"},function(index){
			layer.close(index);
			$(dom).parents("tr").remove();
			addIncomeLinerentTableSort();
			App.checkAllFn("#incomeLinerentCheckAll","incomeLinerentCheck");
			addIncomeLinerentTbodyEmptyTr();
		})
	}
	/*
	 * 表格数据增加序号
	 */
	function addIncomeLinerentTableSort(){
		$.each($("#incomeLinerentTbody .orderNumber"), function(k,v) {
			$(v).text(k+1);
		});
	}
	/*
	 * 若为空增加empty值
	 */
	function addIncomeLinerentTbodyEmptyTr(){
		if($("#incomeLinerentTbody tr").length == 0){
			var html = '<tr class="emptyTr"><td colspan="13">暂无线路资费清单</td></tr>';
			$("#incomeLinerentTbody").html(html);
		}
	}
	/*
	 * 线路资费导入
	 */
	function lineChargestFileImport(){
		var setting = {
			title: "线路资费信息导入",
			url: 'contractOrderEditorController/importContractLinerentExcel',
			postfix: ["xlsx","xls"],
			accept: ".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel",				//导入文件类型
			extraData: {wcardId:wcardId,contractNumber:contractNumber}
		};
		function callback(result){
			if(result.status == 1){
				var data = result.data;
				var length = data.length;
				if(length > 0){
					for(var i = 0; i < length; i++){
						addIncomeLinerentTr(data[i]);
					}
				};
				layer.msg("成功导入"+length+"条线路资费信息");
				$("#commomModal").modal("hide");
			}else if(result.status == 3010){
				showLayerErrorMsg(result.message);
			}else{
				showLayerErrorMsg(result.message,true);
			}
		}
		App.getFileImportModal(setting,callback);
	}
</script>
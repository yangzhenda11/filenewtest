<style type="text/css">
	#fileUploadModalBody{
		overflow: auto;
	}
	.fileUploadModalForm{
		padding-top: 20px;
		padding-bottom: 20px;
	}
	.fileUploadModalForm .form-group{
		display:table;
	}
	.fileUploadModalForm .form-group > label{
		width: 18%;
	    min-height: 1px;
	    line-height: 16px;
	    padding:0 10px 0 0;
	    vertical-align:middle;    
	    display:table-cell;
	    text-align: right;
	}
	.fileUploadModalForm .form-group > .valiParent{
		width: 100%;
		float: left;
	  	position: relative;
	    min-height: 1px;
	    padding-left: 10px;
	    padding-right: 10px;
	}
	.aDisable{
		background: #e8dcdc;
		pointer-events:none
	}
	.fileUploadModalForm table{
		margin-bottom: 10px;
	}
	#chooseFileUploader,.filePickerBtnList{
		display: inline-block;
	}
	#fileuploadLoading{
		width: 100%;
		margin: 20px 0;
	}
</style>
<div class="modal-dialog" role="document">
	<div class="modal-content">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="fileUploadModalLabel"></h4>
		</div>
		<img id="fileuploadLoading" style="display: none;" src="/static/img/loading2.gif"/>
		<div class="modal-body fileUploadModalForm" id="fileUploadModalBody">
            <div class="form-group col-sm-12">
                <label for="partnerCode" class="control-label">文件</label>
                <div class="valiParent">
			        <div id="filePicker">选择文件</div>
			        <div id="filePickerBtn" style="display: none;">
			        	<div id="chooseFileUploader"></div>
			        	<div class="filePickerBtnList">
			        		<button class="btn btn-default" onclick="fileUploaderStart()">开始上传</button>
				        	<button class="btn btn-default" onclick="fileUploaderDel()">删除文件</button>
			        	</div>
				    </div>
                </div>
            </div>
           	<div class="form-group col-sm-12">
                <label for="partnerCode" class="control-label">上传说明</label>
                <div class="valiParent" id="fileUpliadExplain" style="color: red;">
                    <i class="iconfont icon-mi required"></i>文件大小不能超过100M。
                </div>
            </div>
       </div>
		<div class="modal-footer">
			<button type="button" class="btn btn-default btn-circle" data-dismiss="modal"><i class="iconfont icon-close"></i>关闭</button>
		</div>
	</div>
</div>

<script type="text/javascript">
	//系统全局变量获取
	var config = top.globalConfig;
	var fileUploadPath = config.fileUploadPath;
	var successCallback = null;
	var fileCommonUploadObj = [];
	var uploader;
	function setParm(setting,queryCallback){
		var fileUploadModalLabel = setting.title == undefined ? "文件上传" : setting.title;
		$("#fileUploadModalLabel").text(fileUploadModalLabel);
		$("#fileUpliadExplain").append(setting.explain);
		$("#commomModal").modal("show");
		var emptyFn = function(){};
		successCallback = queryCallback == null || queryCallback == "" ? emptyFn : queryCallback;
		var fileExtensions = [];
		if(setting.fileExtensions){
			fileExtensions = setting.fileExtensions;
		};
		var extraData = setting.extraData;
		if(extraData){
			var displayName = extraData.displayName;
			if(displayName.indexOf("&^&") != -1){
				needChangeName = true;
				extraData.displayName = displayName.substring(0,displayName.length-3);
			}
		}else{
			extraData = {
				displayName: ""
			}
		}
		$("#commomModal").off("shown.bs.modal").on("shown.bs.modal",function(){
			initFileUpload(setting.url,fileExtensions,extraData);
		})
		$('#commomModal').off("hide.bs.modal").on('hide.bs.modal', function () {
		    uploader.destroy();
		});
	}
	function initFileUpload(url,fileExtensions,extraData){
		uploader = WebUploader.create({
		    swf: '/static/plugins/webuploader/Uploader.swf',
		    server:  fileUploadPath + url,
		    pick:{
                multiple: false,
                id: '#filePicker'
           	},
           	threads: 1,
           	fileVal: "fileName",
		    resize: false
		});
		// 文件选择处理。
		uploader.on('fileQueued', function (file) {
			var filename = file.name;
			if(filename.indexOf(" ") != -1 || filename.indexOf("%") != -1){
				layer.msg("文件中不能包括“ ”和“%”，请重新选择");
				uploader.reset();
				return;
			};
			if(file.size > 104857600){
				layer.msg("文件超过10M的限制，请重新选择");
				uploader.reset();
				return;
			}
			if(extraData){
				$.each(extraData, function(k,v) {
					uploader.options.formData[k] = v;
					file[k] = v;
				})
			};
			if(needChangeName){
    			var fileNameList = filename.split(".");
    			var changefileName = extraData.displayName + "." + fileNameList[fileNameList.length-1];
    			uploader.options.formData.displayName = changefileName;
    			file.displayName = changefileName;
        	};
        	zhendaFlag ++;
        	if(zhendaFlag > 1){
        		delete uploader.options.formData.displayName;
        	};
			$("#chooseFileUploader").text(file.name);
			$("#filePicker").hide();
			$("#filePickerBtn").show();
        });
        // 文件上传成功处理。
	    uploader.on('uploadSuccess', function (file, response) {
	        if(response.status == 1){
	    		layer.msg("上传成功");
	    		if(file.displayName == "" || file.displayName == undefined){
	    			var itemInfo = {
		    			name:file.name,
		    			data:response.data
		    		};
	    		}else{
	    			var itemInfo = {
		    			name:file.displayName,
		    			data:response.data
		    		};
	    		};
	    		fileCommonUploadObj.push(itemInfo);
	    		successCallback();
	    	}else{
	    		layer.alert(response.message,{icon:2,title:"错误"});
	    	}
	    });
	    // 文件上传失败处理。
	    uploader.on('uploadError', function (file) {
	        layer.alert('上传失败',{icon:2,title:"错误"});
	    });
	    // 上传传完毕，不管成功失败都会调用该事件，主要用于关闭进度条
	    uploader.on('uploadComplete', function (file) {
	        $("#fileuploadLoading").hide();
	        $("#fileUploadModalBody").show();
	        fileUploaderDel();
	    });
	}
	function fileUploaderStart(){
		var files = uploader.getFiles();
		if(!(files == [] || files == "")){
			uploader.upload();
			$("#fileuploadLoading").show();
	        $("#fileUploadModalBody").hide();
		}
	};
	function fileUploaderDel(){
		uploader.reset();
		$("#filePickerBtn").hide();
		$("#filePicker").show();
	};
    /*
     * 获取上传结果
     */
    function getFileItemInfo(){
    	return fileCommonUploadObj;
    }
</script>

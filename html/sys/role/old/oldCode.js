function resetValidator(){$("#roleForm").data("bootstrapValidator")&&$("#roleForm").data("bootstrapValidator").resetForm()}function roleAdd_OrgTree(e){selectOrgTree("staffAdd_OrgTree",e,parent.globalConfig.curOrgId,roleAdd_OrgTreeCallback,"","1","720","")}function roleAdd_OrgTreeCallback(e,a,t){$("#orgName").val(a),$("#orgId").val(t),$("#roleForm").data("bootstrapValidator").updateStatus("orgName","NOT_VALIDATED",null).validateField("orgName")}function filterStaff(e,a,t){return t.children}function btnFun(e){if(contentBtn="")return contentBtn;var a=new Array;return a.push({name:"修改",fn:"showEditPage('"+e.roleId+"')"}),a.push({name:"删除",fn:"del('"+e.roleId+"','"+e.roleName+"')",type:"btn-n"}),a.push({name:"查看权限",fn:"roleSearchPerm('"+e.roleId+"', '"+e.roleName+"')"}),a.push({name:"关联人员",fn:"roleSearchStaff('"+e.roleId+"', '"+e.roleName+"')"}),contentBtn={func:a}}function addRole(){for(var e=$.fn.zTree.getZTreeObj("rolePermissionTree"),a=(e.getNodeByParam("permId",100),e.getNodeByParam("permId",201),e.getCheckedNodes(!0)),t="",r=0;r<a.length;r++)t+=a[r].permId,t+=",";t=t.substring(0,t.length-1);var l=$("#roleName").val(),o=($("#orgName").val(),$("#roleDesc").val()),n=$('input[name="isPartnerRole"]:checked ').val(),f={role:{roleDesc:o,roleName:l,isPartnerRole:n},permId:t,permForPermManageId:permForPermManageId,roleForRoleManageId:roleForRoleManageId,staffId:curStaffId};$.ajax({url:serverPath+"roles/",data:JSON.stringify(f),type:"POST",contentType:"application/json",success:function(e){"1"==e.status&&(initFrame(),rolePermissionTree=null,searchRoleTable.ajax.reload(),alert("添加成功！"))},error:function(){alert("添加失败o_o请重试...")}})}function backSearch1(){$("#rolePermissionTree").val(),$(".roleChoose").remove(),$("#roleList button").remove(),initFrame(),$("#searchRoleTable").DataTable().draw(!1)}function chooseAll(){var e=$("input[name='roleList']");$.each(e,function(e,a){$(a).prop("checked",!0)})}function clearAll(){$("[name = roleList]:checkbox").attr("checked",!1)}function updateRole(){for(var e=$("#roleId").val(),a=$("#roleName").val(),t=$("#roleDesc").val(),r=$('input[name="isPartnerRole"]:checked').val(),l=$.fn.zTree.getZTreeObj("rolePermissionTree"),o=(l.getNodeByParam("permId",100),l.getNodeByParam("permId",201),l.getCheckedNodes(!0)),n="",f=0;f<o.length;f++)n+=o[f].permId,n+=",";n=n.substring(0,n.length-1);for(var s=$.fn.zTree.getZTreeObj("permForPermManageTree"),d=s.getCheckedNodes(!0),c="",f=0;f<d.length;f++)c+=d[f].permId,c+=",";c.length>0&&(c=c.substring(0,c.length-1));for(var i=document.getElementsByName("roleList"),u="",f=0;f<i.length;f++)i[f].checked&&(u+=i[f].value,u+=",");u.length>0&&(u=u.substring(0,u.length-1));var m={role:{roleId:e,roleDesc:t,roleName:a,isPartnerRole:r},permId:n,permForPermManageId:c,roleForRoleManageId:u,staffId:curStaffId};$.ajax({url:serverPath+"roles/",type:"PUT",contentType:"application/json",data:JSON.stringify(m),success:function(e){1==e.status&&(initFrame(),rolePermissionTree=null,searchRoleTable.ajax.reload(),alert("更新角色成功！"))},error:function(){alert("更新角色失败o_o请查明原因后重试！")}})}function selectStaff(e){$("#staffModal").modal("show"),$("#showStaffInRoleId").val(e),$.get(serverPath+"roles/orgStaffsTreeRoot",{curOrgId:curOrgId},function(a){null==a?alert("没有相关组织和人员信息"):(curOrgStaffRole=e,roleStaffOrgTree=$.fn.zTree.init($("#stafftree"),roleStaffsetting,a),curOrgStaffNode=roleStaffOrgTree.getNodes()[0],roleStaffOrgTree.selectNode(curOrgStaffNode),roleStaffOrgTree.expandNode(curOrgStaffNode,!0,!1,!0))})}function getStaffCheck(){for(var e=$("#showStaffInRoleId").val(),a=$.fn.zTree.getZTreeObj("stafftree"),t=a.getCheckedNodes(!0),r="",l=0;l<t.length;l++)0==t[l].isParent&&(r+=t[l].staffOrgId+",");return null==r||""==r?void alert("请选择人员"):void $.post(serverPath+"roles/"+e+"/staffs/",{roleId:e,staffOrgIds:r.substr(0,r.length-1),staffId:curStaffId},function(){$("#staffModal").modal("hide"),$("#roleSearchStaffTable").DataTable().draw(!1),roleStaffOrgTree.destroy(),alert("添加人员成功！")})}function delStaff(e,a,t,r){confirm("是否要删除'"+r+"'的'"+a+"'角色吗？")&&deleteStaffInRole(e,t)}function deleteStaffInRole(e,a){$.ajax({url:serverPath+"roles/"+e+"/staff/"+a,type:"DELETE",success:function(e){e.data>0&&($("#_frm_confirm_modal").modal("hide"),alert("删除成功！"),$("#roleSearchStaffTable").DataTable().draw(!1))},error:function(){alert("删除失败！")}})}function del(e,a){confirm("确定要删除角色 "+a+" 吗？")&&selectSysRole(e)}function selectSysRole(e){$.ajax({url:serverPath+"roles/"+e+"/isStaff",type:"GET",data:{roleId:e},success:function(a){a.isStaff?alert("该角色不可删除！"):deleteSysRole(e)}})}function deleteSysRole(e){$.ajax({url:serverPath+"roles/"+e+"/role/"+curStaffId,type:"DELETE",success:function(){$("#_frm_confirm_modal").modal("hide"),alert("删除成功！"),searchRoleTable.ajax.reload()}})}function roleSearchPerm(e,a){$("#permModalLabel").text('"'+a+'" 角色的权限');$.ajax({url:serverPath+"roles/"+e+"/perms",type:"GET",success:function(e){if(null!=e.data){var a=$.fn.zTree.init($("#rolePermissionTree1"),permissionViewSetting,e.data);a.expandAll(!0)}else alert("该角色无相关权限")}}),$("#roleHavepermModal").modal("show")}function roleSearchStaff(e,a){var t=curOrgId;$("#showStaffInRoleId").val(e),$("#roleManage").show(),$("#searchRoleContent").hide(),$("#RoleContainer").show(),$(".ma_tip").text('拥有"'+a+'" 角色的人员'),$("#AddStaffInRoleModal").attr("onClick","selectStaff("+e+")"),roleSearchStaffTable&&roleSearchStaffTable.destroy(),roleSearchStaffTable=$("#roleSearchStaffTable").DataTable({ordering:!1,serverSide:!0,scrollX:!0,autoWidth:!1,ajax:{type:"GET",url:serverPath+"roles/"+e+"/staffs",contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"json",data:{orgId:t}},columns:[{data:null,visible:!1},{data:null,title:"操作",className:"text-center",render:function(t,r,l){var o=addRoleStaffbtnFun(e,a,l),n=roletemplate(o);return n}},{data:"staffName",title:"人员姓名",className:"text-center",render:function(e,a,t){return"<a href=\"javascript:staffDetails('"+t.staffId+"')\">"+e+"</a>"}},{data:"loginName",title:"账号",className:"text-center"},{data:"orgName",title:"组织名称",className:"text-center"},{data:"sex",title:"性别",className:"text-center",render:function(e,a,t){return"M"==t.sex?"男":"女"}},{data:"mobilPhone",title:"手机号码",className:"text-center"},{data:"email",title:"邮箱",className:"text-center"},{data:"phone",title:"电话",className:"text-center"},{data:"staffStatus",title:"岗位状态",className:"text-center",render:function(e,a,t){return"1"==t.staffStatus?"有效":"无效"}}],columnDefs:[{targets:"_all",defaultContent:"",render:$.fn.dataTable.render.ellipsis(22,!0)}],dom:'rt<"pull-left mt5"l><"pull-left mt5"i><"pull-right mt5"p><"clear">'})}function addRoleStaffbtnFun(e,a,t){if(contentBtn="")return contentBtn;var r=new Array;return r.push({name:"删除",fn:"delStaff('"+e+"', '"+a+"','"+t.staffOrgId+"', '"+t.staffName+"')"}),contentBtn={func:r}}function staffDetails(e){$("#roleStaffInfoModal").load("../staff/staffDetailModal.html",function(){$("#staffDetailId").val(e),$("#mark").val("role"),$("#infoModal").attr("id","infoModal"+$("#mark").val()),$("#staffDetailId").attr("id","staffDetailId"+$("#mark").val()),$("#staffDetail").attr("id","staffDetail"+$("#mark").val())})}var roleStaffOrgTree,permForPermManageTree,curOrgStaffNode,curOrgStaffRole,orgTree,roleSearchStaffTable,checkValidator={message:"This value is not valid",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},fields:{roleName:{validators:{notEmpty:{message:"请输入角色名称"}}},orgId:{selector:"#orgName",validators:{notEmpty:{message:"请单击选择所属组织"}}},roleDesc:{validators:{stringLength:{min:0,max:100,message:"请输入不超过100个字符"}}}},submitHandler:function(){alert("表单提交"),$("input[name='roleId']").val()?updateRole():addRole()}},roleStaffsetting={view:{selectedMulti:!0},edit:{enable:!1,editNameSelectAll:!1},data:{simpleData:{enable:!0}},check:{chkStyle:"checkbox",enable:!0,chkboxType:{Y:"",N:""}},async:{enable:!0,otherParam:{orgId:function(){return curOrgStaffNode.id}},type:"get",dataType:"json",dataFilter:filterStaff},callback:{beforeAsync:function(e,a){return curOrgStaffNode=a,roleStaffOrgTree.setting.async.url=serverPath+"roles/"+curOrgStaffRole+"/orgStaffsTreeChildren",!0}}},rolebtnModel='    	{{#each func}}    <button type="button" class="user-button user-{{this.type}} btn-sm" onclick="{{this.fn}}">{{this.name}}</button>    {{/each}}',roletemplate=Handlebars.compile(rolebtnModel);
<div class="form-fieldset">
	<div class="form-fieldset-title">
		<div class="fieldset-title">
			<p>选择合同履行人</p><span></span>
		</div>
		<div class="form-fieldset-tools">
			<a class="form-collapse"><i class="fa fa-angle-up"></i></a>
		</div>
	</div>
	<div class="form-fieldset-body">
		<div id="contractFeasorContent">
			<div class="ui-radio-list ui-radio-inline">
				<label class="ui-radio">
					<input type="radio" value="1" checked="checked" name="performerType">
					<span></span>
					本级履行或上下级共同履行
				</label>
				<label class="ui-radio hidden" id="performerType2">
					<input type="radio" value="2" name="performerType">
					<span></span>
					仅由下级组织履行
				</label>
			</div>
			<div class="tableToobarContent hidden" id="contractFeasorToolbar">
				<button type="button" class="btn red" onclick="creatFeasorTree()">添加主要履行人</button>
				<button type="button" class="btn red" onclick="delectFeasor()">删除主要履行人</button>
			</div>
			<table class='table table-hover table-bordered table-striped table-align' id="feasorTable" style="width: 70%;">
				<thead>
					<tr>
						<th class="feasorCheckbox" style="width: 10%;"><label class='ui-checkbox'><input type='checkbox' name='feasorCheckAll' id="feasorCheckAll"><span></span></label></th>
						<th style="width: 10%;">序号</th>
						<th style="width: 30%;"><i class="iconfont icon-mi required"></i>主要履行人</th>
						<th style="width: 50%;"><i class="iconfont icon-mi required"></i>主要履行人所属组织</th>
					</tr>
				</thead>
				<tbody id="feasorTbody">
					<tr class="emptyTr">
						<td colspan="4">暂无履行人信息</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
<script type="text/javascript">
	var feasorTree = null;
	var deafaultFeasorHtml = "";
	/*
	 * 设置页面的id值，由保存和提交后回调
	 */
	function setPageId_performerListId(value){
		var valueKey = 0;
		$.each($("#feasorTbody tr"), function(k,v) {
			if(!$(v).hasClass("emptyTr")){
				if($(v).data("id") != undefined){
					$(v).data("id",value[valueKey]);
					valueKey++;
				}
			}
		});
	}
	/*
	 * 返回本页面数据，若无返回{}，若不提交本页面的值可删除此方法
	 * isSubmit 提交时为true,判断页面是否要加逻辑上的验证(bootstrap-validator验证除外)
	 */
	function getValue_performerList(isSubmit,isActivate){
		var performerDataList = [];
		$.each($("#feasorTbody tr"),function(k,v){
			if(!$(v).hasClass("emptyTr")){
				var performerDataItem = {};
				performerDataItem.performerType = 1;
				performerDataItem.wcardId = wcardId;
				performerDataItem.contractNumber = contractNumber;
				performerDataItem.performerId = $(v).data("id");
				performerDataItem.performerOrgId = $(v).data("orgid");
				performerDataItem.performerStaffId = $(v).data("stafforgid");
				if(isActivate){
					performerDataItem.performerStaffName = $(v).children().eq(1).text();
					performerDataItem.performerOrgName = $(v).children().eq(2).text();
				}else{
					performerDataItem.performerStaffName = $(v).children().eq(2).text();
					performerDataItem.performerOrgName = $(v).children().eq(3).text();
				};
				performerDataList.push(performerDataItem);
			}
		});
		//当合同提交时，加校验"至少添加一条履行人信息";
		if(isSubmit){
			if(performerDataList.length > 0){
				return performerDataList;
			}else{
				layer.msg("请至少添加一条履行人信息");
				srolloOffect("#contractFeasorContent");
				return false;
			}
		}else{
			return performerDataList;
		}
	}
	/*
	 * 如果mainOrgFlag为0则不显示下级履行
	 */
	if(config.mainOrgFlag != 0){
		$("#performerType2").removeClass("hidden");
	}
	
	/*
	 * 模糊查询接口，设置模糊查询
	 */
	$("#feasorTreeInput").typeahead({
		afterSelect: setFeasorInput,
		delay: 300,
		addItem: {"name":"查询不到数据","id":""},
		clearElement: true,
		scrollHeight: -10,
        source: function (query, process) {
            return $.ajax({
                url: serverPath+'contractType/listPerformerStaff',
                type: 'post',
                global: false,
                data: {staffName: query,executorType:getExecutorType()},
                success: function (result) {
                	var data = result.data;
                	if(data.length > 0){
                		for(var k = 0; k < data.length; k++){
                			data[k].defalutName = data[k].name;
                			var staffOrgType = data[k].staffOrgType == "J" ? "-兼岗)" : "-主岗)";
                			var name = data[k].name + "(" + data[k].loginName +")" + "("+data[k].fullName + staffOrgType;
                			data[k].name = name;
                		}
                	};
                    return process(data);
                },
				error:function(e){
					App.ajaxErrorCallback(e);
				}
            });
        }
	});
	function setFeasorInput(item) {
		if(item.id != ""){
			item.name = item.defalutName;
	    	getFirstDepartment(item,2);
		}
	}
	function getExecutorType(){
		var performerType = $("#contractFeasorContent input[name='performerType']:checked").val();
		if(performerType == 1){
    		return 0;
    	}else if(performerType == 2){
    		return 1;
    	}
	}
	
	//获取履行人信息
	getFeasorInfo();
	/*
	 * 获取履行人信息
	 */
	function getFeasorInfo() {
		var url = serverPath + "contractOrderEditorController/getPerformerId";
		var postData = JSON.stringify({wcardId:wcardId});
		App.formAjaxJson(url, "post", postData, successCallback);

		function successCallback(result) {
			var data = result.data;
			if(data.length > 0){
				var html = "";
				for(var i = 0; i < data.length; i++){
					html += '<tr data-id="'+data[i].performerId+'" data-orgid="'+data[i].performerOrgId+'" data-stafforgid="'+data[i].performerStaffId+'" data-companyid="'+data[i].companyId+'">'+
	    						'<td class="feasorCheckbox"><label class="ui-checkbox"><input type="checkbox" name="feasorCheck"><span></span></label></td>'+
	    						'<td class="orderNumber"></td>'+
	    						'<td>'+data[i].performerStaffName+'</td>'+
	    						'<td>'+data[i].performerOrgName+'</td></tr>';
				};
				if(data[0].performerOrgType == 1){
					$("#contractFeasorContent input[name='performerType'][value=1]").attr("checked",true);
					deafaultFeasorHtml = html;
				}else if(data[0].performerOrgType == 2){
					$("#contractFeasorContent input[name='performerType'][value=2]").attr("checked",true);
				};
    			$("#feasorTbody").html(html);
    			addFeasorTbodySort();
    			App.checkAllFn("#feasorCheckAll","feasorCheck");
			};
			/*
			 * isEdit 判断页面是否只能查看
			 */
			if(!isEdit){
				$("#contractFeasorContent").find("select,input").attr("disabled","disabled");
				$("#contractFeasorToolbar,.feasorCheckbox").remove();
			}else{
				$("#contractFeasorToolbar").removeClass("hidden");
			};
		}
	}
	/*
	 * 显示选人modal，生成选人树
	 */
	function creatFeasorTree(){
		$("#feasorChecked").html("");
		$("#feasorTreeInput").val("");
		var performerType = $("#contractFeasorContent input[name='performerType']:checked").val();
		var documentHeight = $pageContent.height() - 240;
    	$("#feasorTreeCotent,#feasorChecked").css("height", documentHeight);
		initFeasorTree(performerType);
	}
	//生成树
    function initFeasorTree(performerType) {
    	if(performerType == 1){
    		performerType = 0;
    	}else if(performerType == 2){
    		performerType = 1;
    	}else{
    		return;
    	};
        //选择履行人ztree树配置
        var treeSetting = {
			async: {
				enable: true,
				url: serverPath + "contractType/listPerformer",
				type: "post",
				dataType: 'json',
				dataFilter: orgsfilter,
				autoParam: ["id=orgId","executorType"]
			},
			data: {
				simpleData: {
					enable: true,
					idKey: "id",
					pIdKey: "parentId"
				},
				key: {
					name: "name"
				}
			},
			view: {
				selectedMulti: false,
				//dblClickExpand: false
			},
			callback: {
				onAsyncError: onAsyncError,
				onDblClick: setInputInfo
			}
		};
		function orgsfilter(treeId, parentNode, responseData) {
			if(responseData.status == 1){
				var data = responseData.data;
				if(data){
					for(var i = 0; i < data.length; i++){
	        			if(data[i].orgType != ""){
	        				data[i].isParent = "true";
	        			};
	        			data[i].executorType = performerType;
		        	};
		        	return data;
				}else{
					return null;
				}
			}else{
				layer.msg(responseData.message);
				return null;
			}
		}
        // 获取第一层数据
        $.ajax({
	        url : serverPath + 'contractType/listPerformer',
	        type : "post",
	        data : {'orgId':'','executorType':performerType},
	        success : function(result) {
				if (result.status == 1) {
					$("#feasorModal").modal("show");
					var data = result.data;
		        	if (data != "") {
		        		for(var i = 0; i < data.length; i++){
		        			if(data[i].orgType != ""){
		        				data[i].isParent = "true";
		        			};
		        			data[i].executorType = performerType;
			        	};
		                if (feasorTree) {
		                    feasorTree.destroy();
		                }
		                feasorTree = $.fn.zTree.init($("#feasorTree"), treeSetting, data);
                 		//默认展开第一层
			            var nodes = feasorTree.getNodes();
			            feasorTree.expandNode(nodes[0]);
		            } else {
		                layer.msg("暂无数据，请稍后重试");
		            }
				} else {
					var ms = result.message;
					layer.msg(ms);
				};
	        },
	        error: function(result) {
				App.ajaxErrorCallback(result);
			}
	   	});
        function setInputInfo(event, treeId, treeNode) {
            getFirstDepartment(treeNode,1);
<<<<<<< HEAD
        }
    }
    /*
     * 后台查询一级部门名称和id
     */
    function getFirstDepartment(treeNode,type){
    	if (treeNode.orgType == "" || treeNode.orgType == undefined) {
    		var url = serverPath + "contractType/getPerformerBandOneOrg";
			var postData = JSON.stringify({orgId:treeNode.parentId});
    		App.formAjaxJson(url, "post", postData, successCallback);
			function successCallback(result) {
				var data = result.data;
				if(data){
					var parentId = data.orgId;
					var fullName =  data.orgName;
				}else{
					var parentId = treeNode.parentId;
					var fullName =  treeNode.fullName;
				};
				if(type == 1){
					addFeasorValue(treeNode,parentId,fullName);
				}else if(type ==2){
					addFeasorValueForInput(treeNode,parentId,fullName);
				}
    		};
        }
    }
    /*
     * 树添加到左侧
     */
=======
        }
    }
    /*
     * 后台查询一级部门名称和id
     */
    function getFirstDepartment(treeNode,type){
    	if (treeNode.orgType == "" || treeNode.orgType == undefined) {
    		var url = serverPath + "contractType/getPerformerBandOneOrg";
			var postData = JSON.stringify({orgId:treeNode.parentId});
    		App.formAjaxJson(url, "post", postData, successCallback);
			function successCallback(result) {
				var data = result.data;
				if(data){
					var parentId = data.orgId;
					var fullName =  data.orgName;
				}else{
					var parentId = treeNode.parentId;
					var fullName =  treeNode.fullName;
				};
				if(type == 1){
					addFeasorValue(treeNode,parentId,fullName);
				}else if(type ==2){
					addFeasorValueForInput(treeNode,parentId,fullName);
				}
    		};
        }
    }
    /*
     * 树添加到左侧
     */
>>>>>>> 8849b6a74eee5d557a8a4fd9b7c07aff7918007e
    function addFeasorValue(treeNode,parentId,fullName) {
    	var performerType = $("#contractFeasorContent input[name='performerType']:checked").val();
    	var performerOrgId = parentId;
    	var performerOrgName = fullName;
    	var performerStaffId = treeNode.staffOrgId;
        if(performerType == 1){
<<<<<<< HEAD
        	var html = '<div class="feasorItem" data-orgname="'+performerOrgName+'" data-orgid="'+performerOrgId+'" data-stafforgid="'+performerStaffId+'">'+
=======
        	var html = '<div class="checkedStaffItem" data-orgname="'+performerOrgName+'" data-orgid="'+performerOrgId+'" data-stafforgid="'+performerStaffId+'">'+
>>>>>>> 8849b6a74eee5d557a8a4fd9b7c07aff7918007e
        				'<span>'+treeNode.name+'</span>'+
        				'</div>'
        	$("#feasorChecked").html(html);
        }else if(performerType == 2){
        	var isExist = false;
        	var companyNode = getCompanyByOrgId(treeNode)[0];
        	var companyId = companyNode.id;
    		var companyName = companyNode.name;
<<<<<<< HEAD
        	$.each($("#feasorModal .feasorItem"),function(k,v){
=======
        	$.each($("#feasorChecked .checkedStaffItem"),function(k,v){
>>>>>>> 8849b6a74eee5d557a8a4fd9b7c07aff7918007e
        		if($(v).data("companyid") == companyId){
        			showLayerErrorMsg(companyName+"下只能选择一个主要履行人，请删除'"+$(v).text()+"'后再进行添加");
        			isExist = true;
        			return false;
        		}
        	});
        	if(!isExist){
<<<<<<< HEAD
        		var html = '<div class="feasorItem" data-companyname="'+companyName+'" data-companyid="'+companyId+'" data-orgname="'+performerOrgName+'" data-orgid="'+performerOrgId+'" data-stafforgid="'+performerStaffId+'">'+
=======
        		var html = '<div class="checkedStaffItem" data-companyname="'+companyName+'" data-companyid="'+companyId+'" data-orgname="'+performerOrgName+'" data-orgid="'+performerOrgId+'" data-stafforgid="'+performerStaffId+'">'+
>>>>>>> 8849b6a74eee5d557a8a4fd9b7c07aff7918007e
            				'<span>'+treeNode.name+'</span>'+
            				'</div>';
        		$("#feasorChecked").append(html);
        	};
        }
    }
    /*
     * 模糊搜索添加操作
     */
    function addFeasorValueForInput(item,parentId,fullName){
    	var performerType = $("#contractFeasorContent input[name='performerType']:checked").val();
    	var performerOrgId = parentId;
    	var performerOrgName = fullName;
    	var performerStaffId = item.staffOrgId;
        if(performerType == 1){
<<<<<<< HEAD
        	var html = '<div class="feasorItem" data-orgname="'+performerOrgName+'" data-orgid="'+performerOrgId+'" data-stafforgid="'+performerStaffId+'">'+
=======
        	var html = '<div class="checkedStaffItem" data-orgname="'+performerOrgName+'" data-orgid="'+performerOrgId+'" data-stafforgid="'+performerStaffId+'">'+
>>>>>>> 8849b6a74eee5d557a8a4fd9b7c07aff7918007e
        				'<span>'+item.name+'</span>'+
        				'</div>'
        	$("#feasorChecked").html(html);
        }else if(performerType == 2){
        	var isExist = false;
        	var companyId = item.companyId;
    		var companyName = item.companyName;
<<<<<<< HEAD
        	$.each($("#feasorModal .feasorItem"),function(k,v){
=======
        	$.each($("#feasorChecked .checkedStaffItem"),function(k,v){
>>>>>>> 8849b6a74eee5d557a8a4fd9b7c07aff7918007e
        		if($(v).data("companyid") == companyId){
        			showLayerErrorMsg(companyName+"下只能选择一个主要履行人，请删除'"+$(v).text()+"'后再进行添加");
        			isExist = true;
        			return false;
        		}
        	});
        	if(!isExist){
<<<<<<< HEAD
        		var html = '<div class="feasorItem" data-companyname="'+companyName+'" data-companyid="'+companyId+'" data-orgname="'+performerOrgName+'" data-orgid="'+performerOrgId+'" data-stafforgid="'+performerStaffId+'">'+
=======
        		var html = '<div class="checkedStaffItem" data-companyname="'+companyName+'" data-companyid="'+companyId+'" data-orgname="'+performerOrgName+'" data-orgid="'+performerOrgId+'" data-stafforgid="'+performerStaffId+'">'+
>>>>>>> 8849b6a74eee5d557a8a4fd9b7c07aff7918007e
            				'<span>'+item.name+'</span>'+
            				'</div>';
        		$("#feasorChecked").append(html);
        	};
        }
    }
    /*
     * 增加右侧内容
     */
    function setFeasorValue(){
    	var treeNode = feasorTree.getSelectedNodes()[0];
        if (treeNode == undefined) {
            layer.msg("请选择人员", {icon: 2})
        } else {
            getFirstDepartment(treeNode,1);
        }
    }
    /*
     * 删除右侧内容
     */
    function delFeasorValue(){
		if($("#feasorChecked .staffItemChecked").length == 0){
			layer.msg("请点击选择人员名称后进行删除", {icon: 2})
		}else{
			$.each($("#feasorChecked .staffItemChecked"), function(k,v) {
				$(v).parent().remove();
			});
		}
    }
    /*
     * modal确定按钮点击
     */
    function setFeasorTable(){
    	var performerType = $("#contractFeasorContent input[name='performerType']:checked").val();
    	$("#feasorModal").modal("hide");
    	if($("#feasorChecked .checkedStaffItem").length > 0){
    		if(performerType == 1){
    			if($("#feasorTbody .emptyTr")[0] != undefined){
					$("#feasorTbody .emptyTr").remove();
				};
				var html = "";
    			$.each($("#feasorChecked .checkedStaffItem"), function(k,v) {
    				var orgname = $(v).data("orgname");
    				var orgid = $(v).data("orgid");
    				var stafforgid = $(v).data("stafforgid");
    				var staffname = $(v).text();
    				html += '<tr data-id="100000" data-orgid="'+orgid+'" data-stafforgid="'+stafforgid+'">'+
    						'<td class="feasorCheckbox"><label class="ui-checkbox"><input type="checkbox" name="feasorCheck"><span></span></label></td>'+
    						'<td class="orderNumber"></td>'+
    						'<td>'+staffname+'</td>'+
    						'<td>'+orgname+'</td></tr>';
    			});
				if($("#feasorTbody tr").length > 0){
					layer.confirm("将删除原有的本级履行或上下级共同履行人，是否继续?",{icon:7,title:"提示"},function(index){
		    			layer.close(index);
		    			$("#feasorTbody").html(html);
		    			addFeasorTbodySort();
		    			App.checkAllFn("#feasorCheckAll","feasorCheck");
		    		});
				}else{
					$("#feasorTbody").html(html);
				};
	    	}else if(performerType == 2){
	    		if($("#feasorTbody .emptyTr")[0] != undefined){
					$("#feasorTbody .emptyTr").remove();
				};
    			$.each($("#feasorChecked .checkedStaffItem"), function(k,v) {
    				var companyid = $(v).data("companyid");
    				var companyName = $(v).data("companyname");
    				var staffname = $(v).text();
    				var isExist = false;
    				$.each($("#feasorTbody tr"),function(m,n){
						if(!$(n).hasClass("emptyTr")){
							var isExistCompanyid = $(n).data("companyid");
							if(isExistCompanyid == companyid){
								var isExistName = $(n).children().eq(2).text();
								showLayerErrorMsg(companyName+"下只能选择一个主要履行人，选择的'"+staffname+"'与'"+isExistName+"'重复,请删除后再进行添加");
		            			isExist = true;
		            			return false;
							}
						}
					});
    				if(!isExist){
    					var orgid = $(v).data("orgid");
	    				var stafforgid = $(v).data("stafforgid");
	    				var orgname = $(v).data("orgname");
	    				var html = '<tr data-id="100000" data-companyid="'+companyid+'" data-orgid="'+orgid+'" data-stafforgid="'+stafforgid+'">'+
	    						'<td class="feasorCheckbox"><label class="ui-checkbox"><input type="checkbox" name="feasorCheck"><span></span></label></td>'+
	    						'<td class="orderNumber"></td>'+
	    						'<td>'+staffname+'</td>'+
	    						'<td>'+orgname+'</td></tr>';
						$("#feasorTbody").append(html);
	    			};
    			});
    			addFeasorTbodySort();
    			App.checkAllFn("#feasorCheckAll","feasorCheck");
	    	}
    	}
    }
    /*
     * 获取最下级公司
     */
    function getCompanyByOrgId(treeNode){
    	var nodes = feasorTree.getNodeByParam("id", treeNode.parentId, null);
    	if(nodes.orgType == 1){
    		return [nodes,treeNode];
    	}else{
    		return getCompanyByOrgId(nodes);
    	}
    }
    
	$("#contractFeasorContent input[name='performerType']").on("change",function(){
		layer.confirm("如果改变履行方式，将删除所有已选的主要履行人！",{icon:7,title:"提示",closeBtn:0},function(index){
			layer.close(index);
			if($("#contractFeasorContent input[name='performerType']:checked").val() == 2){
				$("#feasorTbody").html("");
			}else{
				$("#feasorTbody").html(deafaultFeasorHtml);
			};
			App.checkAllFn("#feasorCheckAll","feasorCheck");
			addFeasorTbodyEmptyTr();
			addFeasorTbodySort()
		}, function(){
			var performerType = $("#contractFeasorContent input[name='performerType']:checked").val();
			if(performerType == 1){
				$("#contractFeasorContent input[name='performerType'][value=2]").prop("checked",true);
			}else{
				$("#contractFeasorContent input[name='performerType'][value=1]").prop("checked",true);
			}
		})
	});
	/*
	 * 删除履行人
	 */
	function delectFeasor(){
		var checkLength = $("#feasorTbody input[name='feasorCheck']:checked").length;
		if(checkLength == 0){
			layer.msg("请勾选履行人复选框进行删除")
		}else{
			layer.confirm("是否删除？",{icon:7,title:"删除"},function(index){
				layer.close(index);
				$("#feasorTbody input[name='feasorCheck']:checked").each(function(k,v){
					$(v).parents("tr").remove();
				});
				addFeasorTbodyEmptyTr();
				addFeasorTbodySort();
				App.checkAllFn("#feasorCheckAll","feasorCheck");
			})
		}
	};
	/*
	 * 若为空增加empty值
	 */
	function addFeasorTbodyEmptyTr(){
		if($("#feasorTbody tr").length == 0){
			var html = '<tr class="emptyTr"><td colspan="4">暂无履行人信息</td></tr>';
			$("#feasorTbody").html(html);
		}
	}
	/*
	 * 表格数据增加序号
	 */
	function addFeasorTbodySort(){
		$.each($("#feasorTbody .orderNumber"), function(k,v) {
			$(v).text(k+1);
		});
	}
	/*
	 * 人员选择点击	事件委托
	 */
	$("#feasorChecked").on("click","span",function(){
		if($(this).hasClass("staffItemChecked")){
			$(this).removeClass("staffItemChecked");
		}else{
			$(this).addClass("staffItemChecked");
		}
	})
</script>
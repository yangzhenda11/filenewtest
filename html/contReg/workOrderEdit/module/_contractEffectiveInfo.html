<div class="form-fieldset">
	<div class="form-fieldset-title">
		<span><i class="iconfont icon-layers"></i> 合同生效信息</span>
		<div class="form-fieldset-tools">
			<a class="form-collapse"><i class="fa fa-angle-up"></i></a>
		</div>
	</div>
	<div class="form-fieldset-body">
		<div class="row defaultFieldsetForm" id="validityForm">
			<div class="portlet" id="undertakerCommitmentContent">
                <div class="portlet-body form">
                    <p class="margin-top-10">承办人确认信息：</p>
					<div>
						<label class="ui-checkbox">
							<input type="checkbox" value="1" name="undertakerCommitment">
							<span></span>
							<i class="iconfont icon-mi required"></i>
							各方均已签字盖章，签字盖章的合同文本与系统内最终审批的合同文本一致。
						</label>
					</div>
            	</div>
       	    </div>
       	    <div class="portlet hidden" id="adminCommitmentContent">
                <div class="portlet-body form">
                    <p class="margin-top-10">合同管理员确认信息：</p>
					<div>
						<label class="ui-checkbox">
							<input type="checkbox" value="1" name="adminCommitment">
							<span></span>
							<i class="iconfont icon-mi required"></i>
							本人确认已收到经各方签字盖章完毕的纸质合同文本，并确认系统内的签订盖章日期与合同文本内的签订盖章日期一致。
						</label>
					</div>
            	</div>
       	    </div>
       	    <div class="portlet" id="payerAccountInfo">
                <div class="portlet-title ">
                    <div class="caption font-dark contract">
                        <span class="caption-subject bold uppercase">我方签订盖章日期信息</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <table class="table table-hover table-bordered table-striped table-align">
		            	<thead>
							<tr>
								<th style="width: 10%;">序号</th>
								<th style="width: 55%;">我方主体</th>
								<th style="width: 35%;"><i class="iconfont icon-mi required"></i>我方签订盖章日期</th>
							</tr>
						</thead>
						<tbody id="partyASignDateTbody">
							<tr class="emptyTr">
								<td colspan="3">暂无我方主体信息</td>
							</tr>
						</tbody>
					</table>
            	</div>
       	   	</div>
       	    <div class="portlet" id="payerAccountInfo">
                <div class="portlet-title ">
                    <div class="caption font-dark contract">
                        <span class="caption-subject bold uppercase">对方签订盖章日期信息</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <table class="table table-hover table-bordered table-striped table-align">
		            	<thead>
							<tr>
								<th style="width: 10%;">序号</th>
								<th style="width: 55%;">对方主体</th>
								<th style="width: 35%;"><i class="iconfont icon-mi required"></i>对方签订盖章日期</th>
							</tr>
						</thead>
						<tbody id="partyZSignDateTbody">
							<tr class="emptyTr">
								<td colspan="3">暂无对方主体信息</td>
							</tr>
						</tbody>
					</table>
            	</div>
       	   	</div>
			<div id="validityConForm">
				<input type="hidden" name="validityId" id="validityId" value="100000" />
				<div class="col-sm-6 form-group">
					<label for="periodType" class="control-label"><i class="iconfont icon-mi required"></i>合同有效期确认方式：</label>
					<div class="valiParent">
						<select class="form-control select2me" data-placeholder='请选择合同有效期确认方式' data-allowClear="false" name="periodType" id="periodType">
							<option value="905010">固定起止日期</option>
							<option value="905020">按条件约定合同生效日期，期限固定</option>
							<option value="905030">按条件约定合同生效日期，期限不固定</option>
						</select>
					</div>
				</div>
				<div class="col-sm-6 form-group" id="isPostponableDom">
					<label for="isPostponable" class="control-label"><i class="iconfont icon-mi required"></i>是否顺延：</label>
					<div class="valiParent">
						<div class="ui-radio-list ui-radio-inline">
							<label class="ui-radio">
								是
								<input type="radio" value="1" name="isPostponable">
								<span></span>
							</label>
							<label class="ui-radio">
								否
								<input type="radio" value="0" checked="checked" name="isPostponable">
								<span></span>
							</label>
						</div>
					</div>
				</div>
				<div id="postponableValidator">
					<div class="col-sm-6 form-group hidden" id="effectiveDateDiv">
						<label for="effectiveDate" class="control-label"><i class="iconfont icon-mi required"></i>生效日期：</label>
						<div class="valiParent">
							<input type="text" name="effectiveDate" id="effectiveDate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',onpicked:function(){dataChangeEvent(this)}})" class="form-control" readonly="readonly" />
						</div>
					</div>
					<div class="col-sm-6 form-group hidden" id="expiryDateDiv">
						<label for="expiryDate" class="control-label"><i class="iconfont icon-mi required"></i>终止日期：</label>
						<div class="valiParent">
							<input type="text" name="expiryDate" id="expiryDate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',onpicked:function(){dataChangeEvent(this)}})" class="form-control" readonly="readonly" />
						</div>
					</div>
					<div class="col-sm-6 form-group hidden" id="effectConditionDiv">
						<label for="effectCondition" class="control-label"><i class="iconfont icon-mi required"></i>生效条件：</label>
						<div class="valiParent">
							<input type="text" class="form-control" id="effectCondition" name="effectCondition" maxlength="2000" />
						</div>
					</div>
					<div class="col-sm-6 form-group hidden" id="effectPeriodDiv">
						<label for="effectPeriod" class="control-label"><i class="iconfont icon-mi required"></i>协议期限：</label>
						<div class="valiParent">
							<input type="text" class="form-control" id="effectPeriod" name="effectPeriod" maxlength="2000" />
						</div>
					</div>
					<div class="col-sm-6 form-group hidden" id="postponeConditionDiv">
						<label for="postponeCondition" class="control-label"><i class="iconfont icon-mi required"></i>顺延条件：</label>
						<div class="valiParent">
							<input type="text" class="form-control" id="postponeCondition" name="postponeCondition" maxlength="2000" />
						</div>
					</div>
					<div class="col-sm-6 form-group hidden" id="postponePeriodDiv">
						<label for="postponePeriod" class="control-label"><i class="iconfont icon-mi required"></i>顺延时限：</label>
						<div class="valiParent">
							<input type="text" class="form-control" id="postponePeriod" name="postponePeriod" maxlength="2000" />
						</div>
					</div>
					<div class="col-sm-6 form-group hidden" id="expiryConditionDiv">
						<label for="expiryCondition" class="control-label"><i class="iconfont icon-mi required"></i>满足终止：</label>
						<div class="valiParent">
							<input type="text" class="form-control" id="expiryCondition" name="expiryCondition" maxlength="2000" />
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	/*
	 * 2阶段，更新终止日期
	 */
	function changeExpiryDate(){
		layer.confirm("请确认是否更新？",{icon:7,title:"系统提示"},function(index){
			layer.close(index);
			if(checkWcardIschange() == false){
				var postData = App.getFlowParam(serverPath,wcardId,1,0,"Contract_end_update",contractAttr.provinceCode,contractAttr.city,"","","");
				postData.validity = {};
				postData.validity.validityId = $("#validityId").val();
				postData.wcardId = wcardId;
				postData.validity.expiryDate = $("#expiryDate").val();
				var url = serverPath + "contractOrderEditorController/updateExpiryDate";
				App.formAjaxJson(url, "POST", JSON.stringify(postData), successCallback);
				function successCallback(result) {
					layer.alert("更新成功！",{icon:1},function(){
						backPage();
					});
				}
			}
			
		});
	}
	/*
	 * 设置页面的id值，由保存和提交后回调
	 */
	function setPageId_validityId(value){
		$("#validityId").val(value);
	}

	/*
	 * 返回本页面数据，若无返回{}，若不提交本页面的值可删除此方法
	 * isSubmit 提交时为true,判断页面是否要加逻辑上的验证(bootstrap-validator验证除外)
	 */
	function getValue_validity(isSubmit){
		var validityData = App.getFormValues($("#validityConForm"));
		var undertakerCommitmentValue = $("#undertakerCommitmentContent input[name='undertakerCommitment']:checked").val();
		var adminCommitmentValue = $("#adminCommitmentContent input[name='adminCommitment']:checked").val();
		validityData.wcardId = wcardId;
		validityData.contractNumber = contractNumber;
		if(undertakerCommitmentValue == 1){
			validityData.undertakerCommitment = 1;
		}else{
			validityData.undertakerCommitment = 0;
		};
		if(adminCommitmentValue == 1){
			validityData.adminCommitment = 1;
		}else{
			validityData.adminCommitment = 0;
		};
		var stampedInfoOurList = [];
		$.each($("#partyASignDateTbody tr"),function(k,v){
			if(!$(v).hasClass("emptyTr")){
				var dataItem = {};
				dataItem.stampedId = $(v).data("id");
				dataItem.stampedDate = $(v).find(".stampedDate").val();
				stampedInfoOurList.push(dataItem);
			}
		});
		validityData.stampedInfoOurList = stampedInfoOurList;
		var stampedInfoOtherList = [];
		$.each($("#partyZSignDateTbody tr"),function(k,v){
			if(!$(v).hasClass("emptyTr")){
				var dataItem = {};
				dataItem.stampedId = $(v).data("id");
				dataItem.stampedDate = $(v).find(".stampedDate").val();
				stampedInfoOtherList.push(dataItem);
			}
		});
		validityData.stampedInfoOtherList = stampedInfoOtherList;
		if(validityData.periodType == "905010"){
			var effectiveDate = validityData.effectiveDate;
			var expiryDate = validityData.expiryDate;
			if(effectiveDate && expiryDate){
				if(!App.checkDate(effectiveDate,expiryDate)){
					showLayerErrorMsg("合同生效信息中，生效日期不能早于终止日期");
					srolloOffect("#undertakerCommitmentContent",3);
					return false;
				}
			}
		};
		if(wcardTypeCode == 2){
			validityData.isPostponable = "";
		};
		if(isSubmit && validityData.undertakerCommitment == 0){
			layer.msg("请勾选承办人确认信息!");
			srolloOffect("#undertakerCommitmentContent");
			return false;
		}else{
			return validityData;
		}
	}
	/*
	 * 日期修改时监听事件
	 */
	function dataChangeEvent(dom){
		var effectiveDate = $("#effectiveDate").val();
		var expiryDate = $("#expiryDate").val();
		if(!App.checkDate(effectiveDate,expiryDate)){
			$(dom).val("");
			layer.msg("终止日期不能早于生效日期");
		}
	}
	/*
	 * 必填校验
	 */
	addNotEmptyValidatorField("effectiveDate","生效日期不能为空");
	addNotEmptyValidatorField("expiryDate","终止日期不能为空");
	addNotEmptyValidatorField("effectCondition","请输入不超过2000个字符的生效条件");
	addNotEmptyValidatorField("effectPeriod","请输入不超过2000个字符的协议期限");
	addNotEmptyValidatorField("postponeCondition","请输入不超过2000个字符的顺延条件");
	addNotEmptyValidatorField("postponePeriod","请输入不超过2000个字符的顺延时限");
	addNotEmptyValidatorField("expiryCondition","请输入不超过2000个字符的满足终止条件");
	//设置默认展示方式
	if(wcardTypeCode == 2){
		$("#isPostponableDom").css("visibility","hidden");
	}
	changePostponableValidatorStatus(905010,0);
	//获取合同生效信息
	getvalidityData();
	/*
	 * 获取合同生效信息
	 */
	function getvalidityData(){
		var url = serverPath + "contractOrderEditorController/getValidityId";
		var postData = JSON.stringify({wcardId:wcardId});
		App.formAjaxJson(url, "post", postData, successCallback);
		function successCallback(result) {
			var data = result.data;
			var tRContractValidityVo = data.tRContractValidityVo;
			initPartySignDate(data.stampedInfoOurList,"partyASignDate");
			initPartySignDate(data.stampedInfoOtherList,"partyZSignDate");
			if(tRContractValidityVo){
				if(wcardTypeCode == 2){
					tRContractValidityVo.isPostponable = "0";
				};
				changePostponableValidatorStatus(tRContractValidityVo.periodType,tRContractValidityVo.isPostponable);
				if(tRContractValidityVo.undertakerCommitment == 1){
					$("#undertakerCommitmentContent input[name='undertakerCommitment']").attr("checked",true);
				};
				if(tRContractValidityVo.adminCommitment == 1){
					$("#adminCommitmentContent input[name='adminCommitment']").attr("checked",true);
				};
				App.setFormValues("#validityConForm",tRContractValidityVo);
				if($("#adminCommitmentContent input[name='adminCommitment']:checked").val()){
					if(parm.taskDefinitionKey == "GDQR" && parm.taskFlag == "yb"){
						$("#adminCommitmentContent").removeClass("hidden");
					}
				}
			};
			/*
			 * isEdit 判断页面是否只能查看
			 * 逻辑1.当为工单确认为待办时显示
			 * 2.当为工单确认为已办时 勾选时显示
			 */
			if(!isEdit){
				$("#validityForm").find("input,select").attr("disabled","disabled");
				$("#effectiveDate,#expiryDate").css({"cursor":"not-allowed","background-color":"#f5f5f5"})
				if(App.IEVersionVA(11)){
					App.initFormSelect2("#validityForm",true);
				}
			};
			if(editIdentify.isCanUpdateExpiryDate){
				$("#expiryDate").removeAttr("disabled");
				$("#expiryDate").css({"cursor":"pointer","background-color":"#fff"})
			}
			if(parm.taskDefinitionKey == "GDQR" && parm.taskFlag == "db"){
				$("#adminCommitmentContent").removeClass("hidden");
				if(fileUploadEdit == true){
					$("#adminCommitmentContent input[name='adminCommitment']").attr("disabled",false);
				}
			}
			/*
			 * 选择触发input框改变
			 */
			$("#periodType").on("change",function(){
				if($(this).val() == "905030"){
					$("#validityConForm input[name='isPostponable'][value=0]").prop("checked",true);
				};
				var selectValue = $(this).val();
				var checkValue = $("#validityConForm input[name='isPostponable']:checked").val();
				changePostponableValidatorStatus(selectValue,checkValue);
				resetEffectiveValidator();
			});
			$("#validityConForm input[name='isPostponable']").on("change",function(){
				var selectValue = $("#periodType").val();
				var checkValue = $(this).val();
				changePostponableValidatorStatus(selectValue,checkValue);
				resetEffectiveValidator();
			});
		}
	}
	/*
	 * 生成我方对方签订盖章日期表格
	 */
	var partySignDateLength = 0;		//自增主键
	function initPartySignDate(data,type){
		if(data == "" || data == null || data.length == 0){
			return;
		};
		if(type == "partyASignDate"){
			if($("#partyASignDateTbody .emptyTr")[0] != undefined){
				$("#partyASignDateTbody .emptyTr").remove();
			};
		}else{
			if($("#partyZSignDateTbody .emptyTr")[0] != undefined){
				$("#partyZSignDateTbody .emptyTr").remove();
			};
		};
		var partySignHtml = "";
		var partySignDateList = [];
		for(var k = 0; k < data.length;k++){
			partySignDateLength++;
			var partySignDate = "partySignDate" + partySignDateLength;
			partySignDateList.push(partySignDate)
			var stampedDate = data[k].stampedDate == null || data[k].stampedDate == "" ? "" : data[k].stampedDate;
			partySignHtml += '<tr data-id="'+ data[k].stampedId +'">'+
							'<td>'+ (k+1) +'</td>'+
							'<td>'+ data[k].partyName +'</td>'+
							'<td class="dataInputGroup"><div class="input-group form-group mar0pad15"><input type="text" id="'+partySignDate+'" name="'+partySignDate+'" value="'+ stampedDate +'" onclick="WdatePicker({dateFmt:\'yyyy-MM-dd\'})" class="form-control stampedDate" readonly="readonly" /><span class="input-group-addon" onclick="WdatePicker({el:\''+partySignDate+'\'})"><i class="iconfont icon-calendar"></i></span></div></td>'+
						'</tr>';
		}
		if(type == "partyASignDate"){
			$("#partyASignDateTbody").html(partySignHtml);
			var validatorMs = "请选择我方签订盖章日期";
		}else{
			$("#partyZSignDateTbody").html(partySignHtml);
			var validatorMs = "请选择对方签订盖章日期";
		}
		for(var m = 0; m < partySignDateList.length; m++){
			addNotEmptyValidatorField(partySignDateList[m],validatorMs);
		};
	}
	
	/*
	 * 选择时重置验证
	 */
	function resetEffectiveValidator(){
		$workOrderContentForm.data("bootstrapValidator").updateStatus("effectiveDate", "NOT_VALIDATED", null );
		$workOrderContentForm.data("bootstrapValidator").updateStatus("expiryDate", "NOT_VALIDATED", null );
		$workOrderContentForm.data("bootstrapValidator").updateStatus("effectCondition", "NOT_VALIDATED", null );
		$workOrderContentForm.data("bootstrapValidator").updateStatus("effectPeriod", "NOT_VALIDATED", null );
		$workOrderContentForm.data("bootstrapValidator").updateStatus("postponeCondition", "NOT_VALIDATED", null );
		$workOrderContentForm.data("bootstrapValidator").updateStatus("postponePeriod", "NOT_VALIDATED", null );
		$workOrderContentForm.data("bootstrapValidator").updateStatus("expiryCondition", "NOT_VALIDATED", null );
	}
	/*
	 *	有效期和是否顺延现实和隐藏
	 */
	function changePostponableValidatorStatus(selectValue,checkValue){
		$("#postponableValidator .form-group").addClass("hidden");
		App.enableFieldValidators('#workOrderContentForm',["effectiveDate","expiryDate","effectPeriod","postponeCondition","postponePeriod","effectCondition","expiryCondition"],false);
		$("#postponableValidator input").val("");
		if(selectValue == "905030"){
			$("input[name='isPostponable'][value=1]").prop("disabled",true);
		}else{
			$("input[name='isPostponable'][value=1]").prop("disabled",false);
		};
		if(selectValue == "905010" && checkValue == "1"){
			App.enableFieldValidators('#workOrderContentForm',["effectiveDate","expiryDate","postponeCondition","postponePeriod"],true);
			$("#effectiveDateDiv,#expiryDateDiv,#postponeConditionDiv,#postponePeriodDiv").removeClass("hidden");
		}else if(selectValue == "905010" && checkValue == "0"){
			App.enableFieldValidators('#workOrderContentForm',["effectiveDate","expiryDate"],true);
			$("#effectiveDateDiv,#expiryDateDiv").removeClass("hidden");
		}else if(selectValue == "905020" && checkValue == "1"){
			App.enableFieldValidators('#workOrderContentForm',["effectCondition","effectPeriod","postponeCondition","postponePeriod"],true);
			$("#effectConditionDiv,#effectPeriodDiv,#postponeConditionDiv,#postponePeriodDiv").removeClass("hidden");
		}else if(selectValue == "905020" && checkValue == "0"){
			App.enableFieldValidators('#workOrderContentForm',["effectCondition","effectPeriod"],true);
			$("#effectConditionDiv,#effectPeriodDiv").removeClass("hidden");
		}else if(selectValue == "905030" && checkValue == "0"){
			App.enableFieldValidators('#workOrderContentForm',["effectCondition","expiryCondition"],true);
			$("#effectConditionDiv,#expiryConditionDiv").removeClass("hidden");
		};
	}
</script>
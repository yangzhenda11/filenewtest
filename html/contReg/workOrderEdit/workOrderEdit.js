function beforePushProcess(t){var e=!0,r=0;if(!formSubmit)return showLayerErrorMsg("页面加载失败"),!1;if(checkWcardProcessIschange())return!1;if(checkContractStatus())return!1;removeMoreThanTablecontent();var a=checkDomOverlength();if(a)return!1;var o=$("#workOrderContentForm").data("bootstrapValidator");if(o.validate(),!o.isValid())return showLayerErrorMsg("当前工单表单校验未通过，请检查"),srolloOffect($("#workOrderContentForm").find(".has-error")[0],1),!1;var n=getContentValue(!0);if(!n)return!1;if($("#contractScanCopyUpload")[0]&&1==t&&!n.contractScanCopyUpload.bodyDoc.bodyDocStoreId){if("GDQR"==parm.taskDefinitionKey)var c="请上传合同正文扫描件后进行工单激活";else var c="请上传合同正文扫描件后进行工单注册";return showLayerErrorMsg(c),srolloOffect("#contractScanCopyUpload"),!1}if("GDQR"==parm.taskDefinitionKey&&1==t){var s=$("input[name='adminCommitment']:checked").val();if(null==s)return showLayerErrorMsg("请勾选合同管理员确认信息"),srolloOffect("#adminCommitmentContent"),!1}var i={prov:"sd"};return parent.setAssigneeParam(i),parent.setPathSelect(r),e}function modal_pass(t,e,r,a,o,n,c,s){function i(t){var e=t.data;"000"==e.success?showLayerErrorMsg(e.message):parent.layer.alert("注册成功！",{icon:1},function(){parent.modal_close()})}function d(t){showLayerErrorMsg(t.message)}function i(t){t.data;parent.layer.alert("退回成功！",{icon:1},function(){parent.modal_close()})}function d(t){showLayerErrorMsg(t.message)}var l={processInstanceId:a,taskId:o,taskDefinitionKey:e,assignee:r,comment:n,handleType:c,withdraw:s,title:""};if(1==c&&"GDCL"==parm.taskDefinitionKey){var p=getContentValue(!0);l=$.extend(l,p),l.wcardId=wcardId,l.wcardType=wcardTypeCode,l.contractName=$("#contractName").val(),App.formAjaxJson(serverPath+"contractOrderEditorController/saveOrderEditorProcess","post",JSON.stringify(l),i,d)}else if(2==c&&"GDQR"==parm.taskDefinitionKey){var f=$("#comment",parent.document).val();l.pinfoContent=f,l.busiId=wcardId,App.formAjaxJson(serverPath+"contractOrderEditorController/saveOrderFallbackProcess","post",JSON.stringify(l),i,d)}else 1==c&&"GDQR"==parm.taskDefinitionKey&&parent.layer.confirm("注意：合同激活后将进入履行阶段。",{icon:7,title:"提示"},function(t){function e(t){t.data;parent.layer.alert("激活成功！",{icon:1},function(){parent.modal_close()})}function r(t){showLayerErrorMsg(t.message)}parent.layer.close(t),l.validity={},$("#contractScanCopyUpload")[0]&&(l.contractScanCopyUpload=getValue_contractScanCopyUpload(!0)),l.validity.adminCommitment=1,l.validity.validityId=$("#validityId").val(),l.wcardId=wcardId,l.contractId=contractId,App.formAjaxJson(serverPath+"contractOrderEditorController/saveOrderApprovalProcess","post",JSON.stringify(l),e,r)})}function modal_passQxsp(t){if(!formSubmit)return showLayerErrorMsg("页面加载失败"),!1;if(checkContractStatus())return!1;if(t)var e=t;else var e={};parent.layer.confirm("请确认是否取消该工单的审批。",{icon:7,title:"提示"},function(t){function r(){parent.layer.alert("取消成功。",{icon:1},function(){parent.modal_close()})}function a(t){showLayerErrorMsg(t.message)}parent.layer.close(t),e.wcardId=wcardId,App.formAjaxJson(serverPath+"contractOrderEditorController/saveOrderCancelApprovalProcess","post",JSON.stringify(e),r,a)})}function modal_save(){return formSubmit?checkWcardProcessIschange()?!1:checkContractStatus()?!1:void saveContent():(showLayerErrorMsg("页面加载失败"),!1)}function modal_return(t,e,r){function a(){parent.layer.alert("工单撤回成功",{icon:1},function(){parent.modal_close()})}if(!formSubmit)return showLayerErrorMsg("页面加载失败"),!1;if(checkWcardProcessIschange())return!1;if(checkContractStatus())return!1;var o={processInstanceId:e,taskId:r,wcardId:wcardId};App.formAjaxJson(serverPath+"contractOrderEditorController/saveOrderWithdrawProcess","post",JSON.stringify(o),a)}function saveBtnClick(){return formSubmit?checkWcardProcessIschange()?!1:checkContractStatus()?!1:void saveContent():(showLayerErrorMsg("页面加载失败"),!1)}function submitContent(){if(!formSubmit)return showLayerErrorMsg("页面加载失败"),!1;if(checkWcardProcessIschange())return!1;if(checkContractStatus())return!1;removeMoreThanTablecontent();var t=checkDomOverlength();if(t)return!1;var e=$("#workOrderContentForm").data("bootstrapValidator");if(e.validate(),!e.isValid())return showLayerErrorMsg("当前工单表单校验未通过，请检查"),srolloOffect($("#workOrderContentForm").find(".has-error")[0],1),!1;var r=getContentValue(!0);if(r){if($("#contractScanCopyUpload")[0]&&!r.contractScanCopyUpload.bodyDoc.bodyDocStoreId)return showLayerErrorMsg("请上传合同正文扫描件后进行工单注册"),srolloOffect("#contractScanCopyUpload"),!1;var a="Contractproject2Process",o="GDQR",n="sd",c="submitContentPost",s=1;jandyStaffSearch(a,o,n,c,s)}}function submitContentPost(t,e,r,a,o){function n(t){var e=t.data;"000"==e.success?showLayerErrorMsg(e.message):layer.alert("注册成功！",{icon:1},function(){backPage()})}if(checkWcardProcessIschange())return!1;var c=App.getFlowParam(serverPath,parm.wcardId,1,0);c.assignee=o,c.wcardId=wcardId,c.wcardType=wcardTypeCode,c.contractName=$("#contractName").val();var s=getContentValue(!0);c=$.extend(c,s),$("#PandJstaffiframetask").modal("hide"),App.formAjaxJson(serverPath+"contractOrderEditorController/saveOrderEditorProcess","post",JSON.stringify(c),n)}function jandyStaffSearch(t,e,r,a,o){var n="/html/workflow/assignee/assgigneeList.html?"+App.timestamp();$("#PandJstaffiframetask").load(n,function(){$("#PandJstaffiframetask").modal("show"),setParam(t,e,r,a,o),$("#PandJstaffiframetask").off("shown.bs.modal").on("shown.bs.modal",function(){App.initDataTables("#searchStaffTable","#searchEforgHome",dataTableConfig),$(".checkall").click(function(){var t=$(this).prop("checked");$(".checkchild").prop("checked",t)})})})}function activateContract(){if(!formSubmit)return showLayerErrorMsg("页面加载失败"),!1;if(checkWcardProcessIschange())return!1;if(checkContractStatus())return!1;if($("#contractScanCopyUpload")[0]){var t=getValue_contractScanCopyUpload(!0);if(!t.bodyDoc.bodyDocStoreId)return showLayerErrorMsg("请上传合同正文扫描件后进行工单激活"),srolloOffect("#contractScanCopyUpload"),!1}var e=$("input[name='adminCommitment']:checked").val();if(1==e)var r=1;else var r=0;return 0==r?(showLayerErrorMsg("请勾选合同管理员确认信息"),srolloOffect("#adminCommitmentContent"),!1):void layer.confirm("注意：合同激活后将进入履行阶段。",{icon:7,title:"提示"},function(t){function e(t){t.data;layer.alert("激活成功！",{icon:1},function(){backPage()})}layer.close(t);var a=App.getFlowParam(serverPath,parm.wcardId,1,0);a.validity={},$("#contractScanCopyUpload")[0]&&(a.contractScanCopyUpload=getValue_contractScanCopyUpload(!0)),a.validity.adminCommitment=r,a.validity.validityId=$("#validityId").val(),a.wcardId=wcardId,a.contractId=contractId,App.formAjaxJson(serverPath+"contractOrderEditorController/saveOrderApprovalProcess","post",JSON.stringify(a),e)})}function cancelApproved(){return formSubmit?checkWcardProcessIschange()?!1:checkContractStatus()?!1:void layer.confirm("请确认是否取消该工单的审批。",{icon:7,title:"提示"},function(t){function e(){layer.alert("取消成功。",{icon:1},function(t){layer.close(t),window.location.reload()})}layer.close(t);var r=App.getFlowParam(serverPath,parm.wcardId,8,1);r.wcardId=wcardId,App.formAjaxJson(serverPath+"contractOrderEditorController/saveOrderCancelApprovalProcess","post",JSON.stringify(r),e)}):(showLayerErrorMsg("页面加载失败"),!1)}function sendBack(){return formSubmit?checkWcardProcessIschange()?!1:checkContractStatus()?!1:void $("#pinfoContentModal").modal("show"):(showLayerErrorMsg("页面加载失败"),!1)}function setPinfoContent(){function t(t){t.data;layer.alert("退回成功！",{icon:1},function(){backPage()})}var e=$("#pinfoContent").val();if(""==e)layer.msg("请输入退回原因",{offset:"130px"});else{var r=App.getFlowParam(serverPath,parm.wcardId,2,0);r.pinfoContent=e,r.busiId=wcardId,App.formAjaxJson(serverPath+"contractOrderEditorController/saveOrderFallbackProcess","post",JSON.stringify(r),t)}}function checkContractStatus(){return null==contractStatus?(showLayerErrorMsg("当前合同状态未知，请稍后操作"),!0):2==contractStatus?(showLayerErrorMsg('当前合同处于"作废"状态，不能进行下一步操作'),!0):3==contractStatus?(showLayerErrorMsg('当前合同处于"作废申请中"状态，不能进行下一步操作'),!0):!1}function checkWcardProcessIschange(){function t(t){var r=t.data;r!=wcardProcess?(1==parm.pageType?parent.layer.alert("当前工单的状态已经发生变化，请您关闭当前页面，点击查询更新数据后处理。",{icon:2,title:"流程状态错误",closeBtn:0},function(){parent.modal_close()}):layer.alert("当前工单的状态已经发生变化，请您关闭当前页面，点击查询更新数据后处理。",{icon:2,title:"流程状态错误",closeBtn:0},function(){backPage()}),e=!0):e=!1}var e=null;return App.formAjaxJson(serverPath+"contractOrderEditorController/getWcardProcessId","get",{wcardId:wcardId},t,null,null,null,!1),e}function getWorkOrderInfo(){function t(t){function e(t){if(getContractOrderBaseInfoData=t,contractStatus=t.data.contractStatus,1==contractStatus)setDomContent(o);else{if(isEdit=!1,fileUploadEdit=!1,2==contractStatus)var e='当前合同处于"作废"状态，不能进行操作';else if(3==contractStatus)var e='当前合同处于"作废申请中"状态，请稍后操作';else if(8==contractStatus)var e='当前合同处于"履行中"状态，不能操作';else if(null==contractStatus)var e="当前合同状态未知，请稍后操作";1==parm.pageType&&"db"==parm.taskFlag?parent.layer.alert(e,{icon:2,title:"合同状态错误",closeBtn:0},function(t){parent.layer.close(t),setDomContent(o)}):2==parm.pageType?layer.alert(e,{icon:2,title:"合同状态错误",closeBtn:0},function(t){layer.close(t),setDomContent(o)}):setDomContent(o)}}var r=t.data,a="未知类型";if(r.length>0){var o=[];contractId=r[0].contractId,contractNumber=r[0].contractNumber,wcardTypeCode=r[0].wcardTypeCode,wcardProcess=r[0].wcardProcess,1==isEdit&&2==wcardProcess&&904020==r[0].wcardStatus?(isCancelApproved=!0,1==parm.pageType&&parent.setQxspButton(!0,parm.businessKey),2==parm.pageType&&$("#cancelApprovedBtn").removeClass("hidden")):$("#cancelApprovedBtn").remove(),1==wcardTypeCode?a="收入类-租线合同":2==wcardTypeCode?a="支出类-采购合同":0==wcardTypeCode&&(a="其他");for(var n=0;n<r.length;n++){var c={key:r[n].domainEntityName,value:r[n].domainUrl};o.push(c)}var s=JSON.stringify({wcardId:wcardId,wcardType:wcardTypeCode});App.formAjaxJson(serverPath+"contractOrderEditorController/getContractOrderBaseInfoId","post",s,e)}else showLayerErrorMsg("当前工单暂无信息");$(".wcardType").text(a)}App.formAjaxJson(serverPath+"contractOrderEditorController/listDomainInfo","post",JSON.stringify({wcardId:wcardId}),t)}function checkWcardProcessId(){var t=!1;if("db"==parm.taskFlag){var e=parm.taskDefinitionKey;"GDCL"==e?(0==wcardProcess||2==wcardProcess)&&(t=!0):"GDQR"==e&&1==wcardProcess&&(t=!0)}else t=!0;t||(isEdit=!1,fileUploadEdit=!1,1==parm.pageType?parent.layer.alert("当前工单的状态已经发生变化，请您关闭当前页面，点击查询更新数据后处理。",{icon:2,title:"流程状态错误",closeBtn:0},function(t){layer.close(t),parent.modal_close()}):layer.alert("当前工单的状态已经发生变化，请您关闭当前页面，点击查询更新数据后处理。",{icon:2,title:"流程状态错误",closeBtn:0},function(t){layer.close(t),backPage()}))}function setDomContent(t){for(var e=0,r=t.length,a=0;a<t.length;a++){var o=t[a].key,n=t[a].value,c='<div id="'+o+'" class="form-wrapper" data-target="'+o+'"></div>';$("#workOrderContent").append(c),$("#"+o).load(n+"?"+App.timestamp(),function(){e++,e==r&&loadComplete()})}}function loadComplete(){formSubmit=!0,App.init(),validate(),getBusiProcessInfoID(),setSpeedyJump(),$("#workOrderContentForm").on("blur","input,textarea",function(){checkMaxLength(this)}),checkWcardProcessId()}function getBusiProcessInfoID(){function t(t){var e=t.data;if(e.length>0){for(var r="",a=0,o=e.length-1;o>=0;o--){a++;var n=null==e[o].createdName?"":e[o].createdName;r+=1==e[o].createdType?"取消审批"==e[o].pinfoContent?"<p>【"+a+"】  合同承办人-"+n+"  取消审批  ("+e[o].ctreatedDate+")</p>":"<p>【"+a+"】  合同承办人-"+n+"  申报意见："+e[o].pinfoContent+"  ("+e[o].ctreatedDate+")</p>":"<p>【"+a+"】  合同管理员-"+n+"  审核意见："+e[o].pinfoContent+"  ("+e[o].ctreatedDate+")</p>"}var c='<div class="form-fieldset"><div class="form-fieldset-title"><span><i class="iconfont icon-layers"></i> 工单处理意见</span><div class="form-fieldset-tools"></div></div><div class="form-fieldset-body"><div class="row">'+r+"</div></div></div>";isCancelApproved&&"db"==parm.taskFlag?$("#workOrderContent").prepend(c):$("#workOrderContent").append(c)}}var e=serverPath+"contractOrderEditorController/getBusiProcessInfoID";App.formAjaxJson(e,"get",{wcardId:wcardId},t)}function srolloOffect(t,e){var r=200;if(1==e){if($(t).parents("#incomeLinerentTbody")[0]){var a=$(t).offset().left-$(".page-content").width()+500;a>0&&$("#incomeLinerentTableContent").scrollLeft(a)}}else 2==e&&(r=1==parm.pageType?0:50);var o=$(".page-content").scrollTop(),n=o+$(t).offset().top-r;$(".page-content").animate({scrollTop:n},300)}function showLayerErrorMsg(t,e){e?1==parm.pageType?parent.layer.alert(t,{icon:2,title:"错误"}):layer.alert(t,{icon:2,title:"错误"}):1==parm.pageType?parent.layer.msg(t):layer.msg(t)}function setSpeedyJump(){var t=titleIconList[wcardTypeCode],e="";$.each(t,function(t,r){$(r.jumpId)[0]&&(e+="<li onclick=\"srolloOffect('"+r.jumpId+'\',2)" data-placement="left" data-trigger="hover" data-toggle="tooltip" data-container="body" title="'+r.title+'"><i class="iconfont '+r.icon+'"></i></li>')}),$("#workOrderMenu").html(e),$("#workOrderMenu [data-toggle='tooltip']").tooltip()}function setRequiredIcon(){if(0!=wcardTypeCode){var t=$("input[name='isFixed']:checked").val();1==t&&$(".isRequiredIcon").each(function(){var t='<i class="iconfont icon-mi required"></i>'+$(this).text();$(this).html(t)})}}function getContentValue(isSubmit){var submitData={},isPass=!0;return $(".form-wrapper").each(function(index,wrapperItem){var targetObj=$(wrapperItem).data("target");if(!App.isExitsFunction("getValue_"+targetObj))return!0;var itemFn=eval("getValue_"+targetObj),itemValue=itemFn(isSubmit);return itemValue?void(submitData[targetObj]=itemValue):(isPass=!1,!1)}),isPass?(submitData.wcardId=wcardId,submitData):!1}function removeMoreThanTablecontent(){$(".form-wrapper").each(function(index,wrapperItem){var targetObj=$(wrapperItem).data("target");if(!App.isExitsFunction("removeMorethan_"+targetObj))return!0;var itemFn=eval("removeMorethan_"+targetObj);itemFn()})}function saveContent(){if("GDQR"==parm.taskDefinitionKey){var t={},e=$("input[name='adminCommitment']:checked").val();e||(e=0),t.wcardId=wcardId,t.validity={},t.validity.adminCommitment=e,t.validity.validityId=$("#validityId").val(),t.validity.contractNumber=contractNumber,$("#contractScanCopyUpload")[0]&&(t.contractScanCopyUpload=getValue_contractScanCopyUpload()),saveContentPost(t,"GDQR")}else{removeMoreThanTablecontent();var r=checkDomOverlength();if(r)return!1;var t=getContentValue();t&&saveContentPost(t,"GDCL")}}function saveContentPost(t,e){function r(t){var e=t.data;setPageIdCallback(e),layer.msg("保存成功")}var a=JSON.stringify(t);if("GDCL"==e)var o=serverPath+"contractOrderEditorController/saveOrderEditorInfo";else if("GDQR"==e)var o=serverPath+"contractOrderEditorController/saveOrderEditorApprovalInfo";App.formAjaxJson(o,"post",a,r)}function setPageIdCallback(data){$.each(data,function(k,v){if(!App.isExitsFunction("setPageId_"+k))return!0;var itemCallbackFn=eval("setPageId_"+k);itemCallbackFn(v)})}function validate(){$("#workOrderContentForm").bootstrapValidator({live:"enabled",trigger:"live focus blur keyup change",message:"校验未通过",container:"popover",fields:{}})}function exmportTemplate(t){function e(t){var e=t.data.fileStoreId;if(e){var r=serverPath+"fileload/downloadS3?key="+e;location.href=encodeURI(r)}else showLayerErrorMsg("暂无该模板")}var r={templateCode:t};App.formAjaxJson(serverPath+"contractOrderEditorController/downloadContractExcelTemplate","get",r,e)}function addNotEmptyValidatorField(t,e){var r={notEmpty:{message:e}};App.addValidatorField("#workOrderContentForm",t,r)}function checkDomOverlength(){var t=$("#workOrderContentForm").find(".has-error.overlength")[0];if(t){srolloOffect(t,1);var e=$(t).find("input").attr("maxlength"),r=getByteLen($(t).find("input").val());return showLayerErrorMsg("该输入框限制输入"+e+"个字符，现已输入"+r+"个字符，请修改后再进行操作"),!0}return!1}function getByteLen(t){for(var e=0,r=0;r<t.length;r++){var a=t.charAt(r);e+=null!=a.match(/[^\x00-\xff]/gi)?2:1}return e}function checkMaxLength(t){var e=getByteLen($(t).val()),r=$(t).attr("maxlength");e>r?(showLayerErrorMsg("输入字段超长，请输入不超过"+r+"个字的字符！"),$(t).parents(".form-group").addClass("has-error overlength")):$(t).hasClass("overlength")&&$(t).removeClass("overlength has-error")}function backPage(){window.history.go(-1)}var parm=App.getPresentParm(),config=top.globalConfig,serverPath=config.serverPath,formSubmit=!1,wcardId=null,wcardTypeCode=null,wcardProcess=null,contractId=null,contractNumber=null,contractStatus=null,isEdit=!1,fileUploadEdit=!0,isCancelApproved=!1,curStaffOrgId=config.curStaffId;"GDCL"==parm.taskDefinitionKey&&"db"==parm.taskFlag&&(isEdit=!0),$(function(){1==parm.pageType?(wcardId=parm.businessKey,$(".portlet-title").remove(),$(".page-content,.portlet-body").css("padding","0px"),$(".portlet").css("cssText","border:none !important;padding:0px"),$(".toolbarBtn").remove(),$(".page-content").removeClass("hidden"),"db"==parm.taskFlag?"GDCL"==parm.taskDefinitionKey?($("#flowLable").text("工单处理"),parent.setUserBtName("passButton","注册完成"),parent.setUserBtName("backTolist","关闭")):"GDQR"==parm.taskDefinitionKey&&($("#flowLable").text("工单确认"),parent.setUserBtName("passButton","激活合同"),parent.setUserBtName("backButton","退回承办人"),parent.setUserBtName("backTolist","关闭")):"GDCL"==parm.taskDefinitionKey?$("#flowLable").text("工单处理"):"GDQR"==parm.taskDefinitionKey&&$("#flowLable").text("工单确认")):2==parm.pageType?(wcardId=parm.wcardId,$("#flowNote").remove(),"GDCL"==parm.taskDefinitionKey&&"db"==parm.taskFlag?$(".sendBackBtn,.activateBtn").remove():"GDQR"==parm.taskDefinitionKey&&"db"==parm.taskFlag&&$(".register,.cancelApprovedBtn").remove(),$(".page-content").removeClass("hidden"),App.fixToolBars("toolbarBtnContent",70)):0==parm.pageType?(wcardId=parm.wcardId,$(".toolbarBtn,#flowNote").remove(),$(".page-content").removeClass("hidden")):4==parm.pageType&&(wcardId=parm.wcardId,$("#flowNote").remove(),$("#toolbarBtnContent button").not(".closeBtn").remove(),$(".page-content").removeClass("hidden"),App.fixToolBars("toolbarBtnContent",70)),getWorkOrderInfo()});var getContractOrderBaseInfoData=null;$("#workOrderMenu").hover(function(){$(this).css("padding-left","120px")},function(){$(this).css("padding-left","0")});
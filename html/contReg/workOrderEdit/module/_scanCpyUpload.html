<div class="form-fieldset">
	<div class="form-fieldset-title">
		<span><i class="iconfont icon-layers"></i> 合同扫描件</span>
		<div class="form-fieldset-tools">
			<a href="#" class="form-collapse"><i class="fa fa-angle-up"></i></a>
		</div>
	</div>
	<div class="form-fieldset-body">
		<div class="row" id="scanCpyUploadForm">
			<div class="col-sm-6 form-group">
				<label for="contractText" class="col-sm-3 control-label paddingLR0"><i class="iconfont icon-mi required"></i>合同正文扫描件：</label>
				<div class="col-sm-7 paddingR0" id="contractText">
					<input type="text" disabled="disabled" class="form-control" />
				</div>
				<div class="col-sm-2">
					<button type="button" id="contractTextUploadBtn" class="btn red fullWidth">添加</button>
				</div>
			</div>
			<div class="col-sm-12 cluesRed">
				提示：合同正文扫描件仅支持上传单个PDF文件，请确保扫描件清晰、顺序正确无缺页。
			</div>
			<div class="col-sm-12 clues">
				合同附件扫描件：
			</div>
			<div class="col-sm-12 cluesRed">
				提示：合同合同附件扫描件支持上传多种格式文件，可针对附件名依次上传对应扫描件。
			</div>
			<div class="col-sm-12" id="contractAttachment">
				<table id="contractAttachmentTable" class="table table-hover table-bordered table-striped table-align">
					<thead>
						<tr>
							<th>序号</th>
							<th>文件列表</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody id="contractAttachmentTbody">
						<tr class="emptyTr"><td colspan="3">暂无合同附件扫描件信息</td></tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	var scanCpyUploadScanDocId = null;
	/*
	 * 返回本页面数据，若无返回{}，若不提交本页面的值可删除此方法
	 * isSubmit 提交时为true,判断页面是否要加逻辑上的验证(bootstrap-validator验证除外)
	 */
	function getValue_contractScanCopyUpload(isSubmit) {
		if(isSubmit){
			var contractScanCopyUploadData = getContractUploadInfo(3);
			if(data.bodyDoc.storeId == "" || data.bodyDoc.storeId == undefined){
				layer.alert("请上传合同正文扫描件后进行提交。",{icon:2,title:"错误"});
				return false;
			}else{
				return contractScanCopyUploadData;
			}
		}else{
			var contractScanCopyUploadData = getContractUploadInfo(3);
			return contractScanCopyUploadData;
		}
	}
	/*
	 * 当为查询进入及已办进入是设为不可编辑
	 */
	if(parm.pageType == 0 || parm.pageType == 4 || parm.taskFlag == "yb"){
		$("#contractTextUploadBtn").attr("disabled","disabled");
		var scanCpyUploadFormIsEdit = false;
	}else{
		var scanCpyUploadFormIsEdit = true;
	};
	//获取合同扫描件ID来获取合同扫描件
	getScandocIdUpload()
	
	/*
	 * 获取合同扫描件ID来获取合同扫描件
	 */
	function getScandocIdUpload(){
		var url = serverPath + 'contractOrderEditorController/getScanningID';
		var postData = {
			contractId : contractId
		}
		App.formAjaxJson(url, "get", postData, successCallback);
		function successCallback(result) {
			scanCpyUploadScanDocId = result.data.scandocId;
			if(scanCpyUploadScanDocId){
				//获取合同正文和附件列表
				getReplenishContractInfo(scanCpyUploadScanDocId);
			}else{
				layer.msg("获取不到合同扫描件信息主键ID")
			}
		}
	}
	/*
	 * 获取合同正文和附件列表
	 */
	function getReplenishContractInfo(scandocId){
		var url = serverPath + "contractUpload/getReplenishContractInfo";
		var postData = {id:scandocId};
		App.formAjaxJson(url, "post", JSON.stringify(postData), successCallback);
		function successCallback(result) {
			var data = result.data;
			if(data){
				//设置正文扫描件html
				setBodyDocData(data.bodyDoc);
				//设置附件扫描件html
				setAttachDocData(data.attachDoc);
			}else{
				layer.msg("暂无数据");
			}
		}
	}
	/*
	 * 设置正文扫描件html
	 */
	function setBodyDocData(bodyDocData){
		if(bodyDocData){
			var bodyDocHtml = "";
			if(bodyDocData.storeId == "" || bodyDocData.storeId == null){
				$("#contractTextUploadBtn").text("添加");
				bodyDocHtml = '<input type="text" disabled="disabled" class="form-control" />';
				$("#contractText").data("storeid","");
			}else{
				$("#contractText").removeClass("col-sm-7").addClass("contractDocSty");
				$("#contractTextUploadBtn").text("删除");
				$("#contractText").data("storeid",bodyDocData.storeId);
				bodyDocHtml =  '<a href="/contractUpload/downloadS3?key1='+bodyDocData.storeId+'">'+bodyDocData.displayName+'</a>';
			};
			$("#contractText").html(bodyDocHtml);
			$("#contractText").data("attachid",bodyDocData.attachId);
			$("#contractText").data("displayname",bodyDocData.displayName);
		}else{
			layer.msg("正文扫描件为空");
		}
	}
	/*
	 * 正文扫描件的上传和回调及已经上传后的删除
	 */
	$("#contractTextUploadBtn").on("click",function(){
		var bodyDocStoreId = $("#contractText").data("storeid");
		if(bodyDocStoreId){
			layer.confirm("是否要删除已上传的正文扫描件",{icon:7,title:"提示"},function(index){
				layer.close(index);
				var bodyDocHtml = '<input type="text" disabled="disabled" class="form-control" />';
				$("#contractText").data("storeid","");
				$("#contractText").removeClass("contractDocSty").addClass("col-sm-7");
				$("#contractText").html(bodyDocHtml);
				$("#contractTextUploadBtn").text("添加");
			});
		}else{
			var attachId = $("#contractText").data("attachid");
			var displayName = $("#contractText").data("displayname");
			var setting = {
				title : "正文上传",
				url: 'contractUpload/uploadFile',
				maxNumber:1,
				fileExtensions:["pdf"],
				extraData:{attachId:attachId,displayName:displayName}
			};
			function queryCallback(){
				var fileInfo = getFileItemInfo()[0].data;
				$("#commomModal").modal("hide");
				var bodyDocHtml =  '<a href="/contractUpload/downloadS3?key1='+fileInfo.storeId+'">'+fileInfo.displayName+'</a>';
				$("#contractText").removeClass("col-sm-7").addClass("contractDocSty");
				$("#contractText").html(bodyDocHtml);
				$("#contractTextUploadBtn").text("删除");
				$("#contractText").data("storeid",fileInfo.storeId);
			}
			App.getFileUploadModal(setting,queryCallback);
		}
	})
	/*
	 * 设置附件扫描件html
	 */
	function setAttachDocData(bodyDocData){
		var bodyDocHtml = "";
		if(bodyDocData.length == 0){
			bodyDocHtml = '<tr class="emptyTr"><td colspan="3">暂无合同附件扫描件信息</td></tr>';
		}else{
			var btnHtml = "";
			if(scanCpyUploadFormIsEdit){
				for(var i = 0; i < bodyDocData.length; i++){
					var bodyDocItem = bodyDocData[i];
					if(bodyDocItem.storeId == "" || bodyDocItem.storeId == null){
						btnHtml = '<button type="button" class="btn primary btn-outline btn-xs attachUploadBtn">添加</button>';
						bodyDocHtml += '<tr data-attachid="'+bodyDocItem.attachId+'" data-storeid="">';
					}else{
						btnHtml = '<a href="/contractUpload/downloadS3?key1='+bodyDocItem.storeId+'">查看</a><a class="attachDelectBtn marginLeft25">删除</a>';
						bodyDocHtml += '<tr data-attachid="'+bodyDocItem.attachId+'" data-storeid="'+bodyDocItem.storeId+'">';
					};
					bodyDocHtml += '<td>'+(i+1)+'</td>'+
									'<td>'+bodyDocItem.displayName+'</td>'+
									'<td>'+btnHtml+'</td>'+
									'</tr>';
				}
			}else{
				for(var i = 0; i < bodyDocData.length; i++){
					var bodyDocItem = bodyDocData[i];
					bodyDocHtml += '<tr><td>'+ (i+1) +'</td><td>'+bodyDocItem.displayName+'</td>';
					if(bodyDocItem.storeId == "" || bodyDocItem.storeId == null){
						bodyDocHtml += '<td></td></tr>';
					}else{
						bodyDocHtml += '<td><a href="/contractUpload/downloadS3?key1='+bodyDocItem.storeId+'">查看</a></td></tr>';
					};
				}
			}
				
		};
		$("#contractAttachmentTbody").html(bodyDocHtml);
	}
	/*
	 * 附件扫描件事件委托
	 */
	//删除
	$("#contractAttachmentTbody").on("click",".attachDelectBtn",function(){
		var dom = $(this);
		layer.confirm("是否要删除已上传的附件扫描件",{icon:7,title:"提示"},function(index){
			layer.close(index);
			var btnHtml = '<button type="button" class="btn primary btn-outline btn-xs attachUploadBtn">添加</button>';
			dom.parents("tr").data("storeid","");
			dom.parent("td").html(btnHtml);
		});
	})
	//添加
	$("#contractAttachmentTbody").on("click",".attachUploadBtn",function(){
		var dom = $(this);
		var attachId = $(this).parents("tr").data("attachid");
		var setting = {
			title : "附件上传",
			url: 'contractUpload/uploadFile',
			maxNumber:1,
			extraData:{attachId:attachId}
		};
		function queryCallback(){
			var fileInfo = getFileItemInfo()[0].data;
			$("#commomModal").modal("hide");
			var btnHtml = '<a href="/contractUpload/downloadS3?key1='+fileInfo.storeId+'">查看</a><a class="attachDelectBtn marginLeft25">删除</a>';
			dom.parents("tr").data("storeid",fileInfo.storeId);
			dom.parent("td").html(btnHtml);
		}
		App.getFileUploadModal(setting,queryCallback);
	})
	
	/*
	 * 获取正文扫描件及附件信息
	 * uploadStatus:1保存
	 * uploadStatus:3提交
	 */
	function getContractUploadInfo(uploadStatus){
		var contractAttachmentList = [];
		var obj = {};
		$.each($("#contractAttachmentTbody tr"), function(k,v) {
			if(!$(v).hasClass("emptyTr")){
				var contractAttachmentItem = {
					attachId : $(v).data("attachid"),
					storeId : $(v).data("storeid"),
				};
				contractAttachmentList.push(contractAttachmentItem);
			};
		});
		obj.bodyDoc = {
			attachId : $("#contractText").data("attachid"),
			storeId : $("#contractText").data("storeid")
		};
		obj.attachDoc = contractAttachmentList;
		obj.uploadStatus = uploadStatus;
		obj.scandocId = scanCpyUploadScanDocId;
		return obj;
	}
</script>
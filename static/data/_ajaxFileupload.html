<style type="text/css">
	#fileUploadModalBody{
		overflow: auto;
	}
	.fileUploadModalForm .form-group{
		display:table;
	}
	.fileUploadModalForm .form-group > label{
		width: 18%;
	    min-height: 1px;
	    line-height: 16px;
	    padding:0 10px 0 0;
	    vertical-align:middle;    
	    display:table-cell;
	    text-align: right;
	}
	.fileUploadModalForm .form-group > .valiParent{
		width: 100%;
		float: left;
	  	position: relative;
	    min-height: 1px;
	    padding-left: 10px;
	    padding-right: 10px;
	}
	.aDisable{
		background: #e8dcdc;
		pointer-events:none
	}
	.fileUploadModalForm table{
		margin-bottom: 10px;
	}
	.chooseImportFile{
	    color: #fff;
	    background-color: #337ab7;
	    border-color: #2e6da4;
	}
	#fileuploadLoading img{width: 100%;}
</style>
<div class="modal-dialog" role="document">
	<div class="modal-content">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="fileUploadModalLabel"></h4>
		</div>
			<div class="modal-body fileUploadModalForm" id="fileUploadModalBody">
                <div class="form-group col-sm-12">
                    <label for="partnerCode" class="control-label">文件</label>
					<div class="valiParent">
						<div class="input-group">
							<input type="file" name="file" id="uploadFileName" class="hidden" accept="" />
							<input type="text" id="fileInput" name="fileInput" disabled="disabled" class="form-control">
							<div class="input-group-addon btn btn-primary chooseImportFile" onclick= "ajaxFileuploadChooseFile();"><i class="glyphicon glyphicon-folder-open"></i> 选择文件</div>
						</div>
					</div>
                </div>
                <div class="form-group col-sm-12" id="fileuploadLoading" style="display: none;">
					<img src="../img/loading2.gif"/>
				</div>
               	<div class="form-group col-sm-12">
                    <label for="partnerCode" class="control-label">上传说明</label>
                    <div class="valiParent" id="fileUpliadExplain" style="color: red;">
                        <i class="iconfont icon-mi required"></i>删除上传成功文件列表中的文件，此文档不做上传处理。</br>
                    </div>
                </div>
                <div class="form-group col-sm-12">
                    <label for="partnerCode">上传成功文件</label>
                    <table class="table table-hover table-bordered table-striped align-center">
                        <thead>
							<tr>
								<th class="align-center">文件名</th>
								<th class="align-center">操作</th>
							</tr>
						</thead>
						<tbody id="uploadSuccessFile">
							<tr class="defaultTr">
								<td colspan="2">暂无文件</td>
							</tr>
						</tbody>
                    </table>
                </div>
           </div>
		<div class="modal-footer">
			<button type="button" onclick="getFileUploadInfo()" class="btn btn-danger btn-circle"><i class="iconfont icon-baocun"></i> 确定</button>
			<button type="button" class="btn btn-default btn-circle" data-dismiss="modal"><i class="iconfont icon-close"></i> 关闭</button>
		</div>
	</div>
</div>

<script type="text/javascript">
	//系统全局变量获取
	var config = top.globalConfig;
	var serverPath = config.serverPath;
	var ajaxFileUploadParm = {
		maxNumeber: 999,
		fileExtensions: []
	};
	var fileUploadCallback = null;
	var fileCommonUploadObj = {};
	var fileUploadFlag = 1;
	var fileUploadModalBodyHeight = $(".page-content").height() - 185;
	$("#fileUploadModalBody").css("max-height", fileUploadModalBodyHeight);
	function setParm(setting,queryCallback){
		var fileUploadModalLabel = setting.title == undefined ? "文件上传" : setting.title;
		$("#fileUploadModalLabel").text(fileUploadModalLabel);
		$("#fileUpliadExplain").append(setting.explain);
		$("#commomModal").modal("show");
		if(setting.maxNumber){
			ajaxFileUploadParm.maxNumeber = setting.maxNumber;
		}
		var emptyFn = function(){};
		fileUploadCallback = queryCallback == null || queryCallback == "" ? emptyFn : queryCallback;
		ajaxFileUploadParm.url = setting.url;
		ajaxFileUploadParm.uploadAsync = setting.uploadAsync == undefined ? true : setting.uploadAsync;
		if(setting.fileExtensions){
			ajaxFileUploadParm.fileExtensions = setting.fileExtensions;
		};
		if(setting.isUploadFile == false){
			ajaxFileUploadParm.extraData = {};
		}else{
			ajaxFileUploadParm.extraData = {'displayName':""};
			if(setting.extraData){
				$.each(setting.extraData, function(k,v) {
					ajaxFileUploadParm.extraData[k] = v;
				})
			}
		}
	}
	/*
	 * 点击选择文件
	 */
	function ajaxFileuploadChooseFile(){
		if($(".fileItem").length >= ajaxFileUploadParm.maxNumeber){
			layer.msg("最多上传"+ajaxFileUploadParm.maxNumeber+"个文件，若继续上传请先删除文件！",{icon:2,time:4000});
			return false;
		}else{
			$('#uploadFileName').click();
		}
	}
	$("#uploadFileName").on("change",function(){
		var filePath = $(this).val();
		if (filePath == "") {
			return;
		}
		var tempFileName = filePath.substr(filePath.lastIndexOf("\\")+1,filePath.length);
		var fileName = tempFileName.split(".");
		var reg = fileName[fileName.length-1];
		var flag = false;
		//判断是否含有特殊字符
		var regEn = /[`~!@#$%^&*+<>?:"{},.\/;'[\]]/im,
	    regCn = /[·！#￥（）：；“”‘、，|《。》？[\]]/im;
		if(regEn.test(fileName[0]) || regCn.test(fileName[0])) {
			layer.alert("名称不能包含特殊字符",{title:"格式错误",icon:2});
			$("#uploadFileName").val("");
			$("#fileInput").val("");
		    return false;
		}
		//循环遍历附件类型
		var fileImportPostfix = ajaxFileUploadParm.fileExtensions;
		if(fileImportPostfix.length == 0){
			flag = true;
		};
		for(var i = 0;i<fileImportPostfix.length;i++){
			if(fileImportPostfix[i].toLowerCase() == reg.toLowerCase()){
				flag = true;
				break;
			}
		};
		if(!flag){
			var typeText = "";
    		$.each(fileImportPostfix,function(k,v){
    			typeText += "."+v +"，"; 
    		})
    		typeText = typeText.substring(0,typeText.length-1);
    		$("#uploadFileName").val("");
    		$("#fileInput").val("");
    		layer.alert("请选择"+typeText+"格式的文件",{title:"格式错误",icon:2});
			return false;
		}else{
			$("#fileInput").val(tempFileName);
		}
		//判断文件大小是否超出限制
		var sizeIsOk = true;
		try{
			var fSize = $('#uploadFileName')[0].files[0].size;
			var MB = (50 * 1024 * 1024).toString();
			sizeIsOk = fSize < MB;
		}catch(e){}
		if (!sizeIsOk) {
			layer.alert("上传文件大小超出限制,请上传小于50M的文件",{title:"上传错误",icon:2});
			$("#uploadFileName").val("");
			$("#fileInput").val("");
			return false;
		}else if(fSize==0){
			layer.alert("不能上传空文件",{title:"上传错误",icon:2});
			$("#uploadFileName").val("");
			$("#fileInput").val("");
			return false;
		}else {
			$("#fileuploadLoading").show();
			$.ajaxFileUpload({
				'url' : serverPath + ajaxFileUploadParm.url,
				'fileElementId' : "uploadFileName",
				'data': ajaxFileUploadParm.extraData,
				'async' : ajaxFileUploadParm.uploadAsync,
//				'contentType' : "text/html",
//	            'processData' : true,
		        'complete': function(){
		        	$("#fileuploadLoading").hide();
		        },
		        dataType: 'json',
				'success' : function(data) {
					console.log(data)
					
				},
				'error': function (data, status, e){
                    console.log(data);
                    
                }
			});
		}
	})
	
	/*
	 * 文件上传
	 */
	function initFileUpload(url,uploadAsync,fileExtensions,extraData){
	    // 异步上传成功结果处理
	    $("#uploadFileName").on("fileuploaded", function (event, data) {
	    	parseResult(data);
	    });
	    // 同步上传成功结果处理
	    $("#uploadFileName").on("filebatchuploadsuccess", function (event, data) {
	    	parseResult(data);
	    });
	    function parseResult(data){
	    	var fileValue = data.files;
	    	if(data.response.status == 1){
	    		fileUploadFlag++;
	    		$(".defaultTr").addClass("hidden");
				for(var i = 0; i < fileValue.length; i++){
					var keys = "fileSave" + fileUploadFlag + i;
					var html = '<tr><td>'+ fileValue[i].name +
					'</td><td><button type="button" data-name="'+fileValue[i].name+'" data-keys="'+ keys +'" class="btn primary btn-outline btn-xs fileItem">删除</button></td></tr>'
					$("#uploadSuccessFile").append(html);
					fileCommonUploadObj[keys] = data.response.data;
				};
		    	layer.msg(data.response.message);
		    	$("#uploadFileName").fileinput('reset');
	    	}else{
	    		layer.alert(data.response.message,{icon:2,title:"错误"});
	    	}
	    }
	}
	/*
	 * 列表内删除
	 */
	$("table").on("click",".fileItem",function(el){
		delete fileCommonUploadObj[$(this).data("keys")];
		$(this).parent().parent().remove();
		if($("#uploadSuccessFile").children().length == 1){
			$(".defaultTr").removeClass("hidden");
		}
	})
    /*
     * 获取列表内内容
     */
    function getFileItemInfo(){
    	var fileInfo = [];
    	$(".fileItem").each(function(index,element){
    		var itemInfo = {
    			name:$(element).data("name"),
    			data:fileCommonUploadObj[$(element).data("keys")]
    		};
    		fileInfo.push(itemInfo);
    	});
    	return fileInfo;
    }
    /*
     * 点击确定执行的方法
     */
    function getFileUploadInfo(){
    	var fileUploadItem = getFileItemInfo();
    	if(fileUploadItem.length == 0){
    		layer.msg("请先点击上传按钮上传文件后再执行该操作！",{icon:2,time:3000})
    	}else{
    		fileUploadCallback();
    	}
    }
</script>

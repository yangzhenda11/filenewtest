var AttributedStringIterator=function(t){t=t.replace(/(\s)+/," "),this.text=this.rtrim(t),this.beginIndex=0,this.endIndex=this.text.length,this.currentIndex=this.beginIndex;var e=0,s=this.text,r=0;for(this.startWordOffsets=[],this.startWordOffsets.push(r);1e3>e;){var i=s.search(/[ \t\n\f-\.\,]/);if(-1==i)break;r+=i,s=s.substr(i);var i=s.search(/[^ \t\n\f-\.\,]/);if(-1==i)break;r+=i,s=s.substr(i),this.startWordOffsets.push(r),e++}};AttributedStringIterator.prototype={getEndIndex:function(t){if("undefined"==typeof t)return this.endIndex;var e=this.text.substr(t,this.endIndex-t),s=e.search(/[\n]/);return-1==s?this.endIndex:t+s},getBeginIndex:function(){return this.beginIndex},isWhitespace:function(t){var e=this.text[t],s=" 	\n\f";return-1!=s.indexOf(e)},isNewLine:function(t){var e=this.text[t],s="\n";return-1!=s.indexOf(e)},preceding:function(t){for(var e in this.startWordOffsets){var s=this.startWordOffsets[e];if(s>t&&e>0)return this.startWordOffsets[e-1]}return this.startWordOffsets[e]},following:function(t){for(var e in this.startWordOffsets){var s=this.startWordOffsets[e];if(s>t&&e>0)return this.startWordOffsets[e]}return this.startWordOffsets[e]},ltrim:function(t){var e=/^\s+/g;return t.replace(e,"")},rtrim:function(t){var e=/\s+$/g;return t.replace(e,"")},getLayout:function(t,e){return this.text.substr(t,e-t)},getCharAtPos:function(t){return this.text[t]}};var LineBreakMeasurer=function(t,e,s,r,i){if(this.paper=t,this.text=new AttributedStringIterator(r),this.fontAttrs=i,this.text.getEndIndex()-this.text.getBeginIndex()<1)throw{message:"Text must contain at least one character.",code:"IllegalArgumentException"};this.limit=this.text.getEndIndex(),this.pos=this.start=this.text.getBeginIndex(),this.rafaelTextObject=this.paper.text(e,s,this.text.text).attr(i).attr("text-anchor","start"),this.svgTextObject=this.rafaelTextObject[0]};LineBreakMeasurer.prototype={nextOffset:function(t,e){var s=this.pos;if(this.pos<this.limit){if(e<=this.pos)throw{message:"offsetLimit must be after current position",code:"IllegalArgumentException"};var r=this.getLineBreakIndex(this.pos,t);r==this.limit?s=this.limit:this.text.isNewLine(r)?s=r+1:this.text.isWhitespace(r)?s=this.text.following(r):(s=this.text.preceding(r),s<=this.pos&&(s=Math.max(this.pos+1,r)))}return s>e&&(s=e),s},nextLayout:function(t){if(this.pos<this.limit){var e=!1,s=this.nextOffset(t,this.limit,e);if(s==this.pos)return null;var r=this.text.getLayout(this.pos,s);return this.pos=s,r}return null},getLineBreakIndex:function(t,e){var s=(this.rafaelTextObject.getBBox(),-1);try{var r=this.svgTextObject.getStartPositionOfChar(t);r.x=r.x+e,s=this.svgTextObject.getCharNumAtPosition(r)}catch(i){console.warn("getStartPositionOfChar error, pos:"+t)}if(-1==s)return this.text.getEndIndex(t);var n=this.text.getEndIndex(t);if(s>n)return console.log("newLineIndex <= charNum, newLineIndex:"+n+", charNum:"+s,'"'+this.text.text.substr(n+1).replace(/\n/g,"?")+'"'),n;this.text.getCharAtPos(s);return s},getPosition:function(){return this.pos}};
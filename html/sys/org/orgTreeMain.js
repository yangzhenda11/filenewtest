function showOrg(e){function o(e){function o(e){var o="";return 1==e?o="公司":2==e?o="部门":3==e?o="处室":4==e&&(o="虚拟组织"),o}App.setFindValue($("#orgShow"),e.data,{orgName:function(o){return"1"==e.data.orgStatus?o:o+"(停用)"},orgStatus:function(e){return"1"==e?"有效":"无效"},orgType:o})}App.formAjaxJson(serverPath+"orgs/"+e,"GET",null,o)}function delOrg(){function e(e){null!=e.data&&e.data.length>0&&(o=!0)}if(!curNode)return void layer.alert("请选择需删除的节点",{icon:2,title:"删除节点"});if(1==curNode.permId)return void layer.alert("根组织禁止删除",{icon:2,title:"删除节点"});var o=!1;App.formAjaxJson(parent.globalConfig.serverPath+"orgs/"+curNode.orgId+"/staffs/list","GET",null,e,null,null,null,!1);var r="";r=o?'当前组织下存在未失效的人员，确定删除<span style="color:red;margin:0 5px;">'+curNode.orgName+"</span>及其子节点?？":'确定删除<span style="color:red;margin:0 5px;">'+curNode.orgName+"</span>及其子节点?",layer.confirm(r,{icon:3,title:"删除节点"},function(e){function o(){layer.close(e),layer.msg("删除成功");var o=orgTree.getNodesByParam("orgId",curNode.parentId)[0];orgTree.selectNode(o),showOrg(o.orgId),orgTree.removeNode(curNode),curNode=o}var r=curNode.orgId,a={orgIds:r};App.formAjaxJson(serverPath+"orgs/"+r,"DELETE",a,o)})}function addOrg(){return curNode?void $("#modal").load("orgInfoModal.html?"+App.timestamp()+" #modalEdit",function(){$("#modalTitle").text("新增组织"),App.initFormSelect2("#orgForm"),$("#parentId").val(curNode.orgId),$("#parentName").val(curNode.orgName),$("#modal").modal("show"),validate("add")}):void layer.alert("请选择父节点",{icon:2,title:"添加节点"})}function showUpdate(){return curNode?config.curCompanyId==curNode.orgId?void layer.alert("父节点不能修改",{icon:2,title:"修改节点"}):void $("#modal").load("orgInfoModal.html?"+App.timestamp()+" #modalEdit",function(){function e(e){App.setFormValues($("#orgForm"),e.data);var o=orgTree.getNodesByParam("orgId",e.data.parentId)[0];o&&$("#parentName").val(o.orgName),validate("edit")}$("#modalTitle").text("修改组织"),App.initFormSelect2("#orgForm"),$("#modal").modal("show");var o={orgId:curNode.orgId};App.formAjaxJson(serverPath+"orgs/"+curNode.orgId,"get",o,e)}):void layer.alert("请选择父节点",{icon:2,title:"修改节点"})}function updateOrg(e){function o(o){if(layer.msg(t),$("#modal").modal("hide"),showOrg(curNode.orgId),"add"==e){var r={orgName:o.data.orgName,orgId:o.data.orgId};orgTree.addNodes(curNode,r)}else curNode.orgName=o.data.orgName,orgTree.updateNode(curNode)}function r(){$("#orgForm").data("bootstrapValidator").resetForm()}var a=App.getFormValues($("#orgForm")),t="新增成功",d=serverPath+"orgs/addOrg",n="POST";"add"==e?(a.createBy=config.curStaffId,a.updateBy=config.curStaffId,delete a.orgId):(t="修改成功",a.updateBy=config.curStaffId,d=serverPath+"orgs/updateOrg",n="PUT"),App.formAjaxJson(d,n,JSON.stringify(a),o,r)}function searchOu(){return curNode?($("#modal").empty(),void $("#modal").load("ouModal.html?"+App.timestamp()+" #modalEdit",function(){$("#modal").modal("show"),$("#ouModalTable").height($(".page-content").height()-250),$("#modalTitle").text("新增ou组织"),$("#orgNameOu").append("<p>当前组织："+curNode.orgName+"</p>");var e={url:serverPath+"orgs/selectOuList/"+curNode.orgCode,type:"get",async:!1};App.initAjaxSelect2("#ouList",e,"ouShortCode","ouName"),$("#modal").off("shown.bs.modal").on("shown.bs.modal",function(){App.initDataTables("#ouTable",{scrollY:$(".page-content").height()-340,ajax:{type:"GET",url:serverPath+"orgs/selectOuByOrgCode/"+curNode.orgCode,data:function(e){return e}},columns:[{data:null,className:"text-center",title:"操作",render:function(e){if(e){var o=new Array;return o.push({name:"删除",fn:"delOu('"+e.ouName+"')"}),App.getDataTableBtn(o)}return""}},{data:"ouName",title:"ou组织名称"},{data:"ouShortCode",title:"OU组织简码"}]})})})):void layer.alert("请选择节点节点",{icon:2,title:"提示"})}function addOu(){function e(e){if(null==e.data.orgCode)return void layer.alert("此ou已存在",{icon:2,title:"重复"});var o="新增成功";layer.msg(o,{icon:1}),$("#ouTable").DataTable().ajax.reload()}var o=$("#ouList").val(),r=curNode.orgCode,a=$("#ouList").find("option:selected").text();return""==o?void layer.msg("请选择ou组织列表",{icon:5}):void App.formAjaxJson(serverPath+"orgs/addOu/"+a+"/"+r+"/"+o,"POST","",e)}function delOu(e){function o(){var e="删除成功";layer.msg(e,{icon:1}),$("#ouTable").DataTable().ajax.reload()}var r=curNode.orgCode;App.formAjaxJson(serverPath+"orgs/delOu/"+e+"/"+r,"DELETE","",o)}function validate(e){$("#orgForm").bootstrapValidator({live:"enabled",trigger:"live focus blur change",message:"校验未通过",container:"popover",fields:{orgName:{validators:{notEmpty:{message:"请输入组织名称"}}},fullName:{validators:{notEmpty:{message:"请输入组织全称"}}},orgType:{validators:{notEmpty:{message:"请选择组织类型"}}},orgCode:{validators:{notEmpty:{message:"请输入组织编码"},callback:{message:"此组织编码已存在",callback:function(o){function r(r){if("add"==e){var t=curNode.orgCode;r.data?($("#orgCodeContent").find("small[data-bv-validator='callback']").html(t==o?"请以父节点编码为前缀输入组织编码":"此组织编码已存在"),a=!1):a=!0}else if("edit"==e){var d=curNode.orgId;r.data&&r.data.orgId!=d?a=!1:($("#orgCodeContent").find("small[data-bv-validator='callback']").html("此组织编码已存在"),a=!0)}}var a=!0;return""!=o&&App.formAjaxJson(serverPath+"orgs/checkOrgCode/"+o,"get","",r,null,null,!1,!1),a}}}},orgType:{validators:{notEmpty:{message:"请选择组织类型"}}},orgStatus:{validators:{notEmpty:{message:"请选择状态"}}},provinceCode:{validators:{notEmpty:{message:"请输入省分编码"}}}}}).on("success.form.bv",function(o){o.preventDefault(),updateOrg(e)})}function refreshTree(){function e(e){orgTree.destroy("orgTree"),zNodes=e.data[0],orgTree=$.fn.zTree.init($("#orgTree"),orgSetting,zNodes),curNode=orgTree.getNodes()[0],orgTree.selectNode(curNode),orgTree.expandNode(curNode,!0,!1,!0),showOrg(curNode.orgId)}App.formAjaxJson(serverPath+"orgs/"+config.curCompanyId+"/orgTree","get","",e)}function expandAll(){var e=orgTree.getNodes();expandNodes(e)}function expandNodes(e){if(e)for(var o=0,r=e.length;r>o;o++)orgTree.expandNode(e[o],!0,!1,!1),e[o].isParent&&expandNodes(e[o].children)}function collapseAll(){orgTree.expandAll(!1)}function orgsfilter(e,o,r){var r=r.data;return r?r:null}function zTreeBeforeAsync(e,o){return orgTree.setting.async.url=config.serverPath+"orgs/"+o.orgId+"/children?openFramework="+openFramework,!0}var config=parent.globalConfig,serverPath=config.serverPath,orgTree=null,curNode=null,openFramework=0;$(function(){function e(e){1==e.sysConfig.val&&($("#isShowAdd").show(),$("#isShowUpdate").show(),$("#isShowDel").show(),openFramework=111)}function o(e){var o=e.data[0];orgTree=$.fn.zTree.init($("#orgTree"),orgSetting,o),curNode=orgTree.getNodes()[0],orgTree.selectNode(curNode),orgTree.expandNode(curNode,!0,!1,!0),showOrg(curNode.orgId)}App.formAjaxJson(parent.globalConfig.serverPath+"configs/13","GET",null,e);var r=$(window).height(),a=$(".portlet").outerHeight();r>a?$("#orgTree").css("max-height",r-110):$("#orgTree").css("max-height",a-110),App.formAjaxJson(serverPath+"orgs/"+config.curCompanyId+"/orgTree","get","",o)});var orgIdOode=!1,orgSetting={async:{enable:!0,url:"",type:"get",dataType:"json",dataFilter:orgsfilter},data:{simpleData:{enable:!0,idKey:"orgId",pIdKey:"parentId"},key:{name:"orgName"}},view:{dblClickExpand:!1},callback:{onAsyncError:onAsyncError,beforeAsync:zTreeBeforeAsync,onClick:function(e,o,r){curNode=r,showOrg(r.orgId)}}};
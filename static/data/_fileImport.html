<style type="text/css">
	.fileImportModalBody .form-group {
		display: table;
	}
	
	.fileImportModalBody .form-group>label {
		width: 15%;
		min-height: 1px;
		line-height: 16px;
		padding: 0 10px 0 0;
		vertical-align: middle;
		display: table-cell;
		text-align: right;
	}
	
	.fileImportModalBody .form-group>.valiParent {
		width: 100%;
		float: left;
		position: relative;
		min-height: 1px;
		padding-left: 10px;
		padding-right: 10px;
	}
	
	.progress {
		margin-bottom: 0;
	}
	
	#scheduleDiv {
		margin: 10px 0 20px 0;
	}
	
	.fileImportChoose {
		padding: 2px 15px;
		height: 30px;
		line-height: 24px;
		position: relative;
		cursor: pointer;
		color: #fff;
		background: #2e6da4;
		border: 1px solid #2e6da4;
		border-radius: 4px;
		overflow: hidden;
		display: inline-block;
		*display: inline;
		*zoom: 1
	}
	.fileImportChoose i{
		margin-right: 6px;
	}
	
	.fileImportChoose input {
		position: absolute;
		font-size: 100px;
		right: 0;
		top: 0;
		opacity: 0;
		filter: alpha(opacity=0);
		cursor: pointer
	}
	.filePickerBtnList{
		display: inline-block;
	}
	.fileImportChoose:hover {
		color: #fff;
		background: #2b79bd;
		border-color: #2b79bd;
		text-decoration: none;
	}
	#fileImportName{
		color: #337ab7;
	}
	.fileImportBtn{
		margin: 0 10px;
	}
	#fileuploadLoading{
		width: 100%;
		margin: 20px 0;
	}
</style>
<div class="modal-dialog" role="document">
	<div class="modal-content">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="fileUploadModalLabel"></h4>
		</div>
		<div class="modal-body fileImportModalBody">
			<img id="fileuploadLoading" style="display: none;" src="/static/img/loading2.gif"/>
			<form id='fileImportModalForm' action='' method='post' enctype="multipart/form-data">
				<div class="form-group col-sm-12">
					<label for="partnerCode" class="control-label">文件</label>
					<div class="valiParent">
						<a class="fileImportChoose" id="fileImportChoose">
							<i class="glyphicon glyphicon-folder-open"></i><input type="file" name="file" id="importFileInput" accept="" />选择文件
						</a>
						<div id="fileImportResult" class="hidden">
							<a id="fileImportName"></a>
							<div class="filePickerBtnList">
				        		<button type="button" class="btn red fileImportBtn" onclick="fileImportPost()"><i class="iconfont icon-import"></i>导入文件</button>
								<button type="button" class="btn yellow" onclick="resetFileImport()"><i class="iconfont icon-reset"></i>删除文件</button>
				        	</div>
						</div>
					</div>
				</div>
				<div class="form-group col-sm-12">
					<label for="partnerCode" class="control-label">导入说明</label>
					<div class="valiParent" id="fileUpliadExplain" style="color: red;">
						<i class="iconfont icon-mi required"></i>请按照下载模板中文件的格式和内容进行导入。</br>
					</div>
				</div>
			</form>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-default btn-circle" data-dismiss="modal"><i class="iconfont icon-close"></i>关闭</button>
		</div>
	</div>
</div>

<script type="text/javascript">
	//系统全局变量获取
	var config = top.globalConfig;
	var serverPath = config.serverPath;
	var fileImportCallback = null;
	var _fileImportObj = {
		fileImportUrl: "",
		fileImportPostfix: [],
		extraData: ""
	}; 
	/*
	 * 检测选择文件按钮点击
	 */
	$("#importFileInput").on("change",function(){
	    var filePath = $(this).val();
	    var fileName = filePath.substr(filePath.lastIndexOf("\\")+1,filePath.length);
	    if(fileName){
	    	var fileImportPostfix = _fileImportObj.fileImportPostfix;
			var fileNameList = fileName.split(".");
			var reg = fileNameList[fileNameList.length-1];
			var flag = false;
			//IE10以上判断文件大小
			if(!App.IEVersionVA(10)){
				var chooseFile = document.getElementById("importFileInput").files[0];
				if(chooseFile.size/1048576 > 100){
					layer.msg("文件超过100M的限制，请重新选择");
					$("#importFileInput").val("");
				    return false;
				}
			};
			//判断是否含有特殊字符
			var regEn = /[`~!@#$%^&*+<>?:"{},.\/;'[\]]/im,
		    regCn = /[·！#￥（）：；“”‘、，|《。》？[\]]/im;
			if(regEn.test(fileNameList[0]) || regCn.test(fileNameList[0])) {
				layer.msg("名称不能包含特殊字符");
				$("#importFileInput").val("");
			    return false;
			}
			//循环遍历附件类型
			if(fileImportPostfix.length > 0){
				for(var i = 0;i < fileImportPostfix.length;i++){
					if(fileImportPostfix[i].toLowerCase() == reg.toLowerCase()){
						flag = true;
						break;
					}
				}
			}else{
				flag = true;
			};
			if(!flag){
				var typeText = "";
	    		$.each(fileImportPostfix,function(k,v){
	    			typeText += "."+v +"，"; 
	    		})
	    		typeText = typeText.substring(0,typeText.length-1);
	    		$("#importFileInput").val("");
	    		layer.alert("请选择"+typeText+"格式的文件",{title:"格式错误",icon:2});
				return false;
			}else{
				$("#fileImportChoose").addClass("hidden");
		        $("#fileImportResult").removeClass("hidden");
		        $("#fileImportName").html(fileName);
			}
	   	}
	})
	//设置参数
	function setParm(setting, callback) {
		var fileUploadModalLabel = setting.title == undefined ? "文件导入" : setting.title;
		$("#fileUploadModalLabel").text(fileUploadModalLabel);
		$("#commomModal").modal("show");
		var emptyFn = function() {};
		fileImportCallback = callback == null || callback == "" ? emptyFn : callback;
		_fileImportObj.fileImportUrl = setting.url;
		if(setting.postfix){
			_fileImportObj.fileImportPostfix = setting.postfix;
		}
		if(setting.accept) {
			$("#importFileInput").attr("accept", setting.accept);
		};
		if(setting.extraData) {
			_fileImportObj.extraData = setting.extraData;
		};
	}
	/*
	 * 文件导入上传
	 */
	function fileImportPost() {
		if($("#importFileInput").val()){
			$("#fileImportModalForm").hide();
			$("#fileuploadLoading").show();
			$.ajaxFileUpload({
				'url': serverPath + _fileImportObj.fileImportUrl,
				'fileElementId': "importFileInput",
				'data': _fileImportObj.extraData,
				'contentType': "text/html",
				'dataType': 'JSON',
	            'processData': true,
				'success': function(result) {
					console.log(result);
					$("#fileuploadLoading").hide();
					$("#fileImportModalForm").show();
					if((result.indexOf(">")!= -1) && (result.lastIndexOf("<")!= -1)){
						result = result.substring(result.indexOf(">")+1,result.lastIndexOf("<"));
					};
					try{
						var result = JSON.parse(result);
						fileImportCallback(result);
					}catch(e){
						layer.alert("导入失败",{icon:2,title:"错误"});
					}
				},
				'error': function(result){
					console.log(result);
					$("#fileuploadLoading").hide();
					$("#fileImportModalForm").show();
					layer.alert("导入失败",{icon:2,title:"错误"});
				}
			});
		}else{
			layer.msg("请选择文件");	
		}
//		if($("#importFileInput").val()){
//			$("#fileImportModalForm").ajaxSubmit({
//				dataType: 'text',
//				url: serverPath + _fileImportObj.fileImportUrl,
//				resetForm: "true",
//				timeout: 30000,
//				data: _fileImportObj.extraData,
//				beforeSubmit:function(a,b,c) {
//					//分别为数组形式的表单数据，jQuery表单对象，以及传入ajaxForm/ajaxSubmit中的Options对象
//					//返回false时取消上传
//					$("#fileImportModalForm").hide();
//					$("#fileuploadLoading").show();
//				},
//				success: function(result) {
//					var result = JSON.parse(result);
//					$("#fileuploadLoading").hide();
//					$("#fileImportModalForm").show();
//					fileImportCallback(result);
//				},
//				error: function(result) {
//					alert(JSON.stringify(result));
//					$("#fileuploadLoading").hide();
//					$("#fileImportModalForm").show();
//					App.ajaxErrorCallback(result);
//				},
//				complete: function(xhr) {
//              	//请求完成
//              	resetFileImport();
//          	}
//			})
//		}else{
//			layer.msg("请选择文件");	
//		}
	}
	/*
	 * 文件重置
	 */
	function resetFileImport(){
		$("#fileImportResult").addClass("hidden");
		$("#fileImportChoose").removeClass("hidden");
		$("#importFileInput").val("");
		$("#fileImportName").html("");
	}
</script>
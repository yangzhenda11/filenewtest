function getRoleTable(){App.initDataTables("#searchRoleTable","#submitBtn",{ajax:{type:"GET",url:serverPath+"roles/",data:function(e){return e.roleName=$("#sysRoleName").val(),e.orgName=$("#sysOrgName").val(),e.staffOrgId=config.curStaffOrgId,e.companyId=config.curCompanyId,e.roleStatus=1,e}},columns:[{data:"roleName",title:"角色名称",render:function(e,a,t){return'<a href="javascript:void(0)" onclick = "findDetail(\''+t.roleId+"')\">"+e+"</a>"}},{data:"roleDesc",title:"角色描述"},{data:"roleStatus",title:"角色状态",render:function(e,a,t){return"1"==t.roleStatus?"有效":"无效"}},{data:"roleCount",title:"授权人数",render:function(e,a,t){return'<a href="javascript:void(0)" onclick = "findStaff(\''+t.roleId+"')\">"+e+"</a>"}},{data:"createDate",title:"添加时间",render:function(e){return App.formatDateTime(e,"yyyy-mm-dd")}}]})}function searchRole(e){var a=$("#searchRoleTable").DataTable();e?a.ajax.reload(null,!1):a.ajax.reload()}function findDetail(e){$("#modal").load("_roleModal.html?"+App.timestamp()+" #modalDetail",function(){$("#modal").modal("show"),getRoleInfo(e,"detail")})}function findStaff(e){$("#modal").load("roleStaffModal.html?"+App.timestamp()+" #modalDetail",function(){$("#modal").modal("show"),getRoleStaffTable(e)})}function getRoleStaffTable(e){App.initDataTables("#searchRoleStaffTable","#submitBtn",{ajax:{type:"GET",url:serverPath+"roles/searchRoleStaff",data:function(a){return a.staffName=$("#staffName").val(),a.loginName=$("#loginName").val(),a.companyId=config.curCompanyId,a.roleId=e,a}},columns:[{data:"STAFF_NAME",title:"人员姓名"},{data:"LOGIN_NAME",title:"账号"},{data:"ORG_NAME",title:"部门名称"},{data:"STAFF_ORG_TYPE",title:"岗位状态",className:"text-center",render:function(e,a,t){return"F"==t.STAFF_ORG_TYPE?"主岗":"T"==t.STAFF_ORG_TYPE?"兼岗":"借调"}},{data:"SEX",title:"性别",className:"text-center",render:function(e,a,t){return"M"==t.SEX?"男":"女"}},{data:"EMAIL",title:"邮箱账号"},{data:"MOBIL_PHONE",title:"手机号码"},{data:"STAFF_ORG_STATUS",title:"岗位状态",className:"text-center",render:function(e,a,t){return"1"==t.STAFF_ORG_STATUS?"有效":"无效"}}]})}function searchRoleStaff(){var e=$("#searchRoleStaffTable").DataTable();e.ajax.reload()}function reset(){$("#staffName").val(""),$("#loginName").val("")}function getRoleInfo(e,a){function t(t){function r(e){if(null!=e.data){var a=$.fn.zTree.init($("#rolePermissionDetailTree"),permissionViewSetting,e.data),t=a.getNodes()[0];a.expandNode(t)}else $("#rolePermission").text("该角色暂无权限"),layer.msg("该角色无相关权限",{icon:2})}if("detail"==a){var o={updateDate:function(e){return App.formatDateTime(e,"yyyy-mm-dd")},isPartnerRole:function(e){return"1"==e?"是":"否"}};App.setFindValue($("#roleInfo"),t.data,o),App.formAjaxJson(serverPath+"roles/"+e+"/perms","GET",null,r)}else{var o={updateDate:function(e){return App.formatDateTime(e,"yyyy-mm-dd")}};App.setFormValues($("#roleForm"),t.data,o),$("#orgNameTree").attr("title",t.data.orgName),$("#orgNameTree").data("orgCode",t.data.orgId),$("#orgNameTree").data("provCode",t.data.provCode),loadPerTree(e)}}App.formAjaxJson(serverPath+"roles/"+e,"GET",null,t)}function loadPerTree(e){function a(e){var a=e.data;null==a?layer.msg("没有相关组织和人员信息",{icon:2}):orgNameTree=$.fn.zTree.init($("#orgName"),orgsSetting,a)}$("#orgNameTree").on("click",function(){showTree("orgNameTree")}),App.formAjaxJson(serverPath+"orgs/"+config.curOrgId+"/orgTree","get",null,a),$.get(serverPath+"pers/permAll",{staffOrgId:config.curStaffOrgId,staffId:config.curStaffId},function(a){function t(e){if(null!=e.data){var a=e.data;for(p in a){var t=a[p],r=rolePermissionTree.getNodeByParam("permId",t.PERM_ID);rolePermissionTree.checkNode(r,!0)}}}a.length>0?(rolePermissionTree=$.fn.zTree.init($("#rolePermissionTree"),rolePermissionSetting,a),e&&App.formAjaxJson(serverPath+"roles/"+e+"/perms","GET",null,t)):($("#rolePermissions").html("<div style='margin-top:9px'>暂无查询到权限信息</div>"),layer.msg("暂无查询到权限信息",{icon:2}))})}function setPermData(){{var e=$.fn.zTree.getZTreeObj("rolePermissionTree");e.getNodeByParam("permId",100),e.getNodeByParam("permId",201)}}function showTree(e){{var a=$("#"+e);a.offset()}$("#"+e+"Content").css({left:"0",top:a.outerHeight()+"px",width:a.outerWidth()+50}).slideDown("fast"),onBodyDown(e)}function hideMenu(e){$("#"+e+"Content").fadeOut("fast"),$("body").unbind("mousedown",onBodyDown)}function onBodyDown(e){$("body").on("mousedown",function(a){a.target.id==e||a.target.id==e+"Content"||$(a.target).parents("#"+e+"Content").length>0||hideMenu(e)})}function orgsfilter(e,a,t){var t=t.data;return t?t:null}function zTreeBeforeAsync(e,a){return orgNameTree.setting.async.url=serverPath+"orgs/"+a.orgId+"/children?orgType=1",!0}function onClick(e,a){var t=$.fn.zTree.getZTreeObj(a).getSelectedNodes(),r=t[0].orgName,o=t[0].orgCode,n=t[0].provCode;$("input[name="+a+"]").data("orgCode",o),$("input[name="+a+"]").data("provCode",n),$("input[name="+a+"]").val(r),$("input[name="+a+"]").attr("title",r),"orgName"==a&&($("#roleForm").data("bootstrapValidator").updateStatus("orgName","NOT_VALIDATED",null),$("#roleForm").data("bootstrapValidator").validateField("orgName"))}var config=parent.globalConfig,serverPath=config.serverPath,rolePermissionTree,orgNameTree;$(function(){parent.data_permFilter(document),getRoleTable()});var roleUpdate=parent.data_tpFilter("sys:role:update"),roleDelete=parent.data_tpFilter("sys:role:delete"),permissionViewSetting={view:{selectedMulti:!1},data:{simpleData:{enable:!0,idKey:"PERM_ID",pIdKey:"PARENT_ID"},key:{name:"PERM_NAME"}}},rolePermissionSetting={check:{enable:!0,chkboxType:{Y:"ps",N:"ps"}},data:{simpleData:{enable:!0,idKey:"permId",pIdKey:"parentId"},key:{name:"permName"}},callback:{}},orgsSetting={async:{enable:!0,url:"",type:"get",dataType:"json",dataFilter:orgsfilter},data:{simpleData:{enable:!0,idKey:"orgId",pIdKey:"parent_id"},key:{name:"orgName"}},view:{dblClickExpand:!1},callback:{onAsyncError:onAsyncError,onClick:onClick,beforeAsync:zTreeBeforeAsync}};
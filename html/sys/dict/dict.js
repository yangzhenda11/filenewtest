function getDictTree(){function e(e){var t=e.dicts;if(dictTree){dictTree.destroy(),dictTree=$.fn.zTree.init($("#dictTree"),dictTreeSetting,t);var a=dictTree.getNodeByParam("dictValue",curNodeId);dictTree.expandNode(a),dictTree.selectNode(a,!1,!1),searchDict(!0)}else{dictTree=$.fn.zTree.init($("#dictTree"),dictTreeSetting,t);var i=dictTree.getNodes()[0];dictTree.expandNode(i),dictTree.selectNode(i,!1,!1),i&&(curNodeId=i.dictValue,createDictTable(),$("#toolbars").removeClass("hide"))}}App.formAjaxJson(serverPath+"dicts/","get","",e)}function getDictChildInfo(e,t,a){curNodeId=a.dictValue,a.level<2?$("#toolbars").removeClass("hide"):$("#toolbars").addClass("hide"),searchDict()}function createDictTable(){App.initDataTables("#dictTable","#submitBtn",{ajax:{type:"GET",url:serverPath+"dicts/dictList",data:function(e){return e.dictParentId=curNodeId,e.dictLabel=$("#dictName").val(),e.dictCode=$("#dictCode").val(),e}},columns:[{data:null,title:"操作",className:"text-center",render:function(e,t,a){if(0==a.dictParentId)return"";var i=new Array;return i.push({name:"修改",fn:"dictModal('edit','"+a.dictId+"','"+a.dictParentId+"','"+a.orgName+"')"}),i.push("1"==a.dictStatus?{name:"禁用",fn:"changeDictStatus('"+a.dictId+"','"+a.dictParentId+"','"+a.dictLabel+"', '0')"}:{name:"启用",fn:"changeDictStatus('"+a.dictId+"','"+a.dictParentId+"','"+a.dictLabel+"', '1')"}),App.getDataTableBtn(i)}},{data:"dictParentId",title:"字典编码"},{data:"dictLabel",title:"字典项名称"},{data:"dictValue",title:"字典项编码"},{data:"provName",title:"适用范围"},{data:"dictSort",title:"顺序"}],drawCallbackFn:function(){var e=$(window).height(),t=$(".portlet").outerHeight();e>t?$("#dictTree").css("max-height",e-110):$("#dictTree").css("max-height",t-110)}})}function searchDict(e){var t=$("#dictTable").DataTable(),a=dictTree.getSelectedNodes()[0];a.level>1&&(curNodeId=a.dictParentId),e?t.ajax.reload(null,!1):t.ajax.reload()}function changeDictStatus(e,t,a,i){var d="1"==i?"启用":"禁用";layer.confirm("确定"+d+'名为<span style="color:red;margin:0 5px;">'+a+"</span>的字典?",{icon:3,title:"字典"+d},function(a){layer.close(a),doChangeDictStatus(e,t,i,a)})}function doChangeDictStatus(e,t,a){if(0==t)return layer.msg("根节点禁止“启用禁用”操作",{icon:2}),!1;if(0==a){var i=dictTree.getNodeByParam("dictId",e).level;0==i?layer.confirm("树的根节点将消失无法恢复，确认禁用？",{icon:3},function(){postDictChangeStatus(e,a)}):postDictChangeStatus(e,a)}else postDictChangeStatus(e,a)}function postDictChangeStatus(e,t){function a(){var e="1"==t?"启用成功":"禁用成功",a=dictTree.getSelectedNodes()[0];layer.msg(e,{icon:1}),curNodeId=a.dictValue==dictValue?0==a.level?dictTree.getNodes()[0].dictValue:a.dictParentId:a.dictValue,getDictTree()}var i={dictId:e,dictStatus:t};App.formAjaxJson(serverPath+"dicts/"+e,"PUT",JSON.stringify(i),a)}function dictModal(e,t,a,i){$("#modal").load("_dictModal.html?"+App.timestamp()+" #modalEdit",function(){App.initFormSelect2("#dictForm");var d={url:serverPath+"dicts/dictProvSelect",type:"post",data:{id:i},async:!1};if(App.initAjaxSelect2("#provinceCode",d,"provCode","provName","请选择适用范围"),"add"==e){$("#modalTitle").text("新增字典");var c=dictTree.getSelectedNodes()[0];$("#dictParentName").val(c.dictLabel),$("#dictParentId").val(c.dictValue),$("#dictValue").removeAttr("disabled"),validate(e),$("#modal").modal("show")}else if("edit"==e){if(0==a)return layer.msg("根节点禁止“编辑”操作",{icon:2}),!1;$("#modalTitle").text("字典修改"),$("#dictValue").attr("disabled","disabled"),getDictInfor(e,t)}})}function getDictInfor(e,t){function a(a){$("#modal").modal("show"),App.setFormValues("#dictForm",a.sysDict),validate(e,t)}App.formAjaxJson(serverPath+"dicts/"+t,"get","",a)}function updateDict(e,t){function a(){layer.msg(c),getDictTree(),$("#modal").modal("hide")}function i(){$("#externalPersonnelForm").data("bootstrapValidator").resetForm()}var d=App.getFormValues($("#dictForm")),c="新增成功",r=serverPath+"dicts/",n="POST";"add"==e?(d.createBy=config.curStaffId,d.updateBy=config.curStaffId,d.dictStatus=1,delete d.dictId):(d.updateBy=config.curStaffId,c="修改成功",r=serverPath+"dicts/"+t,n="PUT"),App.formAjaxJson(r,n,JSON.stringify(d),a,i)}function validate(e,t){$("#dictForm").bootstrapValidator({live:"enabled",trigger:"live focus blur keyup change",message:"校验未通过",container:"popover",fields:{dictLabel:{validators:{notEmpty:{message:"请输入字典名称"},stringLength:{min:0,max:20,message:"请输入不超过20个字符"}}},dictValue:{validators:{notEmpty:{message:"请输入字典值"},stringLength:{min:0,max:20,message:"请输入不超过20个字符"}}},dictSort:{validators:{notEmpty:{message:"请输入字典顺序"},numeric:{message:"只能输入纯数字"},stringLength:{min:0,max:6,message:"请输入不超过6个字符"}}},dictDesc:{validators:{stringLength:{min:0,max:50,message:"请输入不超过50个字符"}}},provinceCode:{validators:{notEmpty:{message:"请选择适用范围"}}}}}).on("success.form.bv",function(a){a.preventDefault(),updateDict(e,t)})}function refreshTree(){function e(e){dictTree.destroy();var t=e.dicts;dictTree=$.fn.zTree.init($("#dictTree"),dictTreeSetting,t);var a=dictTree.getNodes()[0];dictTree.expandNode(a),dictTree.selectNode(a,!1,!1),a&&(curNodeId=a.dictId,$("#toolbars").removeClass("hide"),curNodeId=a.dictId,searchDict(!0))}App.formAjaxJson(serverPath+"dicts/","get","",e)}function expandAll(){var e=dictTree.getNodes();expandNodes(e)}function expandNodes(e){if(e)for(var t=0,a=e.length;a>t;t++)dictTree.expandNode(e[t],!0,!1,!1),e[t].isParent&&expandNodes(e[t].children)}function collapseAll(){dictTree.expandAll(!1)}var curNodeId,dictTree,config=parent.globalConfig,serverPath=config.serverPath;$(function(){parent.data_permFilter(document),getDictTree()});var dictTreeSetting={view:{selectedMulti:!1},data:{simpleData:{enable:!0,idKey:"dictValue",pIdKey:"dictParentId",rootPId:0},key:{name:"dictLabel"}},callback:{onClick:getDictChildInfo}};
<div class="form-fieldset">
	<div class="form-fieldset-title">
		<span><i class="iconfont icon-layers"></i> 开票信息</span>
		<div class="form-fieldset-tools">
			<a class="form-collapse"><i class="fa fa-angle-up"></i></a>
		</div>
	</div>
	<div class="form-fieldset-body">
		<div class="row" id="invoiceInfoContent">
			<div class="portlet-body">
				<div class="tableToobarContent hidden" id="invoiceInfoToolbar">
					<button class="btn red" type="button" onclick="addInvoiceTableTr()"><i class="iconfont icon-add"></i>新增</button>
					<button class="btn red" type="button" onclick="delectsInvoiceTr()"><i class="iconfont icon-shanchu"></i>删除</button>
					<button class="btn red" type="button" onclick="exmportTemplate('workcard_invoice')"><i class="iconfont icon-export"></i>下载模板</button>
					<button class="btn red" type="button" onclick="invoiceFileImport()"><i class="iconfont icon-import"></i>导入</button>
				</div>
				<table class="table table-hover table-bordered table-striped table-align">
					<thead>
						<tr>
							<th class="invoiceTableEdit"><label class='ui-checkbox'><input type='checkbox' name='invocieCheckAll' id="invocieCheckAll"><span></span></label></th>
							<th>序号</th>
							<th class="isRequiredIcon">发票抬头</th>
							<th class="isRequiredIcon">开票类型</th>
							<th class="invoiceTableEdit">操作</th>
						</tr>
					</thead>
					<tbody id="invoiceTbody">
						<tr class="emptyTr">
							<td colspan="5">暂无开票信息</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	/*
	 * 设置页面的id值，由保存和提交后回调
	 */
	function setPageId_invoiceListId(value){
		var valueKey = 0;
		$.each($("#invoiceTbody tr"), function(k,v) {
			if(!$(v).hasClass("emptyTr")){
				if($(v).data("id") != undefined){
					$(v).data("id",value[valueKey]);
					valueKey++;
				}
			}
		});
	}
	/*
	 * 返回本页面数据，若无返回{}，若不提交本页面的值可删除此方法
	 * isSubmit 提交时为true,判断页面是否要加逻辑上的验证(bootstrap-validator验证除外)
	 */
	function getValue_invoiceList(isSubmit){
		var invoiceDataList = [];
		$.each($("#invoiceTbody tr"),function(k,v){
			if(!$(v).hasClass("emptyTr")){
				var invoiceDataItem = {};
				invoiceDataItem.wcardId = wcardId;
				invoiceDataItem.contractNumber = contractNumber;
				invoiceDataItem.invoiceId = $(v).data("id");
				invoiceDataItem.invoiceTitle = $(v).find(".invoiceTitleName").val();
				invoiceDataItem.invoiceType = $(v).find(".invoiceTypeName").val();
				invoiceDataList.push(invoiceDataItem);
			}
		});
		//当合同总览中"固定金额"为"是"时，加校验"至少有一条开票信息";
		var isFixedValue = $("input[name='isFixed']:checked").val();
		if(isSubmit && isFixedValue == 1){
			if(invoiceDataList.length > 0){
				return invoiceDataList;
			}else{
				layer.msg("请至少填写一项开票信息");
				srolloOffect("#invoiceInfoContent");
				return false;
			}
		}else{
			return invoiceDataList;
		}
	}
	/*
	 * 去除多于的行
	 */
	function removeMorethan_invoiceList(){
		var tableValue = getValue_invoiceList();
		var emptyList = [];
		for(var i = 0; i < tableValue.length; i++){
			var tableItem = tableValue[i];
			var isEmpty = true;
			delete tableItem.contractNumber;
			delete tableItem.invoiceId;
			delete tableItem.wcardId;
			$.each(tableItem, function(k,v) {
				if(v){
					isEmpty = false;
					return false;
				}
			});
			if(isEmpty){
				emptyList.push(i);
			}
		};
		$.each(emptyList, function(m,n) {
			var index = n - m;
			$("#invoiceTbody tr").eq(index).remove();
		});
		addInvoiceTbodyEmptyTr();
	}
	/*
	 * 自定义验证，注意去除.error
	 */
	function customValidator_invoiceList(){
		var isReg = true;
		$.each($("#invoiceTbody tr"),function(k,v){
			if(!$(v).hasClass("emptyTr")){
				var invoiceTypeItem = $(v).find(".invoiceTypeName").val();
				if(invoiceTypeItem == "" || invoiceTypeItem == null){
					isReg = false;
					$(v).find(".invoiceTypeName").parents(".form-group").addClass("has-error");
				}
			}
		});
		return isReg;
	}
	//name自增基础值
	var isCreateInvoiceTrLength = 0;
	//获取开票信息字典值
	var invoiceType = new Object();
	var invoiceTypeSelectHtml = "";
	getInvoiceDict();
	//获取开票信息
	getInvoiceInfo();
	
	/*
	 * 获取开票信息字典值
	 * 开票类型   invoiceType
	 */
	function getInvoiceDict() {
		invoiceType = App.getDictInfo(9025);
		invoiceTypeSelectHtml = "<option value=''>请选择</option>";
		$.each(invoiceType, function(k,v) {
			invoiceTypeSelectHtml += "<option value='"+ k +"'>"+ v +"</option>";
		});
	}
	
	/*
	 * 获取开票信息
	 */
	function getInvoiceInfo() {
		var url = serverPath + "contractOrderEditorController/getInvoiceId";
		var postData = JSON.stringify({wcardId:wcardId});
		App.formAjaxJson(url, "post", postData, successCallback);

		function successCallback(result) {
			var data = result.data;
			if(data.length > 0){
				addInvoiceTableData(data);
			};
			/*
			 * isEdit 判断页面是否只能查看
			 */
			if(!isEdit){
				$("#invoiceInfoContent").find("input").attr("disabled","disabled");
				$("#invoiceInfoToolbar,.invoiceTableEdit").remove();
			}else{
				$("#invoiceInfoToolbar").removeClass("hidden");
			};
		}
	}
	/*
	 * 初始化或导入增加处理
	 */
	function addInvoiceTableData(data){
		var isNew = false;
		if($("#invoiceTbody .emptyTr")[0] != undefined){
			isNew = true;
			$("#invoiceTbody .emptyTr").remove();
		};
		var invoiceTitleNameList = [],invoiceTypeNameList = [],invoiceTableHtml = "";
		for(var i = 0; i < data.length; i++){
			var itemData = data[i];
			isCreateInvoiceTrLength++;
			var invoiceId = itemData.invoiceId ? itemData.invoiceId : "100000";
			var invoiceTitleVal = itemData.invoiceTitle;
			var invoiceTitleName = "invoiceTitle" + isCreateInvoiceTrLength;
			var invoiceTypeName = "invoiceType" + isCreateInvoiceTrLength;
			invoiceTitleNameList.push(invoiceTitleName);
			invoiceTypeNameList.push(invoiceTypeName);
			invoiceTableHtml += "<tr data-id='"+invoiceId+"' id='"+ invoiceTypeName +"'>"+
							"<td class='invoiceTableEdit'><label class='ui-checkbox'><input type='checkbox' name='invoiceCheck'><span></span></label></td>"+
							"<td class='orderNumber'></td>"+
							"<td><div class='form-group'><input type='text' class='form-control invoiceTitleName' name='"+ invoiceTitleName +"' placeholder='"+setPTip('请输入发票抬头')+"' value='"+ invoiceTitleVal +"' maxlength='240' /></div></td>"+
							"<td><div class='form-group'><select class='form-control select2me invoiceTypeName' data-placeholder='"+setPTip('请选择发票类型')+"' name='"+ invoiceTypeName +"'>"+ invoiceTypeSelectHtml +"</select></div></td>"+
							"<td class='invoiceTableEdit'><button type='button' class='btn primary btn-outline btn-xs' onclick='delectInvoiceTr(this)'>删除</button></td>"+
						"</tr>";
		};
		if(isNew){
			$("#invoiceTbody").html(invoiceTableHtml);
		}else{
			$("#invoiceTbody").append(invoiceTableHtml);
		};
		if(!isEdit){
			$("#invoiceTbody").find("select").attr("disabled","disabled");
		}
		App.initFormSelect2("#invoiceTbody");
		for(var o = 0; o < data.length; o++){
			var itemData = data[o];
			$("#"+invoiceTypeNameList[o]+" select[name='"+invoiceTypeNameList[o]+"']").val(itemData.invoiceType).trigger("change");
			addNotEmptyValidatorField(invoiceTitleNameList[o],"请输入不超过240个字符的发票抬头");
		};
		addInvoiceTableSort();
		App.checkAllFn("#invocieCheckAll","invoiceCheck");
	}
	/*
	 * 单行增加处理
	 */
	function addInvoiceTableTr(){
		if($("#invoiceTbody .emptyTr")[0] != undefined){
			$("#invoiceTbody .emptyTr").remove();
		};
		isCreateInvoiceTrLength++;
		var invoiceTitleName = "invoiceTitle" + isCreateInvoiceTrLength;
		var invoiceTypeName = "invoiceType" + isCreateInvoiceTrLength;
		var appendHtml = "<tr data-id='100000' id='"+invoiceTypeName+"'>"+
							"<td class='invoiceTableEdit'><label class='ui-checkbox'><input type='checkbox' name='invoiceCheck'><span></span></label></td>"+
							"<td class='orderNumber'></td>"+
							"<td><div class='form-group'><input type='text' class='form-control invoiceTitleName' name='"+ invoiceTitleName +"' placeholder='"+setPTip('请输入发票抬头')+"' maxlength='240' /></div></td>"+
							"<td><div class='form-group'><select class='form-control select2me invoiceTypeName' data-placeholder='"+setPTip('请选择发票类型')+"' name='"+ invoiceTypeName +"'>"+ invoiceTypeSelectHtml +"</select></div></td>"+
							"<td class='invoiceTableEdit'><button type='button' class='btn primary btn-outline btn-xs' onclick='delectInvoiceTr(this)'>删除</button></td>"+
						"</tr>";
		$("#invoiceTbody").append(appendHtml);
		if(!isEdit){
			$("#"+invoiceTypeName).find("select").attr("disabled","disabled");
		}
		App.initFormSelect2("#"+invoiceTypeName);
		addNotEmptyValidatorField(invoiceTitleName,"请输入不超过240个字符的发票抬头");
		addInvoiceTableSort();
		App.checkAllFn("#invocieCheckAll","invoiceCheck");
	}
	/*
	 * 批量删除表格数据
	 */
	function delectsInvoiceTr(){
		var checkInvoiceLength = $("#invoiceTbody input[name='invoiceCheck']:checked").length;
		if(checkInvoiceLength == 0){
			layer.msg("请勾选要删除的开票信息");
		}else{
			layer.confirm("是否要删除这"+checkInvoiceLength+"条数据？",{icon:7,title:"提示"},function(index){
				layer.close(index);
				$.each($("#invoiceTbody input[name='invoiceCheck']:checked"), function(k,v) {
					$(v).parents("tr").remove();
				});
				addInvoiceTableSort();
				App.checkAllFn("#invocieCheckAll","invoiceCheck");
				addInvoiceTbodyEmptyTr();
			})
		}
	}
	/*
	 * 删除表格数据
	 */
	function delectInvoiceTr(dom){
		layer.confirm("是否要删除此条数据？",{icon:7,title:"提示"},function(index){
			layer.close(index);
			$(dom).parents("tr").remove();
			addInvoiceTableSort();
			App.checkAllFn("#invocieCheckAll","invoiceCheck");
			addInvoiceTbodyEmptyTr();
		})
	}
	/*
	 * 表格数据增加序号
	 */
	function addInvoiceTableSort(){
		$.each($("#invoiceTbody .orderNumber"), function(k,v) {
			$(v).text(k+1);
		});
	}
	/*
	 * 若为空增加empty值
	 */
	function addInvoiceTbodyEmptyTr(){
		if($("#invoiceTbody tr").length == 0){
			var html = '<tr class="emptyTr"><td colspan="5">暂无开票信息</td></tr>';
			$("#invoiceTbody").html(html);
		}
	}
	/*
	 * 开票信息导入
	 */
	function invoiceFileImport(){
		var setting = {
			title: "开票信息导入",
			url: 'contractOrderEditorController/importContractInvoiceExcel',
			postfix: ["xlsx","xls"],
			accept: ".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel",				//导入文件类型
			extraData: {wcardId:wcardId,contractNumber:contractNumber}
		};
		function callback(result){
			if(result.status == 1){
				var data = result.data;
				if(data.length > 0){
					addInvoiceTableData(data);
				};
				layer.msg("成功导入"+data.length+"条开票信息");
				$("#commomModal").modal("hide");
			}else if(result.status == 3010){
				showLayerErrorMsg(result.message);
			}else{
				showLayerErrorMsg(result.message,true);
			}
		}
		App.getFileImportModal(setting,callback);
	}
</script>
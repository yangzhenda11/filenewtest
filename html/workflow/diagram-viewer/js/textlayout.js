window.onload=function(){function t(t,r,s,o,h,f){var l=3,x=o-2*l;if(h)var u=h-2*l;var c=[],d=new n(e,t,i),g=d.rafaelTextObject.getBBox().height;if(console.log("text: ",t.replace(/\n/g,"↵")),u){var b=parseInt(u/g);console.log("availableLinesCount: "+b)}for(var p=1;d.getPosition()<d.text.getEndIndex();){var v=d.nextLayout(x);if(null!=v){if(b&&!(b>p)){c.push(a(v+"...",o));break}c.push(v)}p++}console.log(c),d.rafaelTextObject.attr({text:c.join("\n")}),f&&d.rafaelTextObject.attr({"text-anchor":f["text-anchor"]});var O=d.rafaelTextObject.getBBox();d.rafaelTextObject.attr("top"==f["vertical-align"]?{y:s+O.height/2+l}:{y:s+u/2}),"middle"==d.rafaelTextObject.attr("text-anchor")?d.rafaelTextObject.attr("x",r+o/2+l/2):"end"==d.rafaelTextObject.attr("text-anchor")?d.rafaelTextObject.attr("x",r+o+l/2):d.rafaelTextObject.attr("x",r+o/2-O.width/2+l/2);{var m={stroke:Color.LightSteelBlue2,"stroke-width":1,"stroke-dasharray":"- "},B=r+o/2,I=s+u/2,m=(e.ellipse(r,s,3,3).attr({"stroke-width":0,fill:Color.LightSteelBlue,stroke:"none"}),e.ellipse(B,I,3,3).attr({fill:Color.LightSteelBlue2,stroke:"none"}),{stroke:Color.LightSteelBlue2,"stroke-width":1,"stroke-dasharray":"- "});e.rect(r+.5,s+.5,o,h).attr(m)}}var e=Raphael("holder"),r="Betty Botter bought some butter but, she said, the butter's bitter. If I put it in my batter, it will make my batter bitter. But a bit of better butter will make my batter better. So, she bought a bit of butter, better than her bitter butter, and she put it in her batter, and the batter was not bitter. It was better Betty Botter bought a bit better butter.",i={font:"11px Arial","font-style":"italic",opacity:1,fill:LABEL_COLOR,stroke:LABEL_COLOR,"stroke-width":.3},i={font:"11px Arial",opacity:1,fill:LABEL_COLOR},s=function(t){t=t.replace(/(\s)+/," "),this.text=this.rtrim(t),this.beginIndex=0,this.endIndex=this.text.length,this.currentIndex=this.beginIndex;var e=0,r=this.text,i=0;for(this.startWordOffsets=[],this.startWordOffsets.push(i);1e3>e;){var s=r.search(/[ \t\n\f-\.\,]/);if(-1==s)break;i+=s,r=r.substr(s);var s=r.search(/[^ \t\n\f-\.\,]/);if(-1==s)break;i+=s,r=r.substr(s),this.startWordOffsets.push(i),e++}};s.prototype={getEndIndex:function(t){if("undefined"==typeof t)return this.endIndex;var e=this.text.substr(t,this.endIndex-t),r=e.search(/[\n]/);return-1==r?this.endIndex:t+r},getBeginIndex:function(){return this.beginIndex},isWhitespace:function(t){var e=this.text[t],r=" 	\n\f";return-1!=r.indexOf(e)},isNewLine:function(t){var e=this.text[t],r="\n";return-1!=r.indexOf(e)},preceding:function(t){for(var e in this.startWordOffsets){var r=this.startWordOffsets[e];if(r>t&&e>0)return this.startWordOffsets[e-1]}return this.startWordOffsets[e]},following:function(t){for(var e in this.startWordOffsets){var r=this.startWordOffsets[e];if(r>t&&e>0)return this.startWordOffsets[e]}return this.startWordOffsets[e]},ltrim:function(t){var e=/^\s+/g;return t.replace(e,"")},rtrim:function(t){var e=/\s+$/g;return t.replace(e,"")},getLayout:function(t,e){return this.text.substr(t,e-t)},getCharAtPos:function(t){return this.text[t]}};var n=function(t,e,r){if(this.paper=t,this.text=new s(e),this.fontAttrs=r,this.text.getEndIndex()-this.text.getBeginIndex()<1)throw{message:"Text must contain at least one character.",code:"IllegalArgumentException"};this.limit=this.text.getEndIndex(),this.pos=this.start=this.text.getBeginIndex(),this.rafaelTextObject=this.paper.text(100,100,this.text.text).attr(r).attr("text-anchor","start"),this.svgTextObject=this.rafaelTextObject[0]};n.prototype={nextOffset:function(t,e){var r=this.pos;if(this.pos<this.limit){if(e<=this.pos)throw{message:"offsetLimit must be after current position",code:"IllegalArgumentException"};var i=this.getLineBreakIndex(this.pos,t);i==this.limit?r=this.limit:this.text.isNewLine(i)?(console.log("isNewLine"),r=i+1):this.text.isWhitespace(i)?r=this.text.following(i):(r=this.text.preceding(i),r<=this.pos&&(r=Math.max(this.pos+1,i)))}return r>e&&(r=e),r},nextLayout:function(t){if(this.pos<this.limit){var e=!1,r=this.nextOffset(t,this.limit,e);if(r==this.pos)return null;var i=this.text.getLayout(this.pos,r);return this.pos=r,i}return null},getLineBreakIndex:function(t,e){var r=(this.rafaelTextObject.getBBox(),-1);try{var i=this.svgTextObject.getStartPositionOfChar(t);i.x=i.x+e,r=this.svgTextObject.getCharNumAtPosition(i)}catch(s){console.warn("getStartPositionOfChar error, pos:"+t)}if(-1==r)return this.text.getEndIndex(t);var n=this.text.getEndIndex(t);if(r>n)return console.log("newLineIndex <= charNum, newLineIndex:"+n+", charNum:"+r,'"'+this.text.text.substr(n+1).replace(/\n/g,"↵")+'"'),n;this.text.getCharAtPos(r);return r},getPosition:function(){return this.pos}};var a=function(t,r){for(var i=t,s={font:"11px Arial",opacity:0},n=e.text(0,0,"...").attr(s).hide(),a=n.getBBox(),o=r-a.width,h=e.text(0,0,i).attr(s).hide(),f=h.getBBox();f.width>o&&i.length>0;)i=i.substring(0,i.length-1),h.attr({text:i}),f=h.getBBox();return h.remove(),i!=t&&(i+="..."),i},o=100,h=90,f={"text-anchor":"middle",boxHeight:150,"vertical-align":"top"},f={boxHeight:150,"vertical-align":"top"};t(r,o,h,150,100,f)};
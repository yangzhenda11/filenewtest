<style type="text/css">
	.fileImportModalBody .form-group {
		display: table;
	}
	
	.fileImportModalBody .form-group>label {
		width: 15%;
		min-height: 1px;
		line-height: 16px;
		padding: 0 10px 0 0;
		vertical-align: middle;
		display: table-cell;
		text-align: right;
	}
	
	.fileImportModalBody .form-group>.valiParent {
		width: 100%;
		float: left;
		position: relative;
		min-height: 1px;
		padding-left: 10px;
		padding-right: 10px;
	}
	
	.progress {
		margin-bottom: 0;
	}
	
	#scheduleDiv {
		margin: 10px 0 20px 0;
	}
	
	.fileUploadChoose {
		padding: 2px 15px;
		height: 30px;
		line-height: 24px;
		position: relative;
		cursor: pointer;
		color: #fff;
		background: #2e6da4;
		border: 1px solid #2e6da4;
		border-radius: 4px;
		overflow: hidden;
		display: inline-block;
		*display: inline;
		*zoom: 1
	}
	.fileUploadChoose i{
		margin-right: 6px;
	}
	
	.fileUploadChoose input {
		position: absolute;
		font-size: 100px;
		right: 0;
		top: 0;
		opacity: 0;
		filter: alpha(opacity=0);
		cursor: pointer
	}
	.filePickerBtnList{
		display: inline-block;
	}
	.fileUploadChoose:hover {
		color: #fff;
		background: #2b79bd;
		border-color: #2b79bd;
		text-decoration: none;
	}
	#fileUploadName{
		color: #337ab7;
	}
	.fileImportBtn{
		margin: 0 10px;
	}
	#fileuploadLoading{
		width: 100%;
		margin: 20px 0;
	}
</style>
<div class="modal-dialog" role="document">
	<div class="modal-content">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="fileUploadModalLabel"></h4>
		</div>
		<div class="modal-body fileImportModalBody">
			<img id="fileuploadLoading" style="display: none;" src="/static/img/loading2.gif"/>
			<form id='fileUploadModalForm' action='' method='post' enctype="multipart/form-data">
				<div class="form-group col-sm-12">
					<label for="partnerCode" class="control-label">文件</label>
					<div class="valiParent">
						<a class="fileUploadChoose" id="fileUploadChoose">
							<i class="glyphicon glyphicon-folder-open"></i><span id="fileUploadChooseDom"></span>选择文件
						</a>
						<div id="fileUploadResult" class="hidden">
							<a id="fileUploadName"></a>
							<div class="filePickerBtnList">
				        		<button type="button" class="btn red fileImportBtn" onclick="fileUploadPost()">上传文件</button>
								<button type="button" class="btn yellow" onclick="resetFileUpload()">删除文件</button>
				        	</div>
						</div>
					</div>
				</div>				
				<div class="form-group col-sm-12">
					<label for="partnerCode" class="control-label">上传说明</label>
					<div class="valiParent" id="fileUpliadExplain" style="color: red;">
						<i class="iconfont icon-mi required"></i>文件大小不能超过100M。
					</div>
				</div>
			</form>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-default btn-circle" data-dismiss="modal"><i class="iconfont icon-close"></i>关闭</button>
		</div>
	</div>
</div>

<script type="text/javascript">
	//系统全局变量获取
	var config = top.globalConfig;
	var fileUploadPath = config.fileUploadPath;
	var fileUploadSuccessCallback = null;
	var _fileUploadObj = {
		url: "",
		fileExtensions: [],
		extraData: null,
		changeName: false,
		fileName: "",
		resultObj: [],
		accept: null
	}; 
	/*
	 * 检测选择文件按钮点击
	 */
	function addFileUploadEventListener(){
		$("#uploadFileInput").on("change",function(){
		    var filePath = $(this).val();
		    var fileName = filePath.substr(filePath.lastIndexOf("\\")+1,filePath.length);
		    if(fileName){
		    	var fileExtensions = _fileUploadObj.fileExtensions;
				_fileUploadObj.fileName = fileName;
				var fileNameList = fileName.split(".");
				var reg = fileNameList[fileNameList.length-1];
				var flag = false;
				try{
				    //判断文件大小是否超出100M限制
					var fileSize = $('#uploadFileInput')[0].files[0].size;
					var MaxSize = (100 * 1024 * 1024).toString();
					if(fileSize> MaxSize){
						layer.msg("文件超过100M的限制，请重新选择");
						resetFileUpload();
					    return false;
					}
				}catch(e){}
	//			判断是否含有特殊字符
	//			var regEn = /[`~!@#$%^&*+<>?:"{},.\/;'[\]]/im,
	//		    regCn = /[·！#￥（）：；“”‘、，|《。》？[\]]/im;
				if(fileName.indexOf(" ") != -1 || fileName.indexOf("%") != -1){
					layer.msg("文件中不能包括“ ”和“%”，请重新选择");
					resetFileUpload();
				    return false;
				};
				//循环遍历附件类型
				if(fileExtensions.length > 0){
					for(var i = 0;i < fileExtensions.length;i++){
						if(fileExtensions[i].toLowerCase() == reg.toLowerCase()){
							flag = true;
							break;
						}
					}
				}else{
					flag = true;
				};
				if(!flag){
					var typeText = "";
		    		$.each(fileExtensions,function(k,v){
		    			typeText += "."+v +"，"; 
		    		})
		    		typeText = typeText.substring(0,typeText.length-1);
		    		resetFileUpload();
		    		layer.alert("请选择"+typeText+"格式的文件",{title:"格式错误",icon:2});
					return false;
				}else{
					if(_fileUploadObj.changeName){
		    			var changefileName = _fileUploadObj.extraData.displayName + "." + reg;
		    			_fileUploadObj.extraData.displayName = changefileName;
		        	};
					$("#fileUploadChoose").addClass("hidden");
			        $("#fileUploadResult").removeClass("hidden");
			        $("#fileUploadName").html(fileName);
				}
		   	}
		})
	}
	
	//设置参数
	function setParm(setting, queryCallback) {
		var fileUploadModalLabel = setting.title == undefined ? "文件上传" : setting.title;
		$("#fileUploadModalLabel").text(fileUploadModalLabel);
		$("#fileUpliadExplain").append(setting.explain);
		$("#fileUploadChooseDom").html('<input type="file" name="fileName" id="uploadFileInput" accept="" />');
		addFileUploadEventListener();
		$("#commomModal").modal("show");
		var emptyFn = function(){};
		fileUploadSuccessCallback = queryCallback == null || queryCallback == "" ? emptyFn : queryCallback;
		_fileUploadObj.url = setting.url;
		if(setting.fileExtensions){
			_fileUploadObj.fileExtensions = setting.fileExtensions;
		}
		if(setting.accept) {
			_fileUploadObj.accept = setting.accept;
			$("#uploadFileInput").attr("accept", setting.accept);
		};
		if(setting.extraData) {
			_fileUploadObj.extraData = setting.extraData;
			var displayName = setting.extraData.displayName;
			if(displayName){
				if(displayName.indexOf("&^&") != -1){
					_fileUploadObj.changeName = true;
					_fileUploadObj.extraData.displayName = displayName.substring(0,displayName.length-3);
				}
			}
		}else{
			_fileUploadObj.extraData = {displayName: ""};
		}
	}
	/*
	 * 文件上传
	 */
	function fileUploadPost() {
		if($("#uploadFileInput").val()){
			$("#fileUploadModalForm").hide();
			$("#fileuploadLoading").show();
			$.ajaxFileUpload({
				'url': fileUploadPath + _fileUploadObj.url,
				'fileElementId': "uploadFileInput",
				'data': _fileUploadObj.extraData,
				'contentType': "text/html",
				'dataType': 'JSON',
	            'processData': true,
				'success': function(result) {
					$("#fileuploadLoading").hide();
					$("#fileUploadModalForm").show();
					if((result.indexOf(">")!= -1) && (result.lastIndexOf("<")!= -1)){
						result = result.substring(result.indexOf(">")+1,result.lastIndexOf("<"));
					};
					try{
						var result = JSON.parse(result);
						if(result.status == 1){
				    		layer.msg("上传成功");
				    		var displayName = _fileUploadObj.extraData.displayName;
				    		if(displayName == "" || displayName == undefined){
				    			var itemInfo = {
					    			name:_fileUploadObj.fileName,
					    			data:result.data
					    		};
				    		}else{
				    			var itemInfo = {
					    			name:displayName,
					    			data:result.data
					    		};
				    		};
				    		_fileUploadObj.resultObj.push(itemInfo);
				    		fileUploadSuccessCallback();
				    	}else{
				    		layer.alert(result.message,{icon:2,title:"错误"});
				    	};
					}catch(e){
						layer.alert("上传失败",{icon:2,title:"错误"});
					}
				},
				'error': function(result){
					$("#fileuploadLoading").hide();
					$("#fileUploadModalForm").show();
					layer.alert("上传失败",{icon:2,title:"错误"});
				}
			});
		}else{
			layer.msg("请选择文件");	
		}
	}
	/*
	 * 文件重置
	 */
	function resetFileUpload(){
		$("#fileUploadResult").addClass("hidden");
		$("#fileUploadChoose").removeClass("hidden");
		$("#fileUploadChooseDom").html('<input type="file" name="fileName" id="uploadFileInput" accept="" />');
		if(_fileUploadObj.accept) {
			$("#uploadFileInput").attr("accept", _fileUploadObj.accept);
		};
		$("#fileUploadName").html("");
		addFileUploadEventListener();
	}
	 /*
     * 获取上传结果
     */
    function getFileItemInfo(){
    	return _fileUploadObj.resultObj;
    }
</script>
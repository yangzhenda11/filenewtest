function succssCallback(e){var t=e.data;$.each(t,function(e,t){associateCodeInfo[t.dictValue]=t.dictLabel})}function beforePushProcess(){var e=!0,t=null;if(null==isDifferences)return layer.alert("获取页面状态失败",{icon:2}),!1;if(0==isDifferences)t=0;else{if(""==$("#differencesExplain").val())return layer.alert("请输入意见",{icon:2}),!1;t=1==isLeader?0:2}var n={prov:"sd"};return parent.setAssigneeParam(n),parent.setPathSelect(t),e}function modal_pass(e,t,n,o,a,i,r,s){function d(){parent.layer.alert("处理成功",{icon:1},function(){parent.modal_close()})}function c(e){parent.layer.alert(e.message,{icon:1})}var l={processInstanceId:o,taskId:a,taskDefinitionKey:t,assignee:n,comment:i,handleType:r,withdraw:s,nowtaskDefinitionKey:$("#taskDefinitionKey").val(),taskDefinitionKeyNow:parm.taskDefinitionKey,title:""};if(0==isDifferences){var f="sysScanValidation/saveOpinionPushProcessTrue";l.verifyId=verifyId}else{var v=1==isLeader?2:1,f="sysScanValidation/saveOpinionPushProcess";l.relationId=relationId,l.busiId=verifyId,l.verifyId=verifyId,l.createdType=v,l.pinfoContent=$("#differencesExplain").val()}App.formAjaxJson(serverPath+f,"post",JSON.stringify(l),d,c)}function setComment(){var e=$("#differencesExplain").val();return e}function modal_save(){function e(e){layer.msg("保存成功"),relationId=e.data.saveRelationId}if(1==isDifferences){var t=1==isLeader?2:1,n={relationId:relationId,busiId:verifyId,createdType:t,pinfoContent:$("#differencesExplain").val()};App.formAjaxJson(serverPath+"sysScanValidation/saveOpinion","post",JSON.stringify(n),e)}else layer.msg("当前环节不需要保存数据")}function modal_passBybuss(e){function t(){function t(){parent.layer.alert("提交成功！系统将对扫描件进行验证，验证结果请在待办中查询。",{icon:1},function(){parent.modal_close()})}function n(e){parent.layer.alert(e.message,{icon:2})}var o=getFileItemInfo();if($("#commomModal").modal("hide"),e)var a=e;else var a={};a.verifyId=verifyId,a.storeId=o[0].data,a.contractId=contractId,App.formAjaxJson(serverPath+"sysScanValidation/uploadScannedDoc","post",JSON.stringify(a),t,n)}var n={title:"合同正文扫描件上传",url:"fileload/uploadFileS3",maxNumber:1,fileExtensions:["pdf"]};App.getFileUploadModal(n,t)}function beforeTransfer(){var e=!0,t={prov:"sd"};return parent.setAssigneeParam(t),e}function modal_return(e,t,n){$.post(e+"business/withdrawProcess",{processInstanceId:t,taskId:n},function(e){alert(e.sign+"（业务开发人员自定义提示消息有无及内容）"),parent.modal_close()})}function getScanValidationInfo(e){function t(e){console.log(e);var t=e.data;$("#verifyState").text(associateCodeInfo[t.verifyStatus]),$("#contratVersion").text(t.verifyVersion),isDifferences=null==t.verifyDiffCount||""==t.verifyDiffCount||void 0==t.verifyDiffCount?!1:!0,validationResultView(isDifferences),contractId=t.contractId;var n=null==t.otherPartyName||void 0==t.otherPartyName?"":t.otherPartyName,o=null==t.ourPartyName||void 0==t.ourPartyName?"":t.ourPartyName;if($("#contractNumber").val(t.contractNumber),$("#executeDeptName").val(t.executeDeptName),$("#contractName").val(t.contractName),$("#undertakeName").val(t.undertakeName),$("#mobilPhone").val(t.mobilPhone),$("#phone").val(t.phone),$("#otherPartyName").html(n),$("#ourPartyName").html(o),t.textPdf){var a=encodeURIComponent(serverPath+"fileload/downloadS3?key="+t.textPdf);$("#textPdfContent").attr("src","../../../static/plugins/pdf/web/viewer.html?file="+a),interval1=setInterval("loadTextPdf()",500)}else{var i=document.getElementById("textPdfContent").contentDocument||document.frames.textPdfContent.document;i.body.innerHTML="<div style='color:red;text-align:center'>不存在可加载pdf的url</div>"}if(t.scandocPdf){var r=encodeURIComponent(serverPath+"fileload/downloadS3?key="+t.scandocPdf);console.log(r),$("#scandocPdfContent").attr("src","../../../static/plugins/pdf/web/viewer.html?file="+r),interval2=setInterval("loadScandocPdf()",500)}else{var i=document.getElementById("scandocPdfContent").contentDocument||document.frames.scandocPdfContent.document;i.body.innerHTML="<div style='color:red;text-align:center'>不存在可加载pdf的url</div>"}isDifferences&&(1==parm.pageType&&"db"==parm.taskFlag&&0==isLeader&&parent.setUserButton(!0,parm.businessKey),getDifferenceRecord(contractId,t.verifyVersion))}function n(){clearInterval(interval1),clearInterval(interval2)}var o={verifyId:e};App.formAjaxJson(serverPath+"sysScanValidation/getSysScanValidationId","post",JSON.stringify(o),t,n)}function getDifferenceRecord(e,t){function n(e){for(var e=e.data,n=[],o=0;o<e.length;o++)e[o].verifyVersion<=t&&n.push(e[o]);return 0==n.length?(layer.alert("当前验证有差异，暂未获取到差异记录",{icon:2}),!1):(setDifferenceInfo(n[0]),void(n.length>1?($("#differencesRecord").removeClass("hidden"),setDifferenceRecord(n)):$("#differencesRecord").remove()))}var o={contractId:e};App.formAjaxJson(serverPath+"sysScanValidation/getVerifyDiffId","post",JSON.stringify(o),n)}function setDifferenceInfo(e){$("#verifyData").text(e.verifyDate);var t=null==e.verifyDiffCount||void 0==e.verifyDiffCount?0:e.verifyDiffCount;$("#differenceNumber").text(t);var n=e.tSBusiProcessInfoVo,o=e.verifyDiffVo;if(n.length>0&&"db"==parm.taskFlag&&(1==isLeader?2==n[0].createdType&&($("#differencesExplain").val(n[0].pinfoContent),relationId=n[0].relationId,n.splice(0,1)):1==n[0].createdType&&($("#differencesExplain").val(n[0].pinfoContent),relationId=n[0].relationId,n.splice(0,1))),0==n.length&&2==parm.pageType)$("#differencesThat").remove();else if(n.length>0){var a=creatThatItemHtml(n);$("#thatItemContent").html(a)}for(var i="",r=0;r<o.length;r++)i+=creatDiffTbodyHtml(o[r],r);$("#differenceTbody").html(i)}function creatThatItemHtml(e){for(var t="",n="",o="",a=0;a<e.length;a++){var i=e[a].pinfoContent,r=null==e[a].updatedDate?e[a].ctreatedDate:e[a].updatedDate,s=e[a].orgName+"："+e[a].createdName+"<span class='marL30'>"+r,d='<div class="thatItemContent">'+i+'</div><div class="thatItemFooter">'+s+"</div>";2==e[a].createdType?n+=d:t+=d}return""!=t&&(o+='<div class="col-sm-12 differencesThatItem"><div class="thatItemTitle">承办人</div>'+t+"</div>"),""!=n&&(o+='<div class="col-sm-12 differencesThatItem"><div class="thatItemTitle">承办部门领导</div>'+n+"</div>"),o}function creatDiffTbodyHtml(e,t){var n="<tr data-textpageno="+e.textPageno+" data-textlineno="+e.textLineno+"><td>"+(t+1)+"</td><td>"+e.textDiff+"</td><td>"+e.scandocDiff+"</td></tr>";return n}function pdfApiSearch(e,t){document.getElementById(e).contentWindow.PDFViewerApplication.findController.executeCommand("find",{query:t,phraseSearch:!0,caseSensitive:!0,highlightAll:!0,findPrevious:void 0})}function setDifferenceRecord(e){for(var t="",n=1;n<e.length;n++){var o=e[n],a=null==o.verifyDiffCount||void 0==o.verifyDiffCount?0:o.verifyDiffCount,i="",r="";if(o.tSBusiProcessInfoVo.length>0&&"db"==parm.taskFlag&&(1==isLeader?2==o.tSBusiProcessInfoVo[0].createdType&&o.tSBusiProcessInfoVo.splice(0,1):1==o.tSBusiProcessInfoVo[0].createdType&&o.tSBusiProcessInfoVo.splice(0,1)),o.tSBusiProcessInfoVo.length>0&&(i=creatThatItemHtml(o.tSBusiProcessInfoVo)),o.verifyDiffVo.length>0)for(var s=0;s<o.verifyDiffVo.length;s++)r+=creatDiffTbodyHtml(o.verifyDiffVo[s],s);t+='<div class="form-fieldset"><div class="form-fieldset-title"><span class="diffVersion">版本号：'+o.verifyVersion+'</span><span class="diffValiDate">验证日期：'+o.verifyDate+'</span><span class="diffNum">共有<span class="mLR5">'+a+'</span>项不符</span><div class="form-fieldset-tools"><a href="#" class="form-collapse"><i class="fa fa-angle-down"></i></a></div></div><div class="form-fieldset-body" style="display:none;"><div class="row">'+i+'<table class="table table-hover table-bordered table-striped"><thead><tr><th>序号</th><th>合同定稿正文</th><th>正文扫描件</th></tr></thead><tbody>'+r+"</tbody></table></div></div></div>"}$("#differenceRecordContent").html(t),panelAction("#differenceRecordContent .form-collapse",".form-fieldset-title",".form-fieldset-body","fa-angle-up","fa-angle-down")}function backPage(){window.history.go(-1)}function validationResultView(e){var t=$(".page-content").height()-10;e?($("#differencesThat").removeClass("hidden"),$("#textPdfDiv,#scandocPdfDiv,#differenceDiv").addClass("col-sm-4"),$("#scaleContent").css("padding-left","20%"),$("#pdfToggle").css("height",t+25),$(".squery").on("click",function(){$(this).data("isFewer")?($("#pdfContent,#scaleContent").removeClass("hidden"),$("#differenceDiv").removeClass("col-sm-12").addClass("col-sm-4"),$(this).children().removeClass("icon-sanjiaoright").addClass("icon-sanjiaoleft"),$(this).data("isFewer",!1)):($("#pdfContent,#scaleContent").addClass("hidden"),$("#differenceDiv").removeClass("col-sm-4").addClass("col-sm-12"),$(this).children().removeClass("icon-sanjiaoleft").addClass("icon-sanjiaoright"),$(this).data("isFewer",!0))})):($("#textPdfDiv,#scandocPdfDiv").addClass("col-sm-6"),$("#differencesThat,#differencesRecord,#differenceDiv").remove(),$("#scaleContent").css("padding-left","44%")),$("#scandocPdfContent,#textPdfContent,#differenceTable").css({height:t,overflow:"auto"}),$("#validationResult").removeClass("hidden")}function loadTextPdf(){null!=document.getElementById("textPdfContent").contentWindow.PDFViewerApplication.pdfDocument&&(clearInterval(interval1),console.log("Load textPdf Success..."),pdfLoadFlag++,$("#textPdfContent").contents().find("#viewerContainer").on("scroll",function(){textPdfScroll()}))}function loadScandocPdf(){null!=document.getElementById("scandocPdfContent").contentWindow.PDFViewerApplication.pdfDocument&&(clearInterval(interval2),console.log("Load scandocPdf Success..."),pdfLoadFlag++,$("#scandocPdfContent").contents().find("#viewerContainer").on("scroll",function(){scandocPdfScroll()}))}function textPdfScroll(){if(2==pdfLoadFlag){$("#scandocPdfContent").contents().find("#viewerContainer").unbind("scroll");var e=$("#textPdfContent").contents().find("#viewerContainer").scrollTop()/$("#textPdfContent").contents().find("#viewer").height()*$("#scandocPdfContent").contents().find("#viewer").height();$("#scandocPdfContent").contents().find("#viewerContainer").scrollTop(e),clearTimeout(timer),timer=setTimeout(function(){$("#scandocPdfContent").contents().find("#viewerContainer").on("scroll",function(){scandocPdfScroll()})},300)}}function scandocPdfScroll(){if(2==pdfLoadFlag){$("#textPdfContent").contents().find("#viewerContainer").unbind("scroll");var e=$("#scandocPdfContent").contents().find("#viewerContainer").scrollTop()/$("#scandocPdfContent").contents().find("#viewer").height()*$("#textPdfContent").contents().find("#viewer").height();$("#textPdfContent").contents().find("#viewerContainer").scrollTop(e),clearTimeout(timer),timer=setTimeout(function(){$("#textPdfContent").contents().find("#viewerContainer").on("scroll",function(){textPdfScroll()})},300)}}function customScale(){var e=$("#scalevalue").val(),t=/(^[1-9]{1}[0-9]*$)|(^[0-9]*\.[0-9]{2}$)/;t.test(e)?(document.getElementById("textPdfContent").contentWindow.PDFViewerApplication.pdfViewer.currentScaleValue=e,document.getElementById("scandocPdfContent").contentWindow.PDFViewerApplication.pdfViewer.currentScaleValue=e):layer.msg("请输入大于0的整数或者保留两位小数",{icon:2})}function panelAction(e,t,n,o,a){$(e).off("click").on("click",function(){var e=$(this),i=e.closest(t),r=i.nextAll(n).first(),s=e.find(".fa");r.slideToggle(200),s.toggleClass(o).toggleClass(a)})}var parm=App.getPresentParm(),config=top.globalConfig,serverPath=config.serverPath,pdfLoadFlag=0,timer=null,verifyId=null,isDifferences=null,isLeader=null,relationId=null,contractId=null,associateCodeInfo=new Array;App.formAjaxJson(serverPath+"dicts/listChildrenByDicttId","post",JSON.stringify({dictId:9030}),succssCallback,null,null,null,!1),$(function(){1==parm.pageType?($(".portlet-title,.toolbarBtn").remove(),$(".page-content,.portlet-body").css("padding","0px"),$(".portlet").css("cssText","border:none !important;padding:0px"),$(".page-content").removeClass("hidden"),verifyId=parm.businessKey,"db"==parm.taskFlag?$("#setExplain").removeClass("hidden"):$("#setExplain").remove(),isLeader="YZSP"==parm.taskDefinitionKey?!0:!1):2==parm.pageType&&($(".page-content").removeClass("hidden"),$("#setExplain").remove(),verifyId=parm.verifyId,App.fixToolBars("toolbarBtnContent",70)),getScanValidationInfo(verifyId)}),$("#differenceTbody").on("click","tr",function(){console.log(this);var e=$(this).data("textpageno");document.getElementById("textPdfContent").contentWindow.PDFViewerApplication.page=e,pdfApiSearch("textPdfContent",$(this).children().eq(1)),document.getElementById("scandocPdfContent").contentWindow.PDFViewerApplication.page=e,pdfApiSearch("scandocPdfContent",$(this).children().eq(2))}),$("#pdfScaleSelect").change(function(){"custom"==$(this).val()?$("#customScale").removeClass("hidden"):($("#customScale").addClass("hidden"),document.getElementById("textPdfContent").contentWindow.PDFViewerApplication.pdfViewer.currentScaleValue=$(this).val(),document.getElementById("scandocPdfContent").contentWindow.PDFViewerApplication.pdfViewer.currentScaleValue=$(this).val())});
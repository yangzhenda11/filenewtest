<style type="text/css">
	#fileUploadModalBody{
		overflow: auto;
	}
	.fileUploadModalForm{
		padding-top: 20px;
		padding-bottom: 20px;
	}
	.fileUploadModalForm .form-group{
		display:table;
	}
	.fileUploadModalForm .form-group > label{
		width: 18%;
	    min-height: 1px;
	    line-height: 16px;
	    padding:0 10px 0 0;
	    vertical-align:middle;    
	    display:table-cell;
	    text-align: right;
	}
	.fileUploadModalForm .form-group > .valiParent{
		width: 100%;
		float: left;
	  	position: relative;
	    min-height: 1px;
	    padding-left: 10px;
	    padding-right: 10px;
	}
	.aDisable{
		background: #e8dcdc;
		pointer-events:none
	}
	.fileUploadModalForm table{
		margin-bottom: 10px;
	}
</style>
<div class="modal-dialog" role="document">
	<div class="modal-content">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="fileUploadModalLabel"></h4>
		</div>
			<div class="modal-body fileUploadModalForm" id="fileUploadModalBody">
                <div class="form-group col-sm-12">
                    <label for="partnerCode" class="control-label">文件</label>
                    <div class="valiParent">
                        <input type="file" id="uploadFileName" name="fileName" />
                    </div>
                </div>
               	<div class="form-group col-sm-12">
                    <label for="partnerCode" class="control-label">上传说明</label>
                    <div class="valiParent" id="fileUpliadExplain" style="color: red;">
                        <i class="iconfont icon-mi required"></i>文件大小不能超过100M。
                    </div>
                </div>
           </div>
		<div class="modal-footer">
			<button type="button" class="btn btn-default btn-circle" data-dismiss="modal"><i class="iconfont icon-close"></i>关闭</button>
		</div>
	</div>
</div>

<script type="text/javascript">
	//系统全局变量获取
	var config = top.globalConfig;
	var fileUploadPath = config.fileUploadPath;
	var successCallback = null;
	var fileCommonUploadObj = [];
	var fileUploadFlag = 1;
	var needChangeName = false;
	function setParm(setting,queryCallback){
		if(App.IEVersionVA(10)){
			layer.alert("您的浏览器版本较低，请升级到最新IE浏览器(IE9+ 不包括IE9)或使用谷歌、360等浏览器来上传文件",{icon:2},function(index){
				layer.close(index);
				$("#commomModal").modal("hide");
			});
		}
		var fileUploadModalLabel = setting.title == undefined ? "文件上传" : setting.title;
		$("#fileUploadModalLabel").text(fileUploadModalLabel);
		$("#fileUpliadExplain").append(setting.explain);
		$("#commomModal").modal("show");
		var emptyFn = function(){};
		successCallback = queryCallback == null || queryCallback == "" ? emptyFn : queryCallback;
		var uploadAsync = setting.uploadAsync == undefined ? true : setting.uploadAsync;
		var maxFileSize = setting.maxFileSize == undefined ? 102400 : setting.maxFileSize;
		var fileExtensions = [];
		if(setting.fileExtensions){
			fileExtensions = setting.fileExtensions;
		};
		if(setting.isUploadFile == false){
			var extraData = {};
		}else{
			var extraData = {displayName:""};
			if(setting.extraData){
				$.each(setting.extraData, function(k,v) {
					extraData[k] = v;
				})
			};
			var displayName = extraData.displayName;
			if(displayName.indexOf("&^&") != -1){
				needChangeName = true;
				extraData.displayName = displayName.substring(0,displayName.length-3);
			}
		};
		initFileUpload(setting.url,uploadAsync,fileExtensions,extraData,maxFileSize);
	}
	/*
	 * 文件上传
	 */
	function initFileUpload(url,uploadAsync,fileExtensions,extraData,maxFileSize){
		$("#uploadFileName").fileinput({
	        language: 'zh', 
	        uploadUrl: fileUploadPath + url,
	        uploadAsync: uploadAsync,
	        allowedFileExtensions: fileExtensions,
	        maxFileSize: maxFileSize,
	       	maxFileCount: 1,
	       	dropZoneEnabled: false,
	       	notallowedFilenameExtensions:" |%",//文件名中不允许出现的字符
	       	//showPreview : false,
	        slugCallback: function (filename) {
	        	if(needChangeName){
	        		if(extraData.displayName.indexOf(".") == -1){
	        			var fileNameList = filename.split(".");
	        			extraData.displayName = extraData.displayName + "." + fileNameList[fileNameList.length-1];
	        		}
	        	}
	        	if($(".kv-fileinput-error").css("display") == "block"){
	        		$(".fileinput-upload-button").addClass("aDisable");
	        		$(".fileinput-upload-button").attr("title","禁止上传");
	        	}else{
	        		$(".fileinput-upload-button").removeClass("aDisable");
	        		$(".fileinput-upload-button").attr("title","点击上传");
	        	}
	            return filename;
	        },
	        uploadExtraData: function(previewId, index) {
				return extraData;							//额外参数
			}
	    });
	    // 异步上传成功结果处理
	    $("#uploadFileName").on("fileuploaded", function (event, data) {
	    	parseResult(data);
	    });
	    // 同步上传成功结果处理
	    $("#uploadFileName").on("filebatchuploadsuccess", function (event, data) {
	    	parseResult(data);
	    });
	    //异步上传错误结果处理
	    $('#uploadFileName').on("fileerror", function(event, data, msg) {
			console.log("错误");
		});
		//同步上传错误结果处理
		$('#uploadFileName').on("filebatchuploaderror", function(event, data, msg) {
			console.log("错误");
		});
	    function parseResult(data){
	    	if(data.response.status == 1){
	    		layer.msg("上传成功");
	    		if(data.extra.displayName == "" || data.extra.displayName == undefined){
	    			var fileName = data.files[0].name;
	    		}else{
	    			var fileName = data.extra.displayName;
	    		};
	    		var itemInfo = {
	    			name:fileName,
	    			data:data.response.data
	    		};
	    		fileCommonUploadObj.push(itemInfo);
	    		successCallback();
	    	}else{
	    		layer.alert(data.response.message,{icon:2,title:"错误"});
	    	}
	    }
	}
    /*
     * 获取上传结果
     */
    function getFileItemInfo(){
    	return fileCommonUploadObj;
    }
</script>

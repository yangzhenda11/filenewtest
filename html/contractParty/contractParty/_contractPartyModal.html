<div class="modal-dialog" role="document">
    <div class="modal-content">
        <form class="form-horizontal" role="form" id="contractEditForm">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">签约主体管理</h4>
            </div>
            <div class="modal-body defaultModalForm">
                <div class="form-group col-sm-11">
                    <input type="hidden" name="partnerId" id="partnerId" value="" />
                    <label for="partnerNameM" class="control-label">签约主体名称</label>
                    <div class="col-sm-10" id="partnerNameM"></div>
                </div>
                <div class="form-group col-sm-11">
                    <label for="partnerCode" class="control-label">关联编码<i class="iconfont icon-mi required"></i></label>
                    <div class="valiParent">
                        <select id="partnerCode" data-allowSearch='5' name="associateCode" class="form-control" value="906520">
                        </select>
                    </div>
                </div>
                <div class="form-group col-sm-11">
                    <label for="isPartner" class="control-label">是否联通方<i class="iconfont icon-mi required"></i></label>
                    <div class="valiParent">
                        <select id="isPartnerM" name="isUnicomOrg" onchange="changeIsunicom()" class="form-control select2me">
                        	<option value="">是阿萨德</option>
							<option value="0">是</option>
							<option value="1">否</option>
						</select>
                    </div>
                </div>
                <div id="isunicom" class="hide">
                    <div class="form-group col-sm-11">
                        <label for="organisation" class="control-label">所属组织<i class="iconfont icon-mi required"></i></label>
                        <div class="valiParent input-group">
                            <input id="organisation" onclick="showTree('organisation')" readonly name="organisationTree" type="text" class="form-control" />
                            <span class="input-group-addon"><i class="iconfont icon-xuanzehang"></i></span>
                            <div id="organisationContent" class="zTreeContent selectZTreeCount">
                                <ul id="organisationTree" class="ztree"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-sm-11">
                        <label for="ouOrgId" class="control-label">OU组织名称<i class="iconfont icon-mi required"></i></label>
                        <div class="valiParent">
                            <input type="text" class="form-control" name="ouOrgId" id="ouOrgId" value="" />
                        </div>
                    </div>
                    <div class="form-group col-sm-11">
                        <label for="legal" class="control-label">法人代表<i class="iconfont icon-mi required"></i></label>
                        <div class="valiParent input-group">
                            <input id="legal" onclick="showTree('legal')" readonly name="legalTree" type="text" class="form-control" />
                            <span class="input-group-addon"><i class="iconfont icon-xuanzehang"></i></span>
                            <div id="legalContent" class="zTreeContent selectZTreeCount">
                                <ul id="legalTree" class="ztree"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-sm-11">
                        <label for="other" class="control-label">其他映射组织<i class="iconfont icon-mi required"></i></label>
                        <div class="valiParent input-group">
                            <input id="other" onclick="showTree('other')" readonly name="otherTree" type="text" class="form-control" />
                            <span class="input-group-addon"><i class="iconfont icon-xuanzehang"></i></span>
                            <div id="otherContent" class="zTreeContent selectZTreeCount">
                                <ul id="otherTree" class="ztree"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-danger btn-circle"><i class="iconfont icon-baocun"></i> 保存</button>
                <button type="button" class="btn btn-default btn-circle" data-dismiss="modal"><i class="iconfont icon-close"></i> 关闭</button>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript">
    /*
     * 获取签约主体详情
     */
    function getContractInfo(data) {
        $('#modal').modal('show');
        App.initFormSelect2("#contractEditForm");
        var ajaxObj = {
        	"url" : serverPath + "dicts/listChildrenByDicttId",
        	"type" : "post",
        	"data" : {"dictId": 89},
        	"async" : false
        }
        App.initAjaxSelect2("#partnerCode",ajaxObj,"","dictValue","dictLabel","iiiiiii");
        var url = serverPath + "orgPartner/" + data;
        App.formAjaxJson(url, "POST", "", successCallback);

        function successCallback(result) {
            var data = result.data;
            $("#partnerId").val(data.partnerId);
            $("#partnerNameM").text(data.partnerName);
            $("#partnerCode").val(data.associateCode).trigger('change');
            $("#isPartnerM").val(data.isUnicomOrg).trigger('change');
            if (data.isUnicomOrg == 0) {
                $("#isunicom").removeClass("hide");
                $("#ouOrgId").val(data.ouOrgId);
                $("#organisation").val(data.orgName);
                $("#organisation").data("id", data.orgId);
                $("#organisation").attr("title", data.orgName);
                $("#legal").val(data.staffName);
                $("#legal").data("id", data.legalPersonName);
                $("#legal").attr("title", data.staffName);
                $("#other").val(data.otherOrgName);
                $("#other").data("id", data.otherOrgId);
                $("#other").attr("title", data.otherOrgName);
                getTreeInfo();
            } else {
                $("#organisation,#legal,#other").data("id", "");
                $("#organisation,#legal,#other").attr("title", "");
                $("#organisation,#legal,#other,#ouOrgId").val("");
            };
            validate();
        }
    }
    /*
     * 是否联通方切换
     */
    function changeIsunicom() {
        var isPartnerValue = $("#isPartnerM").val();
        if (isPartnerValue == 0) {
            $("#isunicom").removeClass("hide");
            getTreeInfo();
        } else {
            $("#isunicom").addClass("hide");
            $("#organisation,#legal,#other").data("id", "");
            $("#organisation,#legal,#other").attr("title", "");
            $("#organisation,#legal,#other,#ouOrgId").val("");
        }
    }
    /*
     * 获取树信息
     */
    function getTreeInfo() {
        /*
         * 所属组织树配置
         *  orgs/{orgId}/orgTree
         */
        App.formAjaxJson(serverPath + "orgs/" + config.curOrgId + "/orgTree", "get", "", successCallback);

        function successCallback(result) {
            var data = result.data;
            if (null == data) {
                layer.msg("没有相关组织和人员信息", {
                    icon: 2
                });
            } else {
                var otherTreeResult = otherFilter("", "", result);
                organisationTree = $.fn.zTree.init($("#organisationTree"), orgsSetting, data);
                otherTree = $.fn.zTree.init($("#otherTree"), otherSetting, otherTreeResult);
                var otherIds = $("#other").data("id");
                var otherTreeObj = $.fn.zTree.getZTreeObj("otherTree");
                if (otherIds) {
                    otherIdsArr = otherIds.split(",");
                    for (var i = 0; i < otherIdsArr.length; i++) {
                        var nodes = otherTreeObj.getNodesByParam("orgId", otherIdsArr[i], null);
                        if (nodes.length > 0) {
                            otherTreeObj.checkNode(nodes[0], true, false);
                        }
                    }
                }
            }
        }
        /*
         * 所属人员树配置
         *  roles/orgStaffsTreeRoot
         * get  data:{"curOrgId":curOrgId}
         */
        $.get(serverPath + "roles/orgStaffsTreeRoot", {
            "curOrgId": config.curOrgId
        }, function(result) {
            if (null == result) {
                layer.msg("没有相关组织和人员信息", {
                    icon: 2
                });
            } else {
                legalTree = $.fn.zTree.init($("#legalTree"), legalSetting, result);
                curOrgStaffNode = legalTree.getNodes()[0];
            }
        });
    }

    /*
     * 修改提交
     */
    function saveContract() {
        var formObj = App.getFormValues($("#contractEditForm"));
        formObj.partnerName = $("#partnerNameM").text();
        App.changeObjKey({
            "legalTree": "legalPersonName",
            "organisationTree": "orgId",
            "otherTree": "otherOrgId"
        }, formObj)
        formObj.orgId = $("#organisation").data("id");
        formObj.legalPersonName = $("#legal").data("id");
        formObj.otherOrgId = $("#other").data("id");
        App.formAjaxJson(serverPath + "orgPartner", "PUT", JSON.stringify(formObj), successCallback);

        function successCallback(result) {
            layer.msg("修改成功", {
                icon: 1
            });
            searchContract(true);
            $('#modal').modal('hide');
        }
    }
    /*
     * 表单验证
     */
    function validate() {
        $('#contractEditForm').bootstrapValidator({
            live: 'enabled',
            trigger: 'live focus blur keyup change',
            message: '校验未通过',
            container: 'popover',
            fields: {
                associateCode: {
                    validators: {
                        notEmpty: {
                            message: '请选择关联编码'
                        }
                    }
                },
                isUnicomOrg: {
                    validators: {
                        notEmpty: {
                            message: '请选择是否是联通方'
                        }
                    }
                },
                organisationTree: {
                    validators: {
                        notEmpty: {
                            message: '请选择所属组织'
                        }
                    }
                },
                ouOrgId: {
                    validators: {
                        notEmpty: {
                            message: '请输入OU组织名称'
                        }
                    }
                },
                legalTree: {
                    validators: {
                        notEmpty: {
                            message: '请选择法人代表'
                        }
                    }
                },
                otherTree: {
                    validators: {
                        notEmpty: {
                            message: '请选择其他映射组织'
                        }
                    }
                }
            }
        }).on('success.form.bv', function(e) {
            e.preventDefault();
            saveContract();
        });
    }
    /*
     * 显示所属组织树
     */
    function showTree(dom) {
        var selectObj = $("#" + dom + "");
        var selectOffset = selectObj.offset();
        $("#" + dom + "Content").css({
            left: "10px",
            top: selectObj.outerHeight() + "px",
            width: selectObj.outerWidth() + 40
        }).slideDown("fast");
        onBodyDown(dom);
    }
    /*
     * 隐藏所属组织树
     */
    function hideMenu(dom) {
        $("#" + dom + "Content").fadeOut("fast");
        $("body").unbind("mousedown", onBodyDown);
    }
    /*
     * 组织树点击事件
     */
    function onBodyDown(dom) {
        $("body").on("mousedown", function(event) {
            if (!(event.target.id == dom || event.target.id == dom + "Content" || $(event.target).parents("#" + dom + "Content").length > 0)) {
                hideMenu(dom);
            }
        });
    }
    /*
     * 所属组织树配置单选
     */
    var orgsSetting = {
        async: {
            enable: true,
            url: "",
            type: "get",
            dataType: 'json',
            dataFilter: orgsfilter
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "orgId",
                pIdKey: "parent_id"
            },
            key: {
                name: "orgName"
            }
        },
        view: {
            dblClickExpand: false
        },
        callback: {
            onAsyncError: onAsyncError,
            beforeClick: beforeClick,
            onClick: onClick,
            beforeAsync: zTreeBeforeAsync
        }
    };

    function orgsfilter(treeId, parentNode, responseData) {
        var responseData = responseData.data;
        if (responseData) {
            return responseData;
        } else {
            return null;
        }
    }

    /*
     * 所属人员树配置单选
     */
    var legalSetting = {
        async: {
            enable: true,
            url: serverPath + "roles/" + curOrgStaffRole + "/orgStaffsTreeChildren",
            type: "get",
            dataType: 'json',
            dataFilter: orgsFilter,
            otherParam: {
                "orgId": function() {
                    return curOrgStaffNode.id
                }
            },
        },
        data: {
            simpleData: {
                enable: true,
            }
        },
        view: {
            dblClickExpand: false
        },
        callback: {
            onAsyncError: onAsyncError,
            beforeClick: beforeClick,
            onClick: onClick,
            beforeAsync: zTreeBeforeAsync
        }
    };

    function orgsFilter(treeId, parentNode, responseData) {
        var responseData = responseData.children;
        if (responseData) {
            return responseData;
        } else {
            return null;
        }
    }
    /*
     * 所属组织树多选配置
     */
    var otherSetting = {
        async: {
            enable: true,
            url: "",
            type: "get",
            dataType: 'json',
            dataFilter: otherFilter
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "orgId",
                pIdKey: "parent_id"
            },
            key: {
                name: "orgName"
            }
        },
        check: {
            enable: true
        },
        callback: {
            onCheck: onCheck,
            onAsyncError: onAsyncError,
            onAsyncSuccess: onAsyncSuccess,
            beforeAsync: zTreeBeforeAsync
        }
    }

    function otherFilter(treeId, parentNode, responseData) {
        var responseData = responseData.data;
        if (responseData.length > 0) {
            for (var i = 0; i < responseData.length; i++) {
                if ("true" == responseData[i].isParent) {
                    responseData[i].nocheck = true;
                }
            }
        }
        return responseData;
    }

    function zTreeBeforeAsync(treeId, treeNode) {
        if (treeId == "organisationTree") {
            organisationTree.setting.async.url = serverPath + "orgs/" + treeNode.orgId + "/children";
        } else if (treeId == "otherTree") {
            otherTree.setting.async.url = serverPath + "orgs/" + treeNode.orgId + "/children";
        } else if (treeId == "legalTree") {
            curOrgStaffNode = treeNode;
        }
        return true;
    }
    /*
     * ztree异步加载成功事件
     */
    function onAsyncSuccess(event, treeId, treeNode, msg) {
        var otherIds = $("#other").data("id");
        var treeObj = $.fn.zTree.getZTreeObj(treeId);
        if (otherIds) {
            otherIdsArr = otherIds.split(",");
            for (var i = 0; i < otherIdsArr.length; i++) {
                var nodes = treeObj.getNodesByParam("orgId", otherIdsArr[i], null);
                if (nodes.length > 0) {
                    treeObj.checkNode(nodes[0], true, false);
                }
            }
        }
    }

    /*
     * ztree点击事件之前
     */
    function beforeClick(treeId, treeNode) {
        var check = (treeNode && !treeNode.isParent);
        return check;
    }
    /*
     * ztree点击事件
     */
    function onClick(event, treeId, treeNode) {
        var nodes = $.fn.zTree.getZTreeObj(treeId).getSelectedNodes();
        if (treeId == "organisationTree") {
            var selectName = nodes[0].orgName;
            var selectId = nodes[0].orgId;
            $("input[name=" + treeId + "]").val(selectName);
            $("#contractEditForm").data("bootstrapValidator").updateStatus("organisationTree", "NOT_VALIDATED", null);
            $("#contractEditForm").data("bootstrapValidator").validateField('organisationTree');
        } else if (treeId == "legalTree") {
            var selectName = nodes[0].name;
            var selectId = nodes[0].id;
            $("input[name=" + treeId + "]").val(selectName);
            $("#contractEditForm").data("bootstrapValidator").updateStatus("legalTree", "NOT_VALIDATED", null);
            $("#contractEditForm").data("bootstrapValidator").validateField('legalTree');
        };
        $("input[name=" + treeId + "]").data("id", selectId);
        $("input[name=" + treeId + "]").attr("title", selectName);
    }
    /*
     * ztree选中事件
     */
    function onCheck(event, treeId, treeNode) {
        var treeObj = $.fn.zTree.getZTreeObj(treeId);
        var nodes = treeObj.getCheckedNodes(true);
        var idAll = [],
            nameAll = [];
        for (var i = 0; i < nodes.length; i++) {
            idAll.push(nodes[i].orgId);
            nameAll.push(nodes[i].orgName)
        }
        $("input[name=" + treeId + "]").data("id", idAll.join(","));
        $("input[name=" + treeId + "]").attr("title", nameAll.join(","));
        $("input[name=" + treeId + "]").val(nameAll.join(","));
        if (treeId == "otherTree") {
            $("#contractEditForm").data("bootstrapValidator").updateStatus("otherTree", "NOT_VALIDATED", null);
            $("#contractEditForm").data("bootstrapValidator").validateField('otherTree');
        }
    }
</script>
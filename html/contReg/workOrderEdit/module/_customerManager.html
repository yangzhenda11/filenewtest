<div class="form-fieldset">
	<div class="form-fieldset-title">
		<span><i class="iconfont icon-layers"></i> 选择客户经理</span>
		<div class="form-fieldset-tools">
			<a href="#" class="form-collapse"><i class="fa fa-angle-up"></i></a>
		</div>
	</div>
	<div class="form-fieldset-body">
		<div class="row" id="customerManagerContent">
			<div class="tableToobarContent hidden" id="customerManagerToolbar">
				<button type="button" class="btn red" onclick="addCustomerManager()">添加客户经理</button>
				<button type="button" class="btn red marginLeft15" onclick="delectCustomerManager()">删除客户经理</button>
			</div>
			<table class='table table-hover table-bordered table-striped table-align' id="customerManagerTable">
				<thead>
					<tr>
						<th class="cusManagerCheckbox"><label class='ui-checkbox'><input type='checkbox' name='customerManagerCheckAll' id="customerManagerCheckAll"><span></span></label></th>
						<th>客户经理</th>
						<th>客户经理所属组织</th>
					</tr>
				</thead>
				<tbody id="customerManagerTbody">
					<tr class="emptyTr">
						<td colspan="3">暂无客户经理信息</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
<script type="text/javascript">
	var customerManagerTree = null;

	/*
	 * 设置页面的id值，由保存和提交后回调
	 */
	function setPageId_customerManagerListId(value){
		var valueKey = 0;
		$.each($("#customerManagerTbody tr"), function(k,v) {
			if(!$(v).hasClass("emptyTr")){
				if($(v).data("id") != undefined){
					$(v).data("id",value[valueKey]);
					valueKey++;
				}
			}
		});
	}
	/*
	 * 返回本页面数据，若无返回{}，若不提交本页面的值可删除此方法
	 * isSubmit 提交时为true,判断页面是否要加逻辑上的验证(bootstrap-validator验证除外)
	 */
	function getValue_customerManagerList(isSubmit){
		var customerManagerList = [];
		$.each($("#customerManagerTbody tr"),function(k,v){
			if(!$(v).hasClass("emptyTr")){
				var customerManagerItem = {};
				customerManagerItem.wcardId = wcardId;
				customerManagerItem.contractNumber = contractNumber;
				customerManagerItem.managerId = $(v).data("id");
				customerManagerItem.managerStaffOrgId = $(v).data("stafforgid");
				customerManagerItem.managerOrgId = $(v).data("parentid");
				customerManagerItem.managerStaffName = $(v).children().eq(1).text();
				customerManagerItem.managerOrgName = $(v).children().eq(2).text();
				customerManagerList.push(customerManagerItem);
			}
		});
		//当合同提交时，加校验"至少添加一条客户经理信息";
		if(isSubmit){
			if(customerManagerList.length > 0){
				return customerManagerList;
			}else{
				layer.msg("请至少添加一条客户经理信息");
				srolloOffect("#customerManagerList");
				return false;
			}
		}else{
			return customerManagerList;
		}
	}
	
	//获取客户经理信息
	getCustomerManagerInfo();
	/*
	 * 获取客户经理信息
	 */
	function getCustomerManagerInfo() {
		var url = serverPath + "contractOrderEditorController/listContractCustomerManager";
		var postData = JSON.stringify({wcardId:wcardId});
		App.formAjaxJson(url, "post", postData, successCallback);

		function successCallback(result) {
			var data = result.data;
			if(data.length > 0){
				var html = "";
				for(var i = 0; i < data.length; i++){
					html += '<tr data-id="'+data[i].managerId+'" data-stafforgid="'+data[i].managerStaffOrgId+'" data-parentid="'+data[i].managerOrgId+'">'+
	    						'<td class="cusManagerCheckbox"><label class="ui-checkbox"><input type="checkbox" name="customerManagerCheck"><span></span></label></td>'+
	    						'<td>'+data[i].managerStaffName+'</td>'+
	    						'<td>'+data[i].managerOrgName+'</td></tr>';
				};
				
    			$("#customerManagerTbody").html(html);
    			App.checkAllFn("#customerManagerCheckAll","customerManagerCheck");
			};
			/*
			 * isEdit 判断页面是否只能查看
			 */
			if(!isEdit){
				$("#customerManagerTable").find("input").attr("disabled","disabled");
				$("#customerManagerToolbar,.cusManagerCheckbox").remove();
			}else{
				$("#customerManagerToolbar").removeClass("hidden");
			};
		}
	}
	/*
	 * 显示选人modal，生成选人树
	 */
	function addCustomerManager(){
		$("#customerManagerChecked").html("");
		var documentHeight = $(".page-content").height() - 225;
    	$("#customerManagerCotent,#customerManagerChecked").css("height", documentHeight);
		initCustomerManagerTree();
	}
	//生成树
    function initCustomerManagerTree() {
    	var performerType = 0;
        //选择履行人ztree树配置
        var treeSetting = {
			async: {
				enable: true,
				url: serverPath + "contractType/listPerformer",
				type: "post",
				dataType: 'json',
				dataFilter: orgsfilter,
				autoParam: ["id=orgId","executorType"]
			},
			data: {
				simpleData: {
					enable: true,
					idKey: "id",
					pIdKey: "parentId"
				},
				key: {
					name: "name"
				}
			},
			view: {
				selectedMulti: false,
				dblClickExpand: false
			},
			callback: {
				onAsyncError: onAsyncError,
				onDblClick: setInputInfo
			}
		};
		function orgsfilter(treeId, parentNode, responseData) {
			if(responseData.status == 1){
				var data = responseData.data;
				if(data){
					for(var i = 0; i < data.length; i++){
	        			if(data[i].orgType != ""){
	        				data[i].isParent = "true";
	        			};
	        			data[i].executorType = performerType;
		        	};
		        	return data;
				}else{
					return null;
				}
			}else{
				layer.msg(responseData.message);
				return null;
			}
		}
        // 获取第一层数据
        $.ajax({
	        url : serverPath + 'contractType/listPerformer',
	        type : "post",
	        data : {'orgId':'','executorType':performerType},
	        success : function(result) {
				if (result.status == 1) {
					$("#customerManagerModal").modal("show");
					var data = result.data;
		        	if (data != "") {
		        		for(var i = 0; i < data.length; i++){
		        			if(data[i].orgType != ""){
		        				data[i].isParent = "true";
		        			};
		        			data[i].executorType = performerType;
			        	};
		                if (customerManagerTree) {
		                    customerManagerTree.destroy();
		                }
		                customerManagerTree = $.fn.zTree.init($("#customerManagerTree"), treeSetting, data);
                 		//默认展开第一层
			            var nodes = customerManagerTree.getNodes();
			            customerManagerTree.expandNode(nodes[0]);
		            } else {
		                layer.msg("暂无数据，请稍后重试");
		            }
				} else {
					var ms = result.message;
					layer.msg(ms);
				};
	        },
	        error: function(result) {
				App.ajaxErrorCallback(result);
			}
	   	});
        function setInputInfo(event, treeId, treeNode) {
            addCustomerManagerValue(treeNode);
        }
    }
    /*
     * 判断是否选的是人员
     */
    function addCustomerManagerValue(treeNode) {
        if (treeNode.orgType == "" || treeNode.orgType == undefined) {
        	var fullName = treeNode.fullName;
        	var parentId = treeNode.parentId;
        	var name = treeNode.name;
        	var staffOrgId = treeNode.staffOrgId;
        	var isExist = false;
        	$.each($(".customerManagerItem"),function(k,v){
        		if($(v).data("stafforgid") == staffOrgId){
        			isExist = true;
        		}
        	});
        	if(!isExist){
    			var html = '<div class="customerManagerItem" data-stafforgid="'+staffOrgId+'" data-fullname="'+fullName+'" data-parentid="'+parentId+'">'+
        				'<span>'+name+'</span>'+
        				'</div>';
    			$("#customerManagerChecked").append(html);
    		};
        } else {
            layer.msg("请选择具体的人员", {
                icon: 2
            })
        }
    }
    /*
     * 增加右侧内容
     */
    function setCustomerManagerValue(){
    	var treeNode = customerManagerTree.getSelectedNodes()[0];
        if (treeNode == undefined) {
            layer.msg("请选择人员", {icon: 2})
        } else {
            addCustomerManagerValue(treeNode);
        }
    }
    /*
     * 删除右侧内容
     */
    function delCustomerManagerValue(){
		if($(".customerManagerCheck").length == 0){
			layer.msg("请点击选择人员名称后进行删除", {icon: 2})
		}else{
			$.each($(".customerManagerCheck"), function(k,v) {
				$(v).parent().remove();
			});
		}
    }
    /*
     * modal确定按钮点击
     */
    function setCustomerManagerTable(){
    	$("#customerManagerModal").modal("hide");
    	if($(".customerManagerItem").length > 0){
    		if($("#customerManagerTbody .emptyTr")[0] != undefined){
				$("#customerManagerTbody .emptyTr").remove();
			};
			$.each($(".customerManagerItem"), function(k,v) {
				var stafforgid = $(v).data("stafforgid");
				var name = $(v).text();
				var isExist = false;
				$.each($("#customerManagerTbody tr"),function(m,n){
					if(stafforgid == $(n).data("stafforgid")){
						isExist = true;
					}
				})
				if(!isExist){
					var html = '<tr data-id="100000" data-stafforgid="'+$(v).data("stafforgid")+'" data-parentid="'+$(v).data("parentid")+'">'+
	    						'<td class="cusManagerCheckbox"><label class="ui-checkbox"><input type="checkbox" name="customerManagerCheck"><span></span></label></td>'+
	    						'<td>'+name+'</td>'+
	    						'<td>'+$(v).data("fullname")+'</td></tr>';
	    			$("#customerManagerTbody").append(html);
				}
			})
			App.checkAllFn("#customerManagerCheckAll","customerManagerCheck");
    	}
    }
    
	/*
	 * 删除履行人
	 */
	function delectCustomerManager(){
		var checkLength = $("input[name='customerManagerCheck']:checked").length;
		if(checkLength == 0){
			layer.msg("请勾选客户经理复选框进行删除")
		}else{
			layer.confirm("是否删除？",{icon:7,title:"删除"},function(index){
				layer.close(index);
				$("input[name='customerManagerCheck']:checked").each(function(k,v){
					$(v).parents("tr").remove();
				});
				addCustomerManagerTbodyEmptyTr();
				App.checkAllFn("#customerManagerCheckAll","customerManagerCheck");
			})
		}
	};
	/*
	 * 若为空增加empty值
	 */
	function addCustomerManagerTbodyEmptyTr(){
		if($("#customerManagerTbody tr").length == 0){
			var html = '<tr class="emptyTr"><td colspan="3">暂无客户经理信息</td></tr>';
			$("#customerManagerTbody").html(html);
		}
	}
	/*
	 * 人员选择点击	事件委托
	 */
	$("#customerManagerChecked").on("click","span",function(){
		if($(this).hasClass("customerManagerCheck")){
			$(this).removeClass("customerManagerCheck");
		}else{
			$(this).addClass("customerManagerCheck");
		}
	})
</script>
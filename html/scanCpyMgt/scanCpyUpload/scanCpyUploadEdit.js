function checkFileIsUpload(){var t=serverPath+"contractUpload/checkFileIsUpload?id="+id;$.ajax({url:t,type:"post",success:function(t){if(1==t.count){var a=t.contractNumber+"正文扫描件.pdf",e="<div class='col-sm-12 control-label paddingLR0'><a href='/contractUpload/downloadS3?key1="+t.storeId+"'>"+a+"</a></div>";document.getElementById("fileNameDiv").innerHTML=e,$("#uploadFileNameshow").val(a),$("#uploadFile_div2").show(),$("#uploadFile_div1").hide()}else $("#uploadFile_div2").hide(),$("#uploadFile_div1").show()},error:function(t){App.ajaxErrorCallback(t)}})}function getContractInfo(){var t=serverPath+"contractUpload/getContractById?id="+id;$.ajax({url:t,type:"post",success:function(t){$("#contractNumber").val(t.data.contractNumber),$("#undertakeName").val(t.data.undertakeName),$("#undertakePhone").val(t.data.undertakePhone),$("#undertakeMobile").val(t.data.undertakeMobile),$("#contractName").val(t.data.contractName),$("#executeDeptName").val(t.data.executeDeptName),$("#unicomPartyName").text(t.data.unicomPartyName),$("#oppoPartyName").text(t.data.oppoPartyName);var a=t.data.contractType,e=document.getElementById("contractType");e.innerText=a,$("#contractType").html(a)},error:function(t){App.ajaxErrorCallback(t)}})}function backPage(){window.history.go(-1)}function downLoad(t){t=$("#att"+t).val(),window.location.href=serverPath+"contractUpload/downloadS3?key1="+t}function addAttachment(t){function a(){var a=getFileItemInfo();$("#commomModal").modal("hide"),0!=a.length&&(array.push(a[0].data),$("#att"+t).val(a[0].data.storeId),$("#addButton"+t).hide(),$("#downLoadButton"+t).show(),$("#delButton"+t).show())}var e={title:"文件上传",url:"contractUpload/uploadFile",maxNumber:1,extraData:{attachId:t}};App.getFileUploadModal(e,a)}function del(t){if(console.log(attArray),0!=attArray.length)for(var a=0;a<attArray.length;a++)t==attArray[a].attachId&&(deleteArray.push(attArray[a]),attArray.splice(a,1));for(var a=0;a<array.length;a++)t==array[a].attachId&&(deleteArray.push(array[a]),array.splice(a,1));console.log(array),console.log(deleteArray),$("#addButton"+t).show(),$("#downLoadButton"+t).hide(),$("#delButton"+t).hide()}function fileUpload(){function t(){var t=getFileItemInfo();if($("#commomModal").modal("hide"),0!=t.length){result=t[0].data,console.log(result),$("#uploadFileNameshow").val(a);var e="<div class='col-sm-12 control-label paddingLR0'><a href='/contractUpload/downloadS3?key1="+result.storeId+"'>"+a+"</a></div>";document.getElementById("fileNameDiv").innerHTML=e,$("#uploadFile_div1").hide(),$("#uploadFile_div2").show()}}var a=$("#contractNumber").val()+"正文扫描件.pdf",e={title:"文件上传",url:"contractUpload/uploadFile",maxNumber:1,fileExtensions:["pdf"],extraData:{attachId:"",displayName:a}};App.getFileUploadModal(e,t)}function delScan(){$("#uploadFileNameshow").val(""),$("#uploadFile_div1").show(),$("#uploadFile_div2").hide(),result={}}function saveContractText(){var t=JSON.stringify(result);$.ajax({url:serverPath+"contractUpload/saveContract",type:"post",data:{jsonStr:t,id:id},success:function(t){"1"==t.status?layer.msg(t.message):"0"==t.status&&layer.msg(t.message)},error:function(t){App.ajaxErrorCallback(t)}})}function delContractText(){var t=serverPath+"contractUpload/delContractText?id="+id;$.ajax({url:t,type:"post",success:function(t){"1"==t.status||"0"==t.status&&layer.msg(t.message)},error:function(t){App.ajaxErrorCallback(t)}})}function saveAttachment(){$.ajax({url:serverPath+"contractUpload/saveAttachment",type:"post",data:{strArray:JSON.stringify(array)},success:function(t){"1"==t.status?layer.msg("保存成功！"):"0"==t.status&&layer.msg(t.message)},error:function(t){App.ajaxErrorCallback(t)}})}function delAttachment(){$.ajax({url:serverPath+"contractUpload/delAttachment",type:"post",data:{deleteArray:JSON.stringify(deleteArray)},async:!1,success:function(t){"1"==t.status?console.log("删除附件扫描件成功！"):"0"==t.status&&layer.msg(t.message)},error:function(t){App.ajaxErrorCallback(t)}})}function saveContract(){if(0!=deleteArray.length&&delAttachment(),"{}"==JSON.stringify(result))""==$("#uploadFileNameshow").val()&&delContractText(),0==array.length?layer.msg("保存成功！"):saveAttachment();else if(0==array.length)saveContractText();else{var t=JSON.stringify(result);$.ajax({url:serverPath+"contractUpload/saveContract",type:"post",data:{jsonStr:t,id:id},success:function(t){"1"==t.status?$.ajax({url:serverPath+"contractUpload/saveAttachment",type:"post",data:{strArray:JSON.stringify(array)},success:function(t){"1"==t.status?layer.msg("保存成功！"):"0"==t.status&&layer.msg(t.message)},error:function(t){App.ajaxErrorCallback(t)}}):"0"==t.status&&layer.msg(t.message)}})}}function beforePushProcess(){var t=!0;if(""==$("#uploadFileNameshow").val())return void layer.alert("请上传合同正文扫描件！",{icon:0,skin:"layer-ext-moon"});var a=serverPath+"contractUpload/validateContractStatus?id="+id;$.ajax({url:a,type:"post",success:function(a){0!=a.count?(layer.msg(a.message),t=!1):t=!0},error:function(t){App.ajaxErrorCallback(t)}});var e={prov:"sd"};return parent.setAssigneeParam(e),t}function modal_pass(t,a,e,r,n,o,s,l){$.post(t+"contractUpload/pushProcess",{processInstanceId:r,taskId:n,id:id,taskDefinitionKey:a,assignee:e,comment:o,handleType:s,withdraw:l,nowtaskDefinitionKey:$("#taskDefinitionKey").val(),title:""},function(t){"1"==t.status?parent.modal_close():layer.msg(t.message)})}function beforeTransfer(){var t=!0,a={prov:"sd"};return parent.setAssigneeParam(a),t}function businessPush(){if(""==$("#uploadFileNameshow").val())return void layer.msg("请上传合同正文扫描件！");var t=id;if(0==t.length)return void layer.msg("请填写业务主键！");var a=App.getFlowParam(serverPath,t,1,0);return App.applyCandidateTask(serverPath,a)?void modal_passBybuss(a):void layer.alert("任务申领失败",{icon:0,skin:"layer-ext-moon"})}function modal_passBybuss(t){function a(){parent.layer.alert("提交成功!",{icon:1}),document.getElementById("saveButton").style.display="none",document.getElementById("businessPushButton").style.display="none"}function e(t){parent.layer.alert(t.message,{icon:1})}var r=t.taskDefinitionKey,n=t.assignee,o=t.processInstanceId,s=t.taskId,l=t.comment,d=t.handleType,i=t.withdraw,c={processInstanceId:o,taskId:s,taskDefinitionKey:r,assignee:n,comment:l,handleType:d,withdraw:i,nowtaskDefinitionKey:$("#taskDefinitionKey").val(),title:""},u="contractUpload/pushProcess";c.id=id,App.formAjaxJson(serverPath+u,"post",JSON.stringify(c),a,e)}function getQueryString(t){var a=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),e=window.location.search.substr(1).match(a);return null!=e?unescape(e[2]):null}var parm=App.getPresentParm(),id=null;id=1==parm.pageType?parm.businessKey:2==parm.pageType?parm.id:0;var config=top.globalConfig,serverPath=config.serverPath,attArray=[];$(function(){1==parm.pageType?($(".toolbarBtn,.portlet-title").remove(),$(".page-content,.portlet-body").css("padding","0px"),$(".portlet").css("cssText","border:none !important;padding:0px"),$(".page-content").removeClass("hidden")):2==parm.pageType&&($(".page-content").removeClass("hidden"),App.fixToolBars("toolbarBtnContent",70)),checkFileIsUpload(),getContractInfo(),$.ajax({type:"POST",url:serverPath+"contractUpload/listFile?id="+id,success:function(t){var a=t.data,e=a.length,r="<table class='table table-hover table-bordered table-striped'><thead><tr><th style='text-align:center;'>序号</th><th style='text-align:center;'>文件列表</th><th style='text-align:center;'>操作</th></tr></thead><tbody>";for(i=1;e>=i;i++)null!=a[i-1].storeId&&""!=a[i-1].storeId&&attArray.push(a[i-1]),r+="<tr>",r+=null!=a[i-1].storeId&&""!=a[i-1].storeId?"<td align='center'>"+i+"<input id='att"+a[i-1].attachId+"' type='hidden' value='"+a[i-1].storeId+"' /></td>":"<td align='center'>"+i+"<input id='att"+a[i-1].attachId+"' type='hidden' value='' /></td>",r+="<td align='center'>"+a[i-1].displayName+"</td>",null!=a[i-1].storeId&&""!=a[i-1].storeId?(r+="<td align='center'><button type='button' id='addButton"+a[i-1].attachId+"' style='display:none' onclick='addAttachment(\""+a[i-1].attachId+"\")'>添加</button>",r+="<button type='button' id='downLoadButton"+a[i-1].attachId+"' onclick='downLoad(\""+a[i-1].attachId+"\")'>下载</button>",r+="<button type='button' id='delButton"+a[i-1].attachId+"' onclick='del(\""+a[i-1].attachId+"\")'>删除</button></td>"):(r+="<td align='center'><button type='button' id='addButton"+a[i-1].attachId+"' onclick='addAttachment(\""+a[i-1].attachId+"\")'>添加</button>",r+="<button type='button' id='downLoadButton"+a[i-1].attachId+"' style='display:none' onclick='downLoad(\""+a[i-1].attachId+"\")'>下载</button>",r+="<button type='button' id='delButton"+a[i-1].attachId+"' style='display:none' onclick='del(\""+a[i-1].attachId+"\")'>删除</button></td>"),r+="</tr>";r+="</tbody></table>",document.getElementById("scanCpyloadTable").innerHTML=r},error:function(t){App.ajaxErrorCallback(t)}})});var array=[],deleteArray=[],result={};
function getTreeInfo(){function e(e){var a=e.data,t={isParent:"false",orgId:"",orgName:"全部"};null==a?layer.msg("没有相关组织和人员信息"):(a.unshift(t),organisationTree=$.fn.zTree.init($("#organisationTree"),orgsSetting,a))}App.formAjaxJson(serverPath+"orgs/"+config.curOrgId+"/orgTree","get",null,e)}function searchPersonnel(e){var a=$("#personnelTable").DataTable();e?a.ajax.reload(null,!1):a.ajax.reload()}function resetPasswd(e){e=e.split("&&"),layer.confirm('确定重置<span style="color:red;margin:0 5px;">'+e[1]+"</span>的密码?",{icon:3,title:"密码重置"},function(a){function t(t){layer.close(a),layer.alert("用户<span style='color:red;margin:0 5px;'>"+e[1]+"</span>的密码重置成功，</br>新密码为<span style='color:red;margin:0 5px;'>"+t.data+"</span>。",{icon:1})}App.formAjaxJson(serverPath+"staffPartner/updatePassword/"+e[0]+"/"+e[2],"PUT","",t)})}function changeStaffStatus(e){e=e.split("&&");var a="启用",t=1;"1"==e[3]&&(a="禁用",t=0),layer.confirm("确定"+a+'<span style="color:red;margin:0 5px;">'+e[1]+"</span>的账号?",{icon:3,title:"账号"+a},function(a){doChangeStaffStatus(e[0],t,a)})}function doChangeStaffStatus(e,a,t){function n(){layer.close(t);var e="1"==a?"启用成功":"禁用成功";layer.msg(e),searchPersonnel(!0)}App.formAjaxJson(serverPath+"staffPartner/updateStaffPartnerStatus/"+e+"/"+a,"PUT","",n)}function personnelModal(e){var e=e.split("&&"),a=e[0];"add"==a||"edit"==a?$("#modal").load("_externalPersonnelModal.html?"+App.timestamp()+" #modalEdit",function(){App.initFormSelect2("#externalPersonnelForm"),"add"==a?($("#modalTitle").text("新增外部人员"),dateRegNameChose(),validate(a),$("#modal").modal("show")):($("#modalTitle").text("外部人员信息编辑"),getInfor(e[1],a))}):$("#modal").load("_externalPersonnelModal.html?"+App.timestamp()+" #modalDetail",function(){getInfor(e[1],a)})}function getInfor(e,a){function t(e){var t=e.data;"edit"==a?setEditForm(t):setDetailForm(t)}App.formAjaxJson(serverPath+"staffPartner/getStaffPartner/"+e,"get","",t)}function setDetailForm(e){$("#modal").modal("show"),$("#staffNameDetail").text(e.staffName);var a={sex:function(e){return"W"==e?"女":"男"},staffStatus:function(e){return"1"==e?"有效":"无效"},hireDate:function(e){return App.formatDateTime(e,"yyyy-mm-dd")}};App.setFindValue("#baseInfo",e,a)}function setEditForm(e){$("#modal").modal("show");var a={hireDate:function(e){return App.formatDateTime(e,"yyyy-mm-dd")}};App.setFormValues("#externalPersonnelForm",e,a),$("#orgNameIn").attr("title",e.orgName),$("#orgNameIn").data("id",e.orgId),dateRegNameChose(),validate("edit")}function dateRegNameChose(){function e(e){var a=e.data;null==a?layer.msg("没有相关组织和人员信息"):orgNameTree=$.fn.zTree.init($("#orgName"),orgsSetting,a)}$("#orgNameIn").on("click",function(){showTree("orgNameIn")}),App.formAjaxJson(serverPath+"orgs/"+config.curOrgId+"/orgTree","get","",e)}function updateExternalPersonnel(e){function a(){layer.msg(r),searchPersonnel(!0),$("#modal").modal("hide")}function t(){$("#externalPersonnelForm").data("bootstrapValidator").resetForm()}var n=App.getFormValues($("#externalPersonnelForm")),r="新增成功",o=serverPath+"staffPartner/addStaffPartner",s="POST";"add"==e?(n.orgId=$("#orgNameIn").data("id"),n.staffKind=2,delete n.staffId):(n.orgId=$("#orgNameIn").data("id"),r="修改成功",o=serverPath+"staffPartner/updateStaffPartner",s="PUT"),App.formAjaxJson(o,s,JSON.stringify(n),a,t)}function showTree(e){{var a=$("#"+e);a.offset()}$("#"+e+"Content").css({left:"0",top:a.outerHeight()+"px",width:a.outerWidth()+("orgNameIn"==e?40:120)}).slideDown("fast"),onBodyDown(e)}function hideMenu(e){$("#"+e+"Content").fadeOut("fast"),$("body").unbind("mousedown",onBodyDown)}function onBodyDown(e){$("body").on("mousedown",function(a){a.target.id==e||a.target.id==e+"Content"||$(a.target).parents("#"+e+"Content").length>0||hideMenu(e)}),$(".page-content").on("scroll",function(){hideMenu(e)})}function orgsfilter(e,a,t){var t=t.data;return t?t:null}function zTreeBeforeAsync(e,a){return"organisationTree"==e?organisationTree.setting.async.url=serverPath+"orgs/"+a.orgId+"/children":"orgName"==e&&(orgNameTree.setting.async.url=serverPath+"orgs/"+a.orgId+"/children"),!0}function onClick(e,a){var t=$.fn.zTree.getZTreeObj(a).getSelectedNodes(),n=t[0].orgName,r=t[0].orgId;$("input[name="+a+"]").data("id",r),$("input[name="+a+"]").val(n),$("input[name="+a+"]").attr("title",n),"orgName"==a&&($("#externalPersonnelForm").data("bootstrapValidator").updateStatus("orgName","NOT_VALIDATED",null),$("#externalPersonnelForm").data("bootstrapValidator").validateField("orgName"))}function validate(e){$("#externalPersonnelForm").bootstrapValidator({live:"enabled",trigger:"live focus blur keyup change",message:"校验未通过",container:"popover",fields:{loginName:{validators:{notEmpty:{message:"请输入账号"},stringLength:{min:0,max:20,message:"请输入不超过20个字符"},regexp:{regexp:/^[a-zA-Z0-9_\-\.]+$/,message:"用户名由数字字母-_和.组成"}}},passwd:{validators:{notEmpty:{message:"请输入密码"},stringLength:{min:5,message:"密码至少5位"}}},staffName:{validators:{notEmpty:{message:"请输入人员姓名"},stringLength:{min:0,max:15,message:"请输入不超过15个字"}}},orgName:{validators:{notEmpty:{message:"请选择所属组织"}}},empCode:{validators:{regexp:{regexp:/^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$|^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X)$/,message:"请输入15或18位身份证号"}}},sex:{validators:{notEmpty:{message:"请选择性别"}}},postcode:{validators:{regexp:{regexp:/^[0-9]+$/,message:"请检查邮政编码"},stringLength:{min:0,max:6,message:"请输入不超过6位数字"}}},mailAddr:{validators:{stringLength:{min:0,max:30,message:"请输入不超过30个字符"}}},phone:{validators:{regexp:{regexp:/(^(\d{3,4}-)?\d{7,8})$|(1[3|5|7|8]{1}[0-9]{9})/,message:"请检查电话是否正确"}}},mobilPhone:{validators:{notEmpty:{message:"请输入手机号"},stringLength:{min:11,max:11,message:"请输入11位手机号码"},regexp:{regexp:/^1[3|5|7|8]{1}[0-9]{9}$/,message:"请输入正确的手机号码"}}},email:{validators:{emailAddress:{message:"请检查Email拼写"},stringLength:{min:0,max:50,message:"请输入不超过50个字符"}}},staffSort:{validators:{stringLength:{min:0,max:8,message:"请输入不超过8位数字"},regexp:{regexp:/^[0-9]+$/,message:"排序只能输入数字"}}}}}).on("success.form.bv",function(a){a.preventDefault(),updateExternalPersonnel(e)})}var organisationTree=null,orgNameTree=null,config=parent.globalConfig,serverPath=config.serverPath;$(function(){getTreeInfo()}),App.initDataTables("#personnelTable","#submitBtn",{ajax:{type:"GET",url:serverPath+"staffPartner/getStaffPartnerList",data:function(e){return e.sysOrgId=config.curOrgId,e.staffName=$("input[name='staffName']").val().trim(),e.loginName=$("input[name='loginName']").val().trim(),e.staffStatus=$("select[name='staffStatus']").val(),e.orgId=$("#organisation").data("id"),e}},columns:[{data:null,className:"text-center",title:"操作",render:function(e){if(e){var a=e.staffId+"&&"+e.staffName+"&&"+e.loginName+"&&"+e.staffStatus,t=new Array;return t.push({name:"修改",fn:"personnelModal('edit&&"+e.staffId+"')",icon:"iconfont icon-add"}),t.push({name:"密码重置",fn:"resetPasswd('"+a+"')"}),t.push("1"==e.staffStatus?{name:"禁用",fn:"changeStaffStatus('"+a+"')"}:{name:"启用",fn:"changeStaffStatus('"+a+"')"}),App.getDataTableBtn(t)}return""}},{data:null,title:"人员姓名",render:function(e){return'<a href="javascript:void(0)" onclick = "personnelModal(\'detail&&'+e.staffId+"')\">"+e.staffName+"</a>"}},{data:"loginName",title:"账号"},{data:"orgName",title:"组织"},{data:"sex",title:"性别",render:function(e){return"M"==e?"男":"女"}},{data:"email",title:"邮箱"},{data:"mobilPhone",title:"手机"},{data:"staffStatus",title:"岗位状态",render:function(e){return"1"==e?"有效":"无效"}}],fixedColumns:{leftColumns:2}});var orgsSetting={async:{enable:!0,url:"",type:"get",dataType:"json",dataFilter:orgsfilter},data:{simpleData:{enable:!0,idKey:"orgId",pIdKey:"parent_id"},key:{name:"orgName"}},view:{dblClickExpand:!1},callback:{onAsyncError:onAsyncError,onClick:onClick,beforeAsync:zTreeBeforeAsync}};
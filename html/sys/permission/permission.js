function showPermission(e){function r(e){var r={permType:function(e){var r="";return 1==e?r="菜单":2==e?r="标签":3==e&&(r="请求"),r}};App.setFindValue($("#permissionShow"),e.sysPerm,r)}App.formAjaxJson(serverPath+"pers/"+e,"get",null,r)}function delPermission(){return curNode?1==curNode.permId?void layer.alert("根权限禁止删除",{icon:2,title:"删除节点"}):void layer.confirm('确定删除<span style="color:red;margin:0 5px;">'+curNode.permName+"</span>及其子节点?",{icon:3,title:"删除节点"},function(e){function r(){layer.close(e),layer.msg("删除成功");var r=perPermissionTree.getNodesByParam("permId",curNode.parentId)[0];perPermissionTree.selectNode(r),showPermission(r.permId),perPermissionTree.removeNode(curNode),curNode=r}var o=curNode.permId,s={permIds:o};App.formAjaxJson(serverPath+"pers/"+o,"DELETE",s,r)}):void layer.alert("请选择需删除的节点",{icon:2,title:"删除节点"})}function addPermission(){return curNode?void $("#modal").load("_permissionModal.html?"+App.timestamp()+" #modalEdit",function(){$("#modalTitle").text("新增权限"),App.initFormSelect2("#permissionForm"),$("#parentId").val(curNode.permId),$("#parentName").val(curNode.permName),$("#modal").modal("show"),validate("add")}):void layer.alert("请选择父节点",{icon:2,title:"添加节点"})}function showUpdate(){return curNode?1==curNode.permId?void layer.alert("父节点不能修改",{icon:2,title:"修改节点"}):void $("#modal").load("_permissionModal.html?"+App.timestamp()+" #modalEdit",function(){function e(e){App.setFormValues($("#permissionForm"),e.sysPerm);var r=perPermissionTree.getNodesByParam("permId",e.sysPerm.parentId)[0];$("#parentName").val(r.permName),validate("edit")}$("#modalTitle").text("修改权限"),App.initFormSelect2("#permissionForm"),$("#modal").modal("show");var r={permId:curNode.permId};App.formAjaxJson(serverPath+"pers/"+curNode.permId,"get",r,e)}):void layer.alert("请选择父节点",{icon:2,title:"修改节点"})}function updatePermisson(e){function r(r){if(layer.msg(i),$("#modal").modal("hide"),showPermission(curNode.permId),"add"==e){var o={permName:r.sysPerm.permName,permId:r.sysPerm.permId};perPermissionTree.addNodes(curNode,o)}else curNode.permName=r.sysPerm.permName,perPermissionTree.updateNode(curNode)}function o(){$("#permissionForm").data("bootstrapValidator").resetForm()}var s=App.getFormValues($("#permissionForm")),i="新增成功",n=serverPath+"pers/",t="POST";s.staffOrgId=config.curStaffOrgId,"add"==e?delete s.permId:(i="修改成功",n=serverPath+"pers/"+curNode.permId,t="PUT"),App.formAjaxJson(n,t,JSON.stringify(s),r,o)}function validate(e){$("#permissionForm").bootstrapValidator({live:"enabled",trigger:"live focus blur keyup change",message:"校验未通过",container:"popover",fields:{permCode:{validators:{notEmpty:{message:"请输入权限编码名称"},stringLength:{min:0,max:20,message:"请输入不超过20个字符"}}},permName:{validators:{notEmpty:{message:"请输入权限名称"},stringLength:{min:0,max:20,message:"请输入不超过20个字符"}}},permType:{validators:{notEmpty:{message:"请选择权限类型"}}},permSort:{validators:{numeric:{message:"只能输入纯数字"},stringLength:{min:0,max:6,message:"请输入不超过6个字符"}}}}}).on("success.form.bv",function(r){r.preventDefault(),updatePermisson(e)})}function refreshTree(){function e(e){perPermissionTree.destroy("permTree"),zNodes=e.sysPerm,perPermissionTree=$.fn.zTree.init($("#permTree"),permSetting,zNodes),curNode=perPermissionTree.getNodes()[0],perPermissionTree.selectNode(curNode),perPermissionTree.expandNode(curNode,!0,!1,!0),showPermission(curNode.permId)}App.formAjaxJson(serverPath+"pers/root","get",null,e)}function expandAll(){var e=perPermissionTree.getNodes();expandNodes(e)}function expandNodes(e){if(e)for(var r=0,o=e.length;o>r;r++)perPermissionTree.expandNode(e[r],!0,!1,!1),e[r].isParent&&expandNodes(e[r].children)}function collapseAll(){perPermissionTree.expandAll(!1)}function filter(e,r,o){return o?o=o.perms:null}var config=parent.globalConfig,serverPath=config.serverPath,perPermissionTree=null,curNode=null;$(function(){function e(e){var r=e.sysPerm;perPermissionTree=$.fn.zTree.init($("#permTree"),permSetting,r),curNode=perPermissionTree.getNodes()[0],perPermissionTree.selectNode(curNode),perPermissionTree.expandNode(curNode,!0,!1,!0),showPermission(curNode.permId)}parent.data_permFilter(document);var r=$(window).height(),o=$(".portlet").outerHeight();r>o?$("#permTree").css("max-height",r-110):$("#permTree").css("max-height",o-110),App.formAjaxJson(serverPath+"pers/root","get",null,e)});var permSetting={data:{key:{name:"permName"},simpleData:{enable:!0,idKey:"permId",pIdKey:"parentId",rootPId:0}},async:{enable:!0,url:"",otherParam:{staffOrgId:config.curStaffOrgId,staffId:config.curStaffId},type:"get",dataType:"json",dataFilter:filter},callback:{beforeAsync:function(e,r){return perPermissionTree.setting.async.url=serverPath+"pers/"+r.permId+"/children",!0},onClick:function(e,r,o){curNode=o,showPermission(o.permId)}}};
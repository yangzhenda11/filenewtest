function validate(e){$("#roleForm").bootstrapValidator({live:"enabled",trigger:"live focus blur keyup change",message:"校验未通过",container:"popover",fields:{roleName:{validators:{notEmpty:{message:"您输入的字段不能为空"}}},orgName:{validators:{notEmpty:{message:"请选择所属组织"}},trigger:"focus blur keyup change"},roleDesc:{validators:{stringLength:{max:100,message:"请输入不超过100个字符"}}}}}).on("success.form.bv",function(r){r.preventDefault(),updateRoleValue(e)})}function filter(e,r,a){return a?a=a.perms:null}function getDpType(){$("#DpType").empty(),$.ajax({url:parent.globalConfig.serverPath+"pers/dpType",dataType:"json",type:"GET",success:function(e){DpType=e,$("#DpType").append('<option value=""></option> ');for(var r=0;r<e.length;r++)$("#DpType").append("<option value='"+e[r].dpId+"'>"+e[r].label+"</option>")}})}function refreshTree(){$.get(parent.globalConfig.serverPath+"pers/root",function(e){perPermissionTree.destroy("permTree"),zNodes=e.sysPerm,perPermissionTree=$.fn.zTree.init($("#permTree"),permSetting,zNodes),curNode=perPermissionTree.getNodes()[0],perPermissionTree.selectNode(curNode),perPermissionTree.expandNode(curNode,!0,!1,!0),showPermission(curNode.permId)})}function expandAll(){var e=perPermissionTree.getNodes();expandNodes(e)}function expandNodes(e){if(e)for(var r=0,a=e.length;a>r;r++)perPermissionTree.expandNode(e[r],!0,!1,!1),e[r].isParent&&expandNodes(e[r].children)}function collapseAll(){perPermissionTree.expandAll(!1)}function findRootNodes(e){for(var r=new Array,a=0;a<e.length;a++){for(var s=!1,n=0;n<e.length;n++)if(e[a].parentId==e[n].permId){s=!0;break}s||r.push(e[a])}return r}function sortOrder(e,r,a){for(var s=0;s<a.length;s++)a[s].parentId==e&&(r.push(a[s]),sortOrder(a[s].permId,r,a))}function inittreeTable(){$("#permissionTreeTable").empty()}function showlist(){inittreeTable(),$.get(parent.globalConfig.serverPath+"pers/permAll",{staffOrgId:curStaffOrgId,staffId:curStaffId},function(e){for(var r=findRootNodes(e),a=new Array,s=0;s<r.length;s++)a.push(r[s]),sortOrder(r[s].permId,a,e);for(var s=0;s<a.length;s++){var n=a[s].uri,o=a[s].permIcon,t=a[s].permType,i=a[s].permCheck;"undefined"==typeof n?n="":a[s].uri.length>20&&(n=a[s].uri.substring(0,20)+"&#8230;"),"undefined"==typeof o&&(o=""),"undefined"==typeof i&&(i=""),t="1"==t?"菜单":"2"==t?"标签":"3"==t?"请求":"4"==t?"新窗口":"",$("#permissionTreeTable").append('<tr id="'+a[s].permId+'" pId="'+a[s].parentId+'"><td>'+a[s].permCode+"</td><td>"+a[s].permName+"</td><td>"+n+'</td><td id="perm'+a[s].permId+'" >'+t+"</td><td>"+o+"</td><td>"+i+"</td><td>"+a[s].permSort+"</td></tr>");var t=a[s].permType;$("#perm"+a[s].permId).html("1"==t?"菜单":"2"==t?"标签":"3"==t?"请求":"4"==t?"新窗口":"")}$("#permissionTreeTable").treeTable({expandLevel:1,column:0,expandable:!0}).show()}),$("#PermissionHeader").hide(),$("#PermissionContainer").hide(),$("#PermissionContainer2").show(),$("#saveBtn").show(),$("#updateBtn").show()}function initFrame(){$("#permissionObj input").val(""),$("#permissionObj [name=type]").val("1"),$("#permissionObj [name=grade]").val("-1"),resetValidator()}function resetValidator(){$("#permissionObj").data("bootstrapValidator")&&$("#permissionObj").data("bootstrapValidator").resetForm(!1)}function addPermission(){return curNode?(initFrame(),$("#permissionShow").hide(),$("#menuInfoWell").show(),$("#dealPermission").show(),$("#updatePermissionbtn").hide(),$("#parentIdVal").val(curNode.permId),$("#parentName").html(curNode.permName),void $("#dealPermission").html("保存")):void alertModel("请选择父节点")}function savePermission(){$("input[name='staffOrgId']").val(curStaffOrgId);var e=$("#permissionObj").serializeArray(),r={};$.each(e,function(e,a){r[a.name]=a.value}),$.ajax({url:parent.globalConfig.serverPath+"pers/",type:"POST",contentType:"application/json",data:JSON.stringify(r),success:function(){$("#permissionShow").show(),$("#menuInfoWell").hide(),perPermissionTree.reAsyncChildNodes(curNode,"refresh")}})}function delPermission(){return curNode?1==curNode.permId?void alert("根权限禁止删除"):void(confirm("确定删除"+curNode.permName+"及其子节点么？")&&delPermission1()):void alert("请选择需删除的节点")}function delPermission1(){for(var e=$.fn.zTree.getZTreeObj("permTree"),r=e.getSelectedNodes(),a=e.transformToArray(r),s=new Array,n=0;n<a.length;n++)s.push(a[n].permId);var o=s.join(",");$.ajax({type:"DELETE",url:parent.globalConfig.serverPath+"pers/"+o,data:{permIds:o},dataType:"json",success:function(){$("#_frm_confirm_modal").modal("hide");var e=curNode.parentTId;perPermissionTree.removeNode(curNode),curNode=perPermissionTree.getNodeByTId(e),curNode&&showPermission(curNode.permId),permSearchTable.ajax.reload()}})}function showPermission(e){$.get(parent.globalConfig.serverPath+"pers/"+e,function(e){var r=e.sysPerm;$("#sysPermissionCode").html(r.permCode),$("#sysPermissionName").html(r.permName),$("#sysPermissionUri").html(r.uri),$("#sysPermissionType").html(r.permType="菜单"),$("#sysPermissionIcon").html(r.permIcon),$("#sysPermissionCheck").html(r.permCheck),$("#sysPermissionSort").html(r.permSort),$("#sysPermissionDP").html(e.dataPermissionTypeLabel),$("#sysPermissionCheck").html(r.permCheck)})}function showUpdate(){if(!curNode)return void alertModel("请选择需修改节点");initFrame();var e=curNode.permId;$.get(parent.globalConfig.serverPath+"pers/"+e,{permId:curNode.permId},function(e){var r=e.sysPerm;for(col in r)$("#permissionObj [name="+col+"]").val(r[col])}),$("#permissionShow").hide(),$("#menuInfoWell").show(),$("#dealPermission").hide(),$("#updatePermissionbtn").show(),$("#parentIdVal").val(curNode.permId);var r=curNode.parentTId,a=perPermissionTree.getNodeByTId(r);$("#parentName").html(0==!a?a.permName:""),$("#updatePermissionbtn").html("修改")}function showStaff(){if(!curNode)return void alertModel("请选择需查询的节点");var e='    			{{#each func}}		    <button type="button" class="user-button btn-sm" onclick="{{this.fn}}">{{this.name}}</button>		    {{/each}}',r=Handlebars.compile(e);$("#permSearchTable").DataTable().destroy(),permSearchTable=$("#permSearchTable").DataTable({ordering:!1,serverSide:!0,scrollX:!0,ajax:{type:"GET",url:parent.globalConfig.serverPath+"pers/"+curNode.permId+"/staffs",contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"json",data:function(e){return e.permId=curNode.permId,e}},columns:[{data:"staffId"},{data:null},{data:"staffCode",render:$.fn.dataTable.render.ellipsis(22,!0)},{data:"staffName",render:$.fn.dataTable.render.ellipsis(22,!0)},{data:"loginName",render:$.fn.dataTable.render.ellipsis(22,!0)},{data:"orgName",render:$.fn.dataTable.render.ellipsis(22,!0)},{data:"sex"},{data:"phone"},{data:"email"},{data:"mobilPhone"},{data:"staffStatus"}],columnDefs:[{targets:"_all",defaultContent:""},{targets:0,visible:!1},{targets:6,render:function(e,r,a){return"M"==a.sex?"男":"女"}},{targets:10,render:function(e,r,a){return"1"==a.staffStatus?"有效":"无效"}},{targets:1,render:function(e,a,s){context={func:[{name:"详细信息",fn:"showStaffPage('"+s.staffId+"')",type:"primary"}]};var n=r(context);return n}}],dom:'rt<"bottom"ip><"clear">'}),$("#PermissionHeader").hide(),$("#PermissionContainer").show(),$("#PermissionContainer2").hide()}function initFrame1(){$("#PermissionHeader").show(),$("#staffContainer").hide(),$("#PermissionContainer").hide(),$("#PermissionContainer2").hide(),$("#saveBtn").hide()}function backSearch(){initFrame1()}function updatePermission(){$("input[name='permId']").val();var e={permId:$("input[name='permId']").val(),parentId:$("input[name='parentId']").val(),parentName:$("#parentName").html(),permCode:$("input[name='permCode']").val(),uri:$("input[name='uri']").val(),permType:$("select[name='permType']").val(),permIcon:$("input[name='permIcon']").val(),permCheck:$("input[name='permCheck']").val(),permSort:$("input[name='permSort']").val(),dataPermissionType:$("select[name='dataPermissionType']").val(),permName:$("input[name='permName']").val()};$.ajax({url:parent.globalConfig.serverPath+"pers/"+curNode.permId,type:"PUT",contentType:"application/json",data:JSON.stringify(e),success:function(e){var r=e.sysPerm;perPermissionTree.editName(curNode),perPermissionTree.cancelEditName(r.permName),showPermission(curNode.permId),$("#permissionShow").show(),$("#menuInfoWell").hide(),curNode.permName=r.permName,perPermissionTree.updateNode(curNode),alert("修改成功!")}})}function showData(e){for(col in e)if("permType"==col)"1"==e[col]?$("#sysPermissionType").html("菜单"):"2"==e[col]?$("#sysPermissionType").html("标签"):"3"==e[col]&&$("#sysPermissionType").html("请求");else if("grade"==col);else if("permCode"==col)$("#sysPermissionCode").html(e[col]);else if("permName"==col)$("#sysPermissionName").html(e[col]);else if("uri"==col)$("#sysPermissionUri").html(e[col]);else if("permType"==col)$("#sysPermissionType").html(e[col]);else if("permIcon"==col)$("#sysPermissionIcon").html(e[col]);else if("permCheck"==col)$("#sysPermissionCheck").html(e[col]);else if("permSort"==col)$("#sysPermissionSort").html(e[col]);else if("dataPermissionType"==col){for(var r="",a=0;a<DpType.length;a++)DpType[a].ID==e[col]&&(r=DpType[a].LABEL);$("#sysPermissionDP").html(r)}}function showStaffPage(e){$("#permStaffDetail").load("../staff/staffDetailModal.html",function(){$("#staffDetailId").val(e),$("#mark").val("Perm"),$("#infoModal").attr("id","infoModal"+$("#mark").val()),$("#staffDetailId").attr("id","staffDetailId"+$("#mark").val()),$("#staffDetail").attr("id","staffDetail"+$("#mark").val())})}var perPermissionTree,dealTreeNode1,isAddSysPer=!1,isUpdateSysPer=!1,zNodes=[],curNode,validator={live:"enabled",trigger:"live focus blur keyup change",message:"校验未通过",container:"popover",submitHandler:function(e,r,a){"dealPermission"==$(a).attr("id")&&savePermission(),"updatePermissionbtn"==$(a).attr("id")&&updatePermission()},fields:{permCode:{validators:{notEmpty:{message:"请输入权限编码"}},stringLength:{max:20,message:"权限编码不大于20个字符"}},permName:{validators:{notEmpty:{message:"请输入权限名称111"}},stringLength:{max:20,message:"权限名称不大于20个字符"}},uri:{validators:{stringLength:{max:200,message:"权限地址不大于200个字符"}}},permIcon:{validators:{stringLength:{max:100,message:"菜单图标不大于100个字符"}}},permCheck:{validators:{stringLength:{max:60,message:"校验字符不大于60个字符"}}},permSort:{validators:{stringLength:{max:10,message:"展示顺序不大于10个字符"},numeric:{message:"只能输入纯数字"}}}}};$(function(){$("#permTree").height($(window).height()-100),$.get(parent.globalConfig.serverPath+"pers/root",function(e){zNodes=e.sysPerm,perPermissionTree=$.fn.zTree.init($("#permTree"),permSetting,zNodes),curNode=perPermissionTree.getNodes()[0],perPermissionTree.selectNode(curNode),perPermissionTree.expandNode(curNode,!0,!1,!0),showPermission(curNode.permId)}),$("#permissionObj").bootstrapValidator(validator)});var permSetting={data:{key:{name:"permName"},simpleData:{enable:!0,idKey:"permId",pIdKey:"parentId",rootPId:0}},async:{enable:!0,url:parent.globalConfig.serverPath+"pers/1/children",otherParam:{staffOrgId:parent.globalConfig.curStaffOrgId,staffId:parent.globalConfig.curStaffId},type:"get",dataType:"json",dataFilter:filter},callback:{beforeAsync:function(e,r){return perPermissionTree.setting.async.url=parent.globalConfig.serverPath+"pers/"+r.permId+"/children",!0},onClick:function(e,r,a){$("#permissionShow").show(),$("#menuInfoWell").hide(),curNode=a,showPermission(a.permId)}}},DpType,permSearchTable;
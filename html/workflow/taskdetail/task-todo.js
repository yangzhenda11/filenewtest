function addCustomBt(btId,btName,callBackName){if(!$("#"+btId)[0]){var insertHtml='<button id="'+btId+'" type="button" class="btn btn-success">'+btName+"</button>";$("#out-footers").find("button").eq(0).before(insertHtml),$("#"+btId).click(function(){eval('document.getElementById("businessiframe").contentWindow.'+callBackName+"()")})}}function showOrhideButton(e,t){t?$("#"+e).show():$("#"+e).hide()}function setUserBtName(e,t){null!=t&&"undefined"!=typeof t&&t.length>0&&$("#"+e).html(t)}function setUserButton(e,t){e?($("#userButton").show(),$("#userButton").click(function(){addCommentByuser(t)})):($("#userButton").hide(),$("#userButton").unbind())}function addCommentByuser(e){var t=App.getFlowParam(serverPath,e,1,0);t.title=$("#businessiframe")[0].contentWindow.$("#BusinessTile").val(),"function"==typeof document.getElementById("businessiframe").contentWindow.modal_passBybuss?checkifdone()||document.getElementById("businessiframe").contentWindow.modal_passBybuss(t):layer.msg("网络异常，请联系管理员！")}function setQxspButton(e,t){e?($("#userQXSPButton").show(),$("#userQXSPButton").click(function(){addCommentQxsp(t)})):($("#userQXSPButton").hide(),$("#userQXSPButton").unbind())}function addCommentQxsp(e){var t=App.getFlowParam(serverPath,e,8,1);"function"==typeof document.getElementById("businessiframe").contentWindow.modal_passQxsp?checkifdone()||document.getElementById("businessiframe").contentWindow.modal_passQxsp(t):layer.msg("网络异常，请联系管理员！")}function loadTaskPath(e,t,a,n,o){var o=$("#processDefinitionId").val(),t=$("#processInstanceId").val(),n=$("#taskDefinitionKey").val(),a=$("#taskId").val();$.post(e+"workflowrest/tasktodopath/"+t+"/"+n+"/"+a,null,function(t){var a=t.retCode;if(1==a){var s=t.dataRows[0].url;$("#param").val(t.dataRows[0].param);var i=t.dataRows[0].startLink,r=t.dataRows[0].endLink;$("#startLink").val(i),$("#endLink").val(r),$("#businessiframe").attr("src",s),$("#business").show()}else 0==a&&alert(t.retValue);loadCustomTabs(e,$("#param").val(),o,n)})}function loadCustomTabs(e,t,a,n){$.get(e+"workflowrest/taburls/"+a+"/"+n+"/"+!0,function(e){var a=e.retCode;if(1==a)for(var n=0;n<e.dataRows.length;n++){var o=e.dataRows[n].name,s=e.dataRows[n].url+"?"+t,i="custom_tab"+(n+1),r="custom_div"+(n+1),l='<div role="tabpanel" class="tab-pane fade" id=\''+r+"'></div>",d="<li id='"+i+"' role='presentation'></li>",c="<a href='#"+r+"' aria-controls='"+r+'\' role="tab" data-toggle="tab">'+o+"</a>";$("#history").before(l),$("#"+r).load(s),$("#historyLi").before(d),$("#"+i).append(c)}})}function loadHistoicFlow(e,t){$.get(e+"workflowrest/histoicflow/"+t,function(e){var t=e.retCode;if(1==t){for(var a="",n=0;n<e.dataRows.length;n++){var o=e.dataRows[n].startTime;o=getSmpFormatDateByLong(o,!0);var s=e.dataRows[n].endTime;s=null==s?"":getSmpFormatDateByLong(s,!0);var i=n+1,r=e.dataRows[n].assigneeName,l=e.dataRows[n].fromUserName;1==e.dataRows[n].replace&&(r=r+"（ "+l+"——待办授权）"),a+="<tr><td>"+i+"</td><td>"+e.dataRows[n].linkName+"</td><td>"+r+"</td><td>"+e.dataRows[n].orgName+"</td><td>"+e.dataRows[n].handleType+"</td><td>"+o+"</td><td>"+s+'</td><td style="word-wrap:break-word;word-break:break-all;">'+e.dataRows[n].userComment+"</td></tr>"}$("#historyContent").html(a),"null"!=e.dataRows[0].preProcessInstanceId&&null!=e.dataRows[0].preProcessInstanceId&&""!=e.dataRows[0].preProcessInstanceId&&($("#preProcessInstanceId").val(e.dataRows[0].preProcessInstanceId),$("#subTitle").val(e.dataRows[0].orgName),getPreHistoryContent())}else 0==t&&alert(e.retValue)})}function addComment(e){if(clearAssignee(),"function"!=typeof document.getElementById("businessiframe").contentWindow.beforePushProcess)return void layer.msg("数据校验异常，请联系管理员！");if(document.getElementById("businessiframe").contentWindow.beforePushProcess(e)){if("function"==typeof document.getElementById("businessiframe").contentWindow.setComment){var t=document.getElementById("businessiframe").contentWindow.setComment(e);$("#comment").val(null!=t&&"undefined"!=typeof t&&t.length>0?t:"")}else $("#comment").val("");$("#confirmButton").unbind(),$("#confirmButton").click(function(){pushProcess()}),$("#linkDiv").show(),$("#assigneeDiv").show(),$("#handleType").val(e?1:2),refreshLink(e),$("#in-footer").modal("show")}}function addCommentForVote(e){checkifdone()||($("#confirmButton").unbind(),$("#confirmButton").click(function(){pushProcessForVote()}),$("#linkDiv").hide(),$("#assigneeDiv").hide(),$("#handleType").val(e?1:2),$("#in-footer").modal("show"))}function addCommentForStop(){checkifdone()||($("#confirmButton").unbind(),$("#confirmButton").click(function(){stopProcess()}),$("#linkDiv").hide(),$("#assigneeDiv").hide(),$("#comment").val("中止流程"),$("#in-footer").modal("show"))}function addCommentForQuick(){checkifdone()||($("#confirmButton").unbind(),$("#confirmButton").click(function(){quickBackProcess()}),$("#linkDiv").hide(),$("#assigneeDiv").hide(),$("#in-footer").modal("show"))}function addCommentForStart(){checkifdone()||($("#confirmButton").unbind(),$("#confirmButton").click(function(){quickPushProcess()}),$("#linkDiv").hide(),$("#assigneeDiv").hide(),$("#in-footer").modal("show"))}function addCommentForTurn(){if(!checkifdone()&&document.getElementById("businessiframe").contentWindow.beforeTransfer()){var e=$("#taskDefinitionKey").val(),t=$("#name").val(),a="00000",n=e+",1,"+a;$("#link").prepend("<option value='"+n+"'>"+t+"</option>"),$("#link").get(0).selectedIndex=0,$("#comment").val(""),$("#confirmButton").unbind(),$("#confirmButton").click(function(){transferTask()}),$("#linkDiv").hide(),$("#assigneeDiv").show(),$("#in-footer").modal("show")}}function refreshLink(e){var t=$("#processDefinitionKey").val(),a=$("#taskId").val(),n=$("#handleType").val(),o=$("#isHistoryBack").val(),s=$("#isUsePushExpression").val(),i=$("#isUseBackExpression").val(),r=$("#pathSelect").val(),l=null;"function"==typeof document.getElementById("businessiframe").contentWindow.setRelativeData&&(l=document.getElementById("businessiframe").contentWindow.setRelativeData(),l||(l=null)),$.get(serverPath+"workflowrest/tasklink/"+a+"/"+n+"/branch/"+o+"/"+s+"/"+i+"/"+r,l,function(a){var o=a.retCode;if($("#link").empty(),1==o){var s=a.dataRows;$.each(s,function(e,t){$("#link").append("<option value='"+t.value+"'>"+t.label+"</option>")}),e?0==s.length||1==s.length&&"END"==s[0].value.split(",")[2]?$("#assigneeDiv").hide():$("#linkDiv").show():($("#assigneeDiv").hide(),refreshAssignee(serverPath,t,$("#link").val().split(",")[0])),s.length>0&&"true"==$("#isUseReferenceMan").val()&&historyUser($("#processDefinitionId").val(),$("#taskDefinitionKey").val(),n,$("#link").val().split(",")[0])}else 0==o&&alert("未找到可流转环节，异常请处理！")})}function refreshAssignee(e,t,a){var n=$("#handleType").val(),o=$("#processInstanceId").val();$.post(e+"workflowrest/assignee/"+t+"/"+a+"/"+o+"/"+n,function(e){var t=e.retCode;if(1==t){var a=e.dataRows;$("#assigneeName").val(),$("#assignee").val(),$("#assigneeName").val(a[0].label),$("#assignee").val(a[0].value)}else 0==t&&alert(e.retValue)})}function selectButton(){$("#in-footer").modal("hide"),clearAssignee()}function pushProcess(){if(!checkifdone()){var e="",t=0,a="",n=$("#link").val();if($("#linkDiv").is(":hidden"))e=n.split(",")[0];else{var o=n.split(",");if(e=o[0],t=o[1],0==e.length)return void layer.msg("请选择环节！")}if(a=$("#assignee").val(),(null==a||0==a.length||""==a)&&"endevent1"!=e)return void layer.msg("请选择处理人！",{time:1e3});var s=$("#comment").val();if(0==s.length)return void layer.msg("请填写审批意见！");var i=$("#link").val().toString().split(",")[3];if(null==i||0==i.length)return void layer.msg("流程异常，无法识别下一步环节是否是需要抢单环节，请联系管理员！",{time:2e3});layer.confirm("是否确认提交？",{icon:3,title:"确认"},function(n){document.getElementById("businessiframe").contentWindow.modal_pass(serverPath,e,a,$("#processInstanceId").val(),$("#taskId").val(),s,$("#handleType").val(),t,i),layer.close(n)})}}function pushProcessForVote(){if(!checkifdone()){var e=$("#comment").val();if(0==e.length)return void alert("请填写审批意见！");var t=confirm("是否确认提交？");1==t&&(alert($("#processInstanceId").val()+":"+$("#taskId").val()),document.getElementById("businessiframe").contentWindow.modal_pass(serverPath,"","",$("#processInstanceId").val(),$("#taskId").val(),e,$("#handleType").val(),""))}}function stopProcess(){if(!checkifdone()){var e=$("#comment").val();if(0==e.length)return void alert("请填写审批意见！");var t=confirm("【终止】确认后，当前流程将在本环节结束，是否确认？");1==t&&document.getElementById("businessiframe").contentWindow.modal_stop(serverPath,$("#processInstanceId").val(),$("#taskId").val(),e)}}function quickBackProcess(){if(!checkifdone()){var e=$("#processInstanceId").val(),t=$("#taskId").val(),a=$("#comment").val();if(0==a.length)return void alert("请填写审批意见！");var n=confirm("【简退】确认后，当前任务将回退给流程发起人，是否确认？");1==n&&$.post(serverPath+"workflowrest/pushprocesstostart/"+e+"/"+t,{comment:a},function(e){1==e.retCode&&(alert("任务已回退至流程发起人！"),modal_close())})}}function quickPushProcess(){if(!checkifdone()){var e=$("#processInstanceId").val(),t=$("#taskId").val(),a=$("#comment").val();if(0==a.length)return void alert("请填写审批意见！");var n=confirm("确认后，当前任务将提交至流程简退退回人，是否确认？");1==n&&$.post(serverPath+"workflowrest/pushprocessreturnback/"+e+"/"+t,{comment:a},function(e){1==e.retCode&&(alert("任务已提交至流程退回人！"),modal_close())})}}function transferTask(){if(!checkifdone()){var e=$("#processInstanceId").val(),t=$("#taskId").val(),a=$("#assignee").val(),n=$("#comment").val();if(null==a||""==a)return void alert("请选择处理人！");if(0==n.length)return void alert("请填写审批意见！");layer.confirm("【转派】确认后，当前任务将转派给已选择受理人，是否确认？",{icon:3,title:"确认"},function(o){$.post(serverPath+"workflowrest/transfertask/"+e+"/"+t+"/"+a,{comment:n},function(e){1==e.retCode&&layer.alert("转派成功",{icon:1},function(){modal_close()})}),layer.close(o)})}}function clearAssignee(){$("#assignee").val(""),$("#assigneeName").val("")}function modal_close(){if("3"==pageType){var e=navigator.userAgent;-1!=e.indexOf("Firefox")||-1!=e.indexOf("Presto")?window.location.replace("about:blank"):(window.opener=null,window.open("","_self"),window.close())}else returnList()}function historyUser(e,t,a,n){$.post(serverPath+"workflowrest/getHistoryUser/"+e+"/"+t+"/"+a+"/"+n,null,function(e){for(var t,a=0;a<e.length;a++)t+="<tr><td>"+e[a].userName+"</td><td><button type='button' class='btn btn-info btn-xs'  onclick='setUser(\""+e[a].userId+'","'+e[a].userName+"\")'>选择</button></td></tr>";$("#historyUser").html(t)})}function setUser(e,t){$("#assignee").val(e),$("#assigneeName").val(t)}function initData(){$.ajax({url:serverPath+"workflowrest/taskToDoDetail",type:"POST",data:$("#taskToDoDetail").serializeArray(),async:!1,success:function(e){$("#isCounterSign").val(e.isCounterSign),$("#startLink").val(e.startLink),$("#endLink").val(e.endLink),$("#canQuickPush").val(e.canQuickPush),$("#handleType").val(e.handleType),$("#buttonBack").val(e.buttonBack),$("#buttonTurn").val(e.buttonTurn),$("#buttonBreak").val(e.buttonBreak),$("#buttonQuick").val(e.buttonQuick),$("#isUseReferenceMan").val(e.isUseReferenceMan),$("#isHistoryBack").val(e.isHistoryBack),$("#isUsePushExpression").val(e.isUsePushExpression),$("#isUseBackExpression").val(e.isUseBackExpression),$("#isSendRecord").val(e.isSendRecord)},error:function(e){alert("获取数据异常"+e),App.ajaxErrorCallback(e)}})}function returnList(){if("3"==pageType){var e=navigator.userAgent;-1!=e.indexOf("Firefox")||-1!=e.indexOf("Presto")?window.location.replace("about:blank"):(window.opener=null,window.open("","_self"),window.close())}else $("#in-footer").modal("hide"),$("#goTaskToDoDetailForToDo").hide(),$("#business").hide(),$("#searchContentForToDo").show(),serarchForToDo()}function getPreHistoryContent(){var e=$("#preProcessInstanceId").val();e&&($("#subspan").html($("#subTitle").val()),$.get(serverPath+"workflowrest/histoicflow/"+e,function(t){var a=t.retCode;if(1==a){for(var n="",o=0;o<t.dataRows.length;o++){var s=t.dataRows[o].startTime;s=getSmpFormatDateByLong(s,!0);var i=t.dataRows[o].endTime;i=null==i?"":getSmpFormatDateByLong(i,!0);var r=o+1,l=t.dataRows[o].assigneeName,d=t.dataRows[o].fromUserName;1==t.dataRows[o].replace&&(l=l+"（ "+d+"——待办授权）"),n+="<tr><td>"+r+"</td><td>"+t.dataRows[o].linkName+"</td><td>"+l+"</td><td>"+t.dataRows[o].orgName+"</td><td>"+t.dataRows[o].handleType+"</td><td>"+s+"</td><td>"+i+'</td><td style="word-wrap:break-word;word-break:break-all;">'+t.dataRows[o].userComment+"</td></tr>"}$("#preHistoryContent").html(n),$("#zlc_diagramImg").attr("src",serverPath+"workflowrest/flowchart/"+e+"/"+parseInt(10*Math.random())),$("#preDiv").css({display:"inline"})}else 0==a&&alert(t.retValue)}))}function openImages(e){var t=document.getElementById(e),a=$(t);a=a.find(".active"),a=a.find("a"),showImage(a.attr("id"))}function subHistoryTitl(){var e=$("#processInstanceId").val();$.get(serverPath+"workflowrest/subHistoryTitl/"+e,function(e){if(1==e.retValue){for(var t='<table class="table table-striped table-bordered table-condensed"><thead><tr><th>序号</th><th>环节名称</th><th>受理人</th><th>受理人部门</th><th>处理方式</th><th>任务接收时间</th><th>任务办理时间</th><th>处理意见</th></tr></thead><tbody>',a="</tbody></table>",n="",o=0;o<e.data.length;o++){n+='<div class="list-group-item" style="background-color: #A4D3EE;"><table><tr style="width: 100%;"><td style="width: 100%;"><span style="font-size: 14px;color: white;">'+e.data[o].TITLENAME+'</span></td><td style="width: 100%;" align="right"><div class="btn-group btn-group-xs"><button type="button" class="btn btn-danger" onclick="openImages(\'b_'+e.data[o].PROC_DEF_ID_+'\')" style="text-align: right;">点击查看流程图</button></div></td></tr></table></div><div class="list-group-item"><ul id="b_'+e.data[o].PROC_DEF_ID_+'" class="nav nav-tabs">';for(var s=0;s<e.data[o].temp.length;s++)n+=0==s?'<li class="active"><a id="'+e.data[o].temp[s].PROC_INST_ID+'" href="#business_'+e.data[o].temp[s].PROC_INST_ID+'" aria-controls="business_'+e.data[o].temp[s].PROC_INST_ID+'" role="tab" data-toggle="tab">'+e.data[o].temp[s].NAME_+"</a></li>":'<li ><a id="'+e.data[o].temp[s].PROC_INST_ID+'" href="#business_'+e.data[o].temp[s].PROC_INST_ID+'" aria-controls="business_'+e.data[o].temp[s].PROC_INST_ID+'" role="tab" data-toggle="tab">'+e.data[o].temp[s].NAME_+"</a></li>";n+='</ui><div class="tab-content">';for(var s=0;s<e.data[o].temp.length;s++)n+=0==s?'<div class="tab-pane active" id="business_'+e.data[o].temp[s].PROC_INST_ID+'">'+t+getTables(e.data[o].temp[s].history)+a+"</div>":'<div class="tab-pane" id="business_'+e.data[o].temp[s].PROC_INST_ID+'">'+t+getTables(e.data[o].temp[s].history)+a+"</div>";n+="</div></div>"}$("#h_content").append(n)}})}function showImage(e){$("#z_diagramImg").attr("src",serverPath+"workflowrest/flowchart/"+e+"/"+parseInt(10*Math.random())),$("#z_Modal").modal("show")}function getTables(e){for(var t="",a=0;a<e.length;a++){var n=e[a].startTime;n=getSmpFormatDateByLong(n,!0);var o=e[a].endTime;o=null==o?"":getSmpFormatDateByLong(o,!0);var s=a+1,i=e[a].assigneeName,r=e[a].fromUserName;1==e[a].replace&&(i=i+"（ "+r+"——待办授权）"),t+="<tr><td>"+s+"</td><td>"+e[a].linkName+"</td><td>"+i+"</td><td>"+e[a].orgName+"</td><td>"+e[a].handleType+"</td><td>"+n+"</td><td>"+o+'</td><td style="word-wrap:break-word;word-break:break-all;">'+e[a].userComment+"</td></tr>"}return t}function selectstaff(){var e=$("#wStaffSelectType").val(),t="getassignee",a=$("#processDefinitionKey").val(),n=$("#link").val().toString().split(",")[0],o=$("#link").val().toString().split(",")[3],s=$("#wprov").val();1==o&&(layer.msg("因下一步环节是候选人抢单环节，所以强制切换选人模式为多选！"),e=2),2==e&&(t="getassignees"),jandyStaffSearch(a,n,s,t,e)}function jandyStaffSearch(e,t,a,n,o){var s="/html/workflow/assignee/assgigneeList.html?"+App.timestamp();$("#PandJstaffiframetask").load(s,function(){$("#PandJstaffiframetask").modal("show"),setParam(e,t,a,n,o),$("#PandJstaffiframetask").off("shown.bs.modal").on("shown.bs.modal",function(){App.initDataTables("#searchStaffTable","#searchEforgHome",dataTableConfig),$(".checkall").click(function(){var e=$(this).prop("checked");$(".checkchild").prop("checked",e)})})})}function getassignee(e,t,a,n,o){$("#assignee").val(o),$("#assigneeName").val(n),$("#PandJstaffiframetask").modal("hide")}function getassignees(e,t){$("#assignee").val(e),$("#assigneeName").val(t),$("#PandJstaffiframetask").modal("hide")}function setAssigneeParam(e){$("#wprov").val(e.prov)}function addCustomTab(e){var t=e.title,a=e.url,n=$("li").length,o="addcustom_tab"+(n+1),s="addcustom_div"+(n+1),i='<div role="tabpanel" class="tab-pane fade" id=\''+s+"'></div>",r="<li id='"+o+"' role='presentation'></li>",l="<a href='#"+s+"' aria-controls='"+s+'\' role="tab" data-toggle="tab">'+t+"</a>";$("#history").before(i),$("#"+s).load(a,function(){App.init()}),$("#historyLi").before(r),$("#"+o).append(l)}function setPathSelect(e){$("#pathSelect").val(e)}function checkifdone(){var e=$("#taskId").val(),t=!1;return $.ajax({cache:!0,type:"POST",url:serverPath+"workflowrest/checktask?taskId="+e,async:!1,error:function(){layer.msg("校验待办异常，请联系管理员!",{time:1e3})},success:function(e){var a=e.success;"1"==a?t=!1:(t=!0,layer.msg(e.info))},error:function(e){App.ajaxErrorCallback(e)}}),t}function modal_savefun(){try{"function"==typeof document.getElementById("businessiframe").contentWindow.modal_save?document.getElementById("businessiframe").contentWindow.modal_save():layer.msg("当前环节不需要保存数据！")}catch(e){layer.msg("保存数据异常，请联系管理员！")}}function setStaffSelectType(e){null!=e&&"undefined"!=typeof e&&e.length>0&&$("#wStaffSelectType").val(e)}var parm=App.getPresentParm(),pageType=parm.pageType;$(function(){initData();var e=$("#processDefinitionId").val(),t=$("#processInstanceId").val(),a=$("#taskDefinitionKey").val(),n=$("#taskId").val();loadTaskPath(serverPath,t,n,a,e),loadHistoicFlow(serverPath,t);var o=serverPath+"workflowrest/flowchart/"+t+"/"+parseInt(10*Math.random()),s=new XMLHttpRequest;s.open("get",o,!0),s.responseType="blob",s.onload=function(){if(200==this.status){var e=this.response,t=document.createElement("img");t.onload=function(){window.URL.revokeObjectURL(t.src)},t.src=window.URL.createObjectURL(e),$("#diagramImgdiv").html(t)}},s.send();var i=$("#isCounterSign").val(),r=$("#buttonBack").val(),l=$("#buttonQuick").val(),d=$("#buttonTurn").val(),c=$("#buttonBreak").val();if("true"==$("#isUseReferenceMan").val()?($("#historyDiv").show(),$("#shenpiDiv").removeClass("col-md-12"),$("#shenpiDiv").addClass("col-md-8")):($("#historyDiv").hide(),$("#shenpiDiv").removeClass("col-md-8"),$("#shenpiDiv").addClass("col-md-12")),$("#saveButton").click(function(){modal_savefun()}),"true"==i)$("#passButton").click(function(){addCommentForVote(!0)}),$("#backButton").text("拒绝"),$("#backButton").click(function(){addCommentForVote(!1)}),$("#quickButton").hide(),$("#stopButton").hide(),$("#turnButton").hide();else{"true"==c?$("#stopButton").click(function(){addCommentForStop()}):$("#stopButton").hide(),"true"==d?$("#turnButton").click(function(){addCommentForTurn()}):$("#turnButton").hide(),"true"==r?$("#backButton").click(function(){addComment(!1)}):$("#backButton").hide(),"true"==l?$("#quickButton").click(function(){addCommentForQuick()}):$("#quickButton").hide();var u=$("#canQuickPush").val();$("#passButton").click("true"==u?function(){addCommentForStart()}:function(){addComment(!0)})}$("#userButton").hide(),$("#userQXSPButton").hide(),"3"==pageType&&$("#backTolist").html("关闭")}),subHistoryTitl();